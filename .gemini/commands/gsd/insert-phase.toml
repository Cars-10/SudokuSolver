description = "Insert urgent work as decimal phase (e.g., 72.1) between existing phases"
prompt = "<objective>\nInsert a decimal phase for urgent work discovered mid-milestone that must be completed between existing integer phases.\n\nUses decimal numbering (72.1, 72.2, etc.) to preserve the logical sequence of planned phases while accommodating urgent insertions.\n\nPurpose: Handle urgent work discovered during execution without renumbering entire roadmap.\n</objective>\n\n<execution_context>\n@.planning/ROADMAP.md\n@.planning/STATE.md\n</execution_context>\n\n<process>\n\n<step name=\"parse_arguments\">\nParse the command arguments:\n- First argument: integer phase number to insert after\n- Remaining arguments: phase description\n\nExample: `/gsd:insert-phase 72 Fix critical auth bug`\n→ after = 72\n→ description = \"Fix critical auth bug\"\n\nValidation:\n\n```bash\nif [ $# -lt 2 ]; then\n  echo \"ERROR: Both phase number and description required\"\n  echo \"Usage: /gsd:insert-phase <after> <description>\"\n  echo \"Example: /gsd:insert-phase 72 Fix critical auth bug\"\n  exit 1\nfi\n```\n\nParse first argument as integer:\n\n```bash\nafter_phase=$1\nshift\ndescription=\"$*\"\n\n# Validate after_phase is an integer\nif ! [[ \"$after_phase\" =~ ^[0-9]+$ ]]; then\n  echo \"ERROR: Phase number must be an integer\"\n  exit 1\nfi\n```\n\n</step>\n\n<step name=\"load_roadmap\">\nLoad the roadmap file:\n\n```bash\nif [ -f .planning/ROADMAP.md ]; then\n  ROADMAP=\".planning/ROADMAP.md\"\nelse\n  echo \"ERROR: No roadmap found (.planning/ROADMAP.md)\"\n  exit 1\nfi\n```\n\nRead roadmap content for parsing.\n</step>\n\n<step name=\"verify_target_phase\">\nVerify that the target phase exists in the roadmap:\n\n1. Search for \"### Phase {after_phase}:\" heading\n2. If not found:\n\n   ```\n   ERROR: Phase {after_phase} not found in roadmap\n   Available phases: [list phase numbers]\n   ```\n\n   Exit.\n\n3. Verify phase is in current milestone (not completed/archived)\n   </step>\n\n<step name=\"find_existing_decimals\">\nFind existing decimal phases after the target phase:\n\n1. Search for all \"### Phase {after_phase}.N:\" headings\n2. Extract decimal suffixes (e.g., for Phase 72: find 72.1, 72.2, 72.3)\n3. Find the highest decimal suffix\n4. Calculate next decimal: max + 1\n\nExamples:\n\n- Phase 72 with no decimals → next is 72.1\n- Phase 72 with 72.1 → next is 72.2\n- Phase 72 with 72.1, 72.2 → next is 72.3\n\nStore as: `decimal_phase=\"$(printf \"%02d\" $after_phase).${next_decimal}\"`\n</step>\n\n<step name=\"generate_slug\">\nConvert the phase description to a kebab-case slug:\n\n```bash\nslug=$(echo \"$description\" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')\n```\n\nPhase directory name: `{decimal-phase}-{slug}`\nExample: `06.1-fix-critical-auth-bug` (phase 6 insertion)\n</step>\n\n<step name=\"create_phase_directory\">\nCreate the phase directory structure:\n\n```bash\nphase_dir=\".planning/phases/${decimal_phase}-${slug}\"\nmkdir -p \"$phase_dir\"\n```\n\nConfirm: \"Created directory: $phase_dir\"\n</step>\n\n<step name=\"update_roadmap\">\nInsert the new phase entry into the roadmap:\n\n1. Find insertion point: immediately after Phase {after_phase}'s content (before next phase heading or \"---\")\n2. Insert new phase heading with (INSERTED) marker:\n\n   ```\n   ### Phase {decimal_phase}: {Description} (INSERTED)\n\n   **Goal:** [Urgent work - to be planned]\n   **Depends on:** Phase {after_phase}\n   **Plans:** 0 plans\n\n   Plans:\n   - [ ] TBD (run /gsd:plan-phase {decimal_phase} to break down)\n\n   **Details:**\n   [To be added during planning]\n   ```\n\n3. Write updated roadmap back to file\n\nThe \"(INSERTED)\" marker helps identify decimal phases as urgent insertions.\n\nPreserve all other content exactly (formatting, spacing, other phases).\n</step>\n\n<step name=\"update_project_state\">\nUpdate STATE.md to reflect the inserted phase:\n\n1. Read `.planning/STATE.md`\n2. Under \"## Accumulated Context\" → \"### Roadmap Evolution\" add entry:\n   ```\n   - Phase {decimal_phase} inserted after Phase {after_phase}: {description} (URGENT)\n   ```\n\nIf \"Roadmap Evolution\" section doesn't exist, create it.\n\nAdd note about insertion reason if appropriate.\n</step>\n\n<step name=\"completion\">\nPresent completion summary:\n\n```\nPhase {decimal_phase} inserted after Phase {after_phase}:\n- Description: {description}\n- Directory: .planning/phases/{decimal-phase}-{slug}/\n- Status: Not planned yet\n- Marker: (INSERTED) - indicates urgent work\n\nRoadmap updated: {roadmap-path}\nProject state updated: .planning/STATE.md\n\n---\n\n## ▶ Next Up\n\n**Phase {decimal_phase}: {description}** — urgent insertion\n\n`/gsd:plan-phase {decimal_phase}`\n\n<sub>`/clear` first → fresh context window</sub>\n\n---\n\n**Also available:**\n- Review insertion impact: Check if Phase {next_integer} dependencies still make sense\n- Review roadmap\n\n---\n```\n</step>\n\n</process>\n\n<anti_patterns>\n\n- Don't use this for planned work at end of milestone (use /gsd:add-phase)\n- Don't insert before Phase 1 (decimal 0.1 makes no sense)\n- Don't renumber existing phases\n- Don't modify the target phase content\n- Don't create plans yet (that's /gsd:plan-phase)\n- Don't commit changes (user decides when to commit)\n  </anti_patterns>\n\n<success_criteria>\nPhase insertion is complete when:\n\n- [ ] Phase directory created: `.planning/phases/{N.M}-{slug}/`\n- [ ] Roadmap updated with new phase entry (includes \"(INSERTED)\" marker)\n- [ ] Phase inserted in correct position (after target phase, before next integer phase)\n- [ ] STATE.md updated with roadmap evolution note\n- [ ] Decimal number calculated correctly (based on existing decimals)\n- [ ] User informed of next steps and dependency implications\n      </success_criteria>"
