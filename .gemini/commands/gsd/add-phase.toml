description = "Add phase to end of current milestone in roadmap"
prompt = "<objective>\nAdd a new integer phase to the end of the current milestone in the roadmap.\n\nThis command appends sequential phases to the current milestone's phase list, automatically calculating the next phase number based on existing phases.\n\nPurpose: Add planned work discovered during execution that belongs at the end of current milestone.\n</objective>\n\n<execution_context>\n@.planning/ROADMAP.md\n@.planning/STATE.md\n</execution_context>\n\n<process>\n\n<step name=\"parse_arguments\">\nParse the command arguments:\n- All arguments become the phase description\n- Example: `/gsd:add-phase Add authentication` → description = \"Add authentication\"\n- Example: `/gsd:add-phase Fix critical performance issues` → description = \"Fix critical performance issues\"\n\nIf no arguments provided:\n\n```\nERROR: Phase description required\nUsage: /gsd:add-phase <description>\nExample: /gsd:add-phase Add authentication system\n```\n\nExit.\n</step>\n\n<step name=\"load_roadmap\">\nLoad the roadmap file:\n\n```bash\nif [ -f .planning/ROADMAP.md ]; then\n  ROADMAP=\".planning/ROADMAP.md\"\nelse\n  echo \"ERROR: No roadmap found (.planning/ROADMAP.md)\"\n  exit 1\nfi\n```\n\nRead roadmap content for parsing.\n</step>\n\n<step name=\"find_current_milestone\">\nParse the roadmap to find the current milestone section:\n\n1. Locate the \"## Current Milestone:\" heading\n2. Extract milestone name and version\n3. Identify all phases under this milestone (before next \"---\" separator or next milestone heading)\n4. Parse existing phase numbers (including decimals if present)\n\nExample structure:\n\n```\n## Current Milestone: v1.0 Foundation\n\n### Phase 4: Focused Command System\n### Phase 5: Path Routing & Validation\n### Phase 6: Documentation & Distribution\n```\n\n</step>\n\n<step name=\"calculate_next_phase\">\nFind the highest integer phase number in the current milestone:\n\n1. Extract all phase numbers from phase headings (### Phase N:)\n2. Filter to integer phases only (ignore decimals like 4.1, 4.2)\n3. Find the maximum integer value\n4. Add 1 to get the next phase number\n\nExample: If phases are 4, 5, 5.1, 6 → next is 7\n\nFormat as two-digit: `printf \"%02d\" $next_phase`\n</step>\n\n<step name=\"generate_slug\">\nConvert the phase description to a kebab-case slug:\n\n```bash\n# Example transformation:\n# \"Add authentication\" → \"add-authentication\"\n# \"Fix critical performance issues\" → \"fix-critical-performance-issues\"\n\nslug=$(echo \"$description\" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')\n```\n\nPhase directory name: `{two-digit-phase}-{slug}`\nExample: `07-add-authentication`\n</step>\n\n<step name=\"create_phase_directory\">\nCreate the phase directory structure:\n\n```bash\nphase_dir=\".planning/phases/${phase_num}-${slug}\"\nmkdir -p \"$phase_dir\"\n```\n\nConfirm: \"Created directory: $phase_dir\"\n</step>\n\n<step name=\"update_roadmap\">\nAdd the new phase entry to the roadmap:\n\n1. Find the insertion point (after last phase in current milestone, before \"---\" separator)\n2. Insert new phase heading:\n\n   ```\n   ### Phase {N}: {Description}\n\n   **Goal:** [To be planned]\n   **Depends on:** Phase {N-1}\n   **Plans:** 0 plans\n\n   Plans:\n   - [ ] TBD (run /gsd:plan-phase {N} to break down)\n\n   **Details:**\n   [To be added during planning]\n   ```\n\n3. Write updated roadmap back to file\n\nPreserve all other content exactly (formatting, spacing, other phases).\n</step>\n\n<step name=\"update_project_state\">\nUpdate STATE.md to reflect the new phase:\n\n1. Read `.planning/STATE.md`\n2. Under \"## Current Position\" → \"**Next Phase:**\" add reference to new phase\n3. Under \"## Accumulated Context\" → \"### Roadmap Evolution\" add entry:\n   ```\n   - Phase {N} added: {description}\n   ```\n\nIf \"Roadmap Evolution\" section doesn't exist, create it.\n</step>\n\n<step name=\"completion\">\nPresent completion summary:\n\n```\nPhase {N} added to current milestone:\n- Description: {description}\n- Directory: .planning/phases/{phase-num}-{slug}/\n- Status: Not planned yet\n\nRoadmap updated: {roadmap-path}\nProject state updated: .planning/STATE.md\n\n---\n\n## ▶ Next Up\n\n**Phase {N}: {description}**\n\n`/gsd:plan-phase {N}`\n\n<sub>`/clear` first → fresh context window</sub>\n\n---\n\n**Also available:**\n- `/gsd:add-phase <description>` — add another phase\n- Review roadmap\n\n---\n```\n</step>\n\n</process>\n\n<anti_patterns>\n\n- Don't modify phases outside current milestone\n- Don't renumber existing phases\n- Don't use decimal numbering (that's /gsd:insert-phase)\n- Don't create plans yet (that's /gsd:plan-phase)\n- Don't commit changes (user decides when to commit)\n  </anti_patterns>\n\n<success_criteria>\nPhase addition is complete when:\n\n- [ ] Phase directory created: `.planning/phases/{NN}-{slug}/`\n- [ ] Roadmap updated with new phase entry\n- [ ] STATE.md updated with roadmap evolution note\n- [ ] New phase appears at end of current milestone\n- [ ] Next phase number calculated correctly (ignoring decimals)\n- [ ] User informed of next steps\n      </success_criteria>"
