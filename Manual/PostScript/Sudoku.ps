%!PS
% Sudoku Solver in PostScript

/board 81 array def
/iterations 0 def

/read-file {
    /f InputFile (r) file def
    /idx 0 def
    {
        f read not { exit } if
        /char exch def
        char 48 ge char 57 le and {
            board idx char 48 sub put
            /idx idx 1 add def
        } if
    } loop
    f closefile
} def

/print-board {
    0 1 8 {
        /r exch def
        0 1 8 {
            /c exch def
            board r 9 mul c add get
            ( ) cvs print
            c 8 lt { ( ) print } if
        } for
        (\n) print
    } for
} def

/get-cell { % r c -> val
    exch 9 mul add board exch get
} def

/set-cell { % val r c ->
    exch 9 mul add board exch 3 -1 roll put
} def

/check-row { % r num -> bool
    /num exch def
    /r exch def
    true
    0 1 8 {
        /c exch def
        r c get-cell num eq {
            pop false exit
        } if
    } for
} def

/check-col { % c num -> bool
    /num exch def
    /c exch def
    true
    0 1 8 {
        /r exch def
        r c get-cell num eq {
            pop false exit
        } if
    } for
} def

/check-box { % r c num -> bool
    /num exch def
    /c exch def
    /r exch def
    /sr r 3 idiv 3 mul def
    /sc c 3 idiv 3 mul def
    true
    0 1 2 {
        /i exch def
        0 1 2 {
            /j exch def
            sr i add sc j add get-cell num eq {
                pop false exit
            } if
        } for
        dup not { exit } if
    } for
} def

/is-valid { % r c num -> bool
    3 copy check-box {
        3 copy check-col {
            check-row
        } { pop pop pop false } ifelse
    } { pop pop pop false } ifelse
} def

/find-empty { % -> r c true | false
    /found false def
    0 1 8 {
        /r exch def
        0 1 8 {
            /c exch def
            r c get-cell 0 eq {
                r c true
                /found true def
                exit
            } if
        } for
        found { exit } if
    } for
    found not { false } if
} def

/solve { % -> bool
    find-empty not { true exit } if
    /c exch def
    /r exch def
    
    /solved false def
    1 1 9 {
        /num exch def
        r c num is-valid {
            num r c set-cell
            /iterations iterations 1 add def
            
            solve {
                /solved true def
                exit
            } if
            
            0 r c set-cell % backtrack
        } if
    } for
    solved
} def

% Main
read-file
solve {
    (Solved in Iterations= ) print iterations (      ) cvs print (\n) print
    print-board
} {
    (No solution found.\n) print
} ifelse
quit
