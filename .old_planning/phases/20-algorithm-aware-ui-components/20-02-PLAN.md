---
phase: 20-algorithm-aware-ui-components
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [Metrics/report_client.js]
autonomous: true
---

<objective>
Add algorithm awareness to scoring modal (radar chart and matrix results table) for accurate performance analysis.

Purpose: Ensure the scoring modal displays metrics for the currently selected algorithm, not mixed data. When viewing DLX results, clicking a score should show DLX metrics and compare against C/DLX baseline.
Output: Algorithm-aware scoring modal that correctly filters metrics and uses algorithm-specific C baselines for comparisons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-language-metadata-and-display-fixes/19-01-SUMMARY.md
@.planning/codebase/CONVENTIONS.md

**Current problem:**
- openScoreModal (line 4620) finds metrics using only language name: `metricsData.find(m => m.solver === lang)`
- This returns the FIRST match, which may be BruteForce even when viewing DLX/CP results
- drawScoreRadarChart (line 4703) doesn't know which algorithm it's displaying
- populateMatrixResults (line 4834) always compares to C baseline, regardless of algorithm

**Correct behavior:**
- When user has DLX selected and clicks a DLX language score, modal should:
  1. Find metrics for that language WITH algorithmType='DLX'
  2. Compare against C/DLX baseline (not C/BruteForce)
  3. Show "Dancing Links" in modal subtitle or header
  4. Display DLX iteration counts in matrix results table

**Algorithm-specific C baselines (from phase 5):**
- BruteForce: C with algorithmType='BruteForce' (656 iterations, Matrix 1)
- DLX: C with algorithmType='DLX' (43 iterations, Matrix 1)
- CP: C with algorithmType='CP' (67 iterations, Matrix 1)

@Metrics/report_client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update openScoreModal to filter by current algorithm</name>
  <files>Metrics/report_client.js</files>
  <action>
Modify openScoreModal() function (line 4620) to be algorithm-aware:

1. After line 4634, replace the metrics finding logic:

   OLD (line 4635-4636):
   ```javascript
   const langMetrics = metricsData.find(m => m.solver === lang);
   const cMetrics = metricsData.find(m => m.solver === 'C');
   ```

   NEW:
   ```javascript
   // Get current algorithm filter
   const selectedAlgo = window.currentAlgorithm || 'BruteForce';

   // Find metrics for this language with matching algorithm type
   const langMetrics = metricsData.find(m => {
       const matchesName = m.solver === lang;
       const algoType = m.algorithmType || 'BruteForce';

       // In "all" mode, find the algorithm type from the clicked row
       if (selectedAlgo === 'all') {
           const clickedRow = document.querySelector(`tr[data-lang="${lang}"]`);
           const rowAlgo = clickedRow?.getAttribute('data-algorithm-type') || 'BruteForce';
           return matchesName && algoType === rowAlgo;
       }

       return matchesName && algoType === selectedAlgo;
   });

   // Find C baseline matching the same algorithm type
   const langAlgoType = langMetrics?.algorithmType || 'BruteForce';
   const cMetrics = metricsData.find(m => {
       return m.solver === 'C' && (m.algorithmType || 'BruteForce') === langAlgoType;
   });
   ```

2. After line 4664, add algorithm label to subtitle:

   Find the line: `subtitle.textContent = 'Performance Score Analysis';`

   Replace with:
   ```javascript
   const algoLabel = {
       'BruteForce': 'Brute Force',
       'DLX': 'Dancing Links',
       'CP': 'Constraint Propagation'
   }[langAlgoType] || 'Brute Force';
   subtitle.textContent = `Performance Score Analysis - ${algoLabel}`;
   ```

3. Pass algorithm context to drawScoreRadarChart (line 4686):

   OLD:
   ```javascript
   drawScoreRadarChart(lang, tier, tierColor, breakdownParts);
   ```

   NEW:
   ```javascript
   drawScoreRadarChart(lang, tier, tierColor, breakdownParts, langAlgoType);
   ```

Do NOT modify the radar chart drawing logic in this task - that's Task 2. Do NOT modify modal styling or tier badge logic.
  </action>
  <verify>
1. Grep for algorithm filtering in openScoreModal: grep -A 20 "window.openScoreModal = function" Metrics/report_client.js | grep "selectedAlgo\|langAlgoType"
2. Verify C baseline filtering: grep -A 5 "cMetrics.*find" Metrics/report_client.js | grep "algorithmType"
3. Check radar chart call signature: grep "drawScoreRadarChart.*langAlgoType" Metrics/report_client.js
4. npx tsc --noEmit (passes)
  </verify>
  <done>
- openScoreModal finds language metrics matching current algorithm
- C baseline matches the language's algorithm type
- Modal subtitle shows algorithm name
- Algorithm type passed to drawScoreRadarChart
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update drawScoreRadarChart to accept algorithm context</name>
  <files>Metrics/report_client.js</files>
  <action>
Modify drawScoreRadarChart() function (line 4703) to accept and display algorithm context:

1. Update function signature (line 4703):

   OLD:
   ```javascript
   function drawScoreRadarChart(lang, tier, tierColor, breakdownParts) {
   ```

   NEW:
   ```javascript
   function drawScoreRadarChart(lang, tier, tierColor, breakdownParts, algorithmType = 'BruteForce') {
   ```

2. Optional: Add algorithm label to chart if there's a title/label element
   - If there's a text label showing "Performance Breakdown" or similar, append algorithm name
   - If no obvious place, skip this sub-step (the modal subtitle already shows it)

3. Find other calls to drawScoreRadarChart and update them:

   Search for: `drawScoreRadarChart(`

   Expected matches:
   - Line ~4686: Already updated in Task 1 ✓
   - Line ~5043: Inside variant selector handler - needs update:

     Find the call around line 5043, it likely looks like:
     ```javascript
     drawScoreRadarChart(currentScoreModalLang, tier, tierColor, breakdownParts);
     ```

     Update to:
     ```javascript
     const langAlgoType = variantMetrics?.algorithmType || 'BruteForce';
     drawScoreRadarChart(currentScoreModalLang, tier, tierColor, breakdownParts, langAlgoType);
     ```

Do NOT change the radar chart's visual appearance (grid, axes, colors). Do NOT modify the canvas drawing logic beyond adding optional label.
  </action>
  <verify>
1. Function signature check: grep -n "^function drawScoreRadarChart" Metrics/report_client.js
2. All calls include algorithmType: grep -n "drawScoreRadarChart(" Metrics/report_client.js
3. npx tsc --noEmit (passes)
4. Count calls (should be 2): grep -c "drawScoreRadarChart(" Metrics/report_client.js
  </verify>
  <done>
- drawScoreRadarChart accepts algorithmType parameter with default 'BruteForce'
- All calls to drawScoreRadarChart pass algorithmType
- Variant selector handler updated
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Update populateMatrixResults to use algorithm-specific C baseline</name>
  <files>Metrics/report_client.js</files>
  <action>
Modify populateMatrixResults() function (line 4834) to use algorithm-specific C baseline:

1. Update function signature (line 4834):

   OLD:
   ```javascript
   function populateMatrixResults(lang, langMetrics, cMetrics) {
   ```

   KEEP as is (function already receives correct cMetrics from Task 1)

2. Verify the function is using the cMetrics parameter correctly:
   - Line 4840: `const cResults = cMetrics?.results || [];` ✓ Already correct
   - The function should already be comparing against cMetrics passed from openScoreModal
   - No changes needed IF Task 1 correctly passes algorithm-specific cMetrics

3. Find ALL calls to populateMatrixResults and verify they pass algorithm-aware cMetrics:

   Expected calls:
   - Line ~4695: `populateMatrixResults(lang, langMetrics, cMetrics);` ✓ Uses cMetrics from Task 1
   - Line ~5050: `populateMatrixResults(currentScoreModalLang, variantMetrics, cMetrics);` ✓ Uses existing cMetrics

   If the line 5050 call doesn't update cMetrics when variant changes, fix it:

   Find the variant selector handler (around line 5000-5050), look for where variantMetrics is loaded.

   After `const variantMetrics = ...`, add:
   ```javascript
   // Update C baseline to match variant's algorithm
   const variantAlgoType = variantMetrics?.algorithmType || 'BruteForce';
   const cMetrics = metricsData.find(m => {
       return m.solver === 'C' && (m.algorithmType || 'BruteForce') === variantAlgoType;
   });
   ```

Do NOT modify the table rendering logic. Do NOT change how ratios are calculated (they should automatically use the correct C baseline).
  </action>
  <verify>
1. Grep for populateMatrixResults calls: grep -n "populateMatrixResults(" Metrics/report_client.js
2. Check variant handler updates cMetrics: grep -B 10 -A 2 "populateMatrixResults.*variant" Metrics/report_client.js | grep "cMetrics.*find\|variantAlgoType"
3. npx tsc --noEmit (passes)
4. cd Metrics && npx ts-node generate_report_only.ts (succeeds)
  </verify>
  <done>
- populateMatrixResults receives algorithm-specific C baseline
- Variant selector updates C baseline when switching variants
- Ratios compare language against correct algorithm's C baseline
- No TypeScript errors
- Report generates successfully
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npx tsc --noEmit passes
- [ ] cd Metrics && npx ts-node generate_report_only.ts succeeds
- [ ] openScoreModal filters by algorithm: grep -c "selectedAlgo.*currentAlgorithm" Metrics/report_client.js shows 3+ (was 2, added 1+)
- [ ] drawScoreRadarChart signature has 5 parameters: grep "function drawScoreRadarChart.*algorithmType" Metrics/report_client.js
- [ ] All drawScoreRadarChart calls pass algorithmType: 2 calls found with algorithm parameter
- [ ] populateMatrixResults uses algorithm-specific baseline in both call sites
- [ ] Modal subtitle shows algorithm label: grep "algoLabel.*subtitle" Metrics/report_client.js
</verification>

<success_criteria>

- All tasks completed
- Scoring modal filters language metrics by current algorithm
- Modal compares against algorithm-specific C baseline (DLX→C/DLX, CP→C/CP, BF→C/BF)
- Modal subtitle shows algorithm name
- drawScoreRadarChart accepts and uses algorithmType parameter
- Matrix results table uses correct C baseline for ratios
- Variant selector updates C baseline when switching
- TypeScript compilation passes
- Report generation succeeds
- No regressions in modal functionality
</success_criteria>

<output>
After completion, create `.planning/phases/20-algorithm-aware-ui-components/20-02-SUMMARY.md`
</output>
