<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>System Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #0d0d12;
            color: #e0e0e0;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 40px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 40px;
            animation: fadeIn 1s ease-out;
        }

        .logo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #00ff9d;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.4);
        }

        h1 {
            color: #00ff9d;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin: 0;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(0, 255, 157, 0.3);
        }

        .diagram-container {
            width: 100%;
            max-width: 1400px;
            aspect-ratio: 1 / 1;
            min-height: 600px;
            background: #16161e;
            padding: 40px;
            border-radius: 16px;
            border: 1px solid #2a2a35;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            animation: slideUp 1s ease-out;
            overflow: auto;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Default Logo - Top Left */
        .logo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #00ff9d;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.4);
            z-index: 10;
        }

        /* Fullscreen Mode Overrides */
        body.fullscreen-mode {
            padding: 0 !important;
            overflow: hidden;
            /* Let zoom handle it */
            justify-content: center;
        }

        body.fullscreen-mode .diagram-container {
            width: 100% !important;
            max-width: none !important;
            height: 100vh !important;
            border: none;
            border-radius: 0;
            padding: 0;
            background: transparent;
            /* Let watermark show */
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.fullscreen-mode svg {
            width: 100% !important;
            height: 100% !important;
            max-width: none !important;
        }

        /* Watermark Background */
        .watermark-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 800vw;
            height: 800vh;
            transform: none;
            opacity: 0;
            /* Hidden by default */
            transition: opacity 0.5s ease;
            pointer-events: none;
            z-index: 0;
        }

        body.fullscreen-mode .watermark-container {
            opacity: 0.15;
            /* Visible background */
        }

        .watermark-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Cover the screen */
            filter: grayscale(100%) brightness(0.8);
        }

        /* Stylish mono look */


        /* Mermaid Overrides */
        .node rect,
        .node circle,
        .node ellipse,
        .node polygon,
        .node path {
            fill: #1a1a2a !important;
            stroke: #00b8ff !important;
            stroke-width: 2px !important;
        }

        .node .label {
            color: #e0e0e0 !important;
            font-family: 'JetBrains Mono', monospace !important;
        }

        .edgePath .path {
            stroke: #5c5c66 !important;
            stroke-width: 2px !important;
        }

        .cluster rect {
            fill: rgba(255, 255, 255, 0.02) !important;
            stroke: #2a2a35 !important;
        }

        .cluster .label {
            color: #00ff9d !important;
        }
    </style>
</head>

<body>
    <div class="header">
        <img src="architecture_logo.png" alt="System Logo" class="logo">
        <h1>System Architecture</h1>
    </div>

    <div class="diagram-container">
        <div class="mermaid">
            graph TB
            %% Definitions
            subgraph Frontend["üñ•Ô∏è Frontend (Browser)"]
            direction TB
            HTML["index.html<br>(Generated Report)"]

            subgraph Scripts["Client Logic (report_client.js)"]
            UI_Logic["UI Controller<br>(Search, Sort, Filter)"]
            Chart_Logic["D3.js Visualizer<br>(Line, Race, Jockey Charts)"]
            API_Client["API Connector<br>(fetch)"]
            Modal_Handler["Modal Manager<br>(Edit/Lock/Upload)"]
            end

            HTML --> UI_Logic
            UI_Logic --> Chart_Logic
            UI_Logic --> Modal_Handler
            Modal_Handler --> API_Client
            Chart_Logic --> API_Client
            end

            subgraph Backend["‚öôÔ∏è Backend (Node.js :3000)"]
            direction TB
            Server["Express Server<br>(server/index.js)"]

            subgraph Endpoints["API Endpoints"]
            EP_Meta["GET/POST /api/metadata"]
            EP_Lock["POST /api/lock"]
            EP_Run["POST /api/run"]
            EP_Upload["POST /api/upload-media"]
            EP_Static["GET Static Assets"]
            end

            subgraph Execution["Executor Engine"]
            Detect["Docker vs Local Detection"]
            Runner_Docker["Docker Runner<br>(docker run ...)"]
            Runner_Local["Shell Runner<br>(/bin/bash runMeGlobal.sh)"]
            end

            Server --> Endpoints
            EP_Run --> Detect
            Detect -- "If Dockerfile exists" --> Runner_Docker
            Detect -- "Else" --> Runner_Local
            end

            subgraph Storage["üìÅ File System ()"]
            subgraph Data["Data & Config"]
            MetaFiles["metadata.json"]
            Media["Media/ (Images)"]
            Logs["Logs/ & Metrics"]
            end

            subgraph Solvers["Language Solvers"]
            Code["Source Code"]
            Scripts_SH["setupAndRunMe.sh"]
            Dockerfiles["Dockerfiles"]
            end
            end

            %% Interactions
            API_Client -- "JSON Data" --> EP_Meta
            API_Client -- "Command" --> EP_Run
            API_Client -- "File Upload" --> EP_Upload

            EP_Static -.-> HTML
            EP_Static -.-> Media

            EP_Meta --> MetaFiles
            EP_Lock --> MetaFiles
            EP_Upload --> Media

            Runner_Docker --> Dockerfiles
            Runner_Local --> Scripts_SH
            Runner_Local --> Code

            %% Styling
            classDef plain fill:#ffffff,stroke:#333,stroke-width:1px,color:#000;
            classDef front fill:#00d9f9,stroke:#000,stroke-width:2px,color:#000;
            classDef back fill:#00ff9d,stroke:#000,stroke-width:2px,color:#000;
            classDef file fill:#ffcc00,stroke:#000,stroke-width:2px,color:#000;

            class HTML,UI_Logic,Chart_Logic,API_Client,Modal_Handler front;
            class Server,EP_Meta,EP_Lock,EP_Run,EP_Upload,EP_Static,Detect,Runner_Docker,Runner_Local back;
            class MetaFiles,Media,Logs,Code,Scripts_SH,Dockerfiles,Data,Solvers file;
        </div>
    </div>

    <!-- Watermark Background -->
    <div class="watermark-container">
        <!-- Using uploaded system architecture image -->
        <img src="assets/system_bg.png" class="watermark-img" alt="System Watermark"
            onerror="this.src='../favicon.png'">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base', // Use base to allow overrides better
            securityLevel: 'loose',
            fontFamily: 'JetBrains Mono',
            themeVariables: {
                darkMode: true,
                background: '#16161e',
                primaryColor: '#ffffff',
                primaryTextColor: '#000000',
                primaryBorderColor: '#000000',
                lineColor: '#5c5c66'
            }
        });

        // Tooltip Data
        const nodeDescriptions = {
            "HTML": { title: "Static HTML", desc: "The final generated report file containing all visualization logic and data." },
            "UI_Logic": { title: "Report Client", desc: "Client-side JavaScript (report_client.js) handling sorting, filtering, and persona logic." },
            "Chart_Logic": { title: "Visualization Engine", desc: "D3.js and Mermaid.js libraries responsible for rendering the charts and diagrams." },
            "API_Client": { title: "API Client", desc: "Handles communication with the backend for running benchmarks and saving metadata." },
            "Server": { title: "Node.js Server", desc: "Express server (server/index.js) running on port 3000. Handles file I/O and command execution." },
            "EP_Run": { title: "Run Endpoint", desc: "POST /api/run-benchmark. Triggers the execution of the benchmark script." },
            "EP_Meta": { title: "Metadata Endpoint", desc: "POST /api/save-metadata. Persists changes to language descriptions and personalities." },
            "EP_Upload": { title: "Upload Endpoint", desc: "POST /api/upload-media. Handles image uploads for language logos." },
            "Detect": { title: "Environment Detection", desc: "Logic to determine if the benchmark should run in Docker or locally." },
            "Runner_Docker": { title: "Docker Runner", desc: "Executes the 'runMe' script inside an isolated container for security and consistency." },
            "Runner_Local": { title: "Local Runner", desc: "Executes the benchmark script directly on the host machine using /bin/bash." },
            "MetaFiles": { title: "Metadata Storage", desc: "JSON files (metadata.json) storing persistent configuration and descriptions." },
            "Media": { title: "Media Storage", desc: "Directory storing uploaded images and screenshots." },
            "Logs": { title: "Logs & Metrics", desc: "Stores execution logs and raw metric data." },
            "Code": { title: "Source Code", desc: "The actual implementation files for each language solver." },
            "Dockerfiles": { title: "Docker Configuration", desc: "Definitions for the build environment of each language." }
        };

        // Initialize Zoom and Tooltips after Mermaid renders
        window.addEventListener('load', function () {
            // Create Tooltip Element
            const tooltip = document.createElement('div');
            tooltip.style.position = 'fixed'; // Changed to fixed to handle scrolling correctly
            tooltip.style.display = 'none';
            tooltip.style.background = 'rgba(0, 0, 0, 0.9)';
            tooltip.style.border = '1px solid #00ff9d';
            tooltip.style.padding = '10px';
            tooltip.style.borderRadius = '4px';
            tooltip.style.boxShadow = '0 0 10px rgba(0, 255, 157, 0.3)';
            tooltip.style.color = '#fff';
            tooltip.style.maxWidth = '300px';
            tooltip.style.pointerEvents = 'none'; // pass through
            tooltip.style.zIndex = '1000';
            document.body.appendChild(tooltip);

            const checkSvg = setInterval(() => {
                const svg = document.querySelector('.mermaid svg');
                if (svg) {
                    clearInterval(checkSvg);
                    // Ensure SVG fills container for zooming
                    svg.style.width = '100%';
                    svg.style.height = '100%';
                    svg.style.maxWidth = 'none';

                    // Attach Tooltips
                    Object.keys(nodeDescriptions).forEach(id => {
                        // Mermaid nodes often have IDs like "nodeId" or "flowchart-nodeId-..."
                        // We search by generic ID selector or matching content if ID is mangled.
                        // Usually mermaid adds id="{id}" to the g element.
                        const node = svg.querySelector(`g[id^="${id}"]`) || svg.querySelector(`#${id}`);
                        if (node) {
                            node.style.cursor = 'help';
                            node.addEventListener('mouseenter', (e) => {
                                const data = nodeDescriptions[id];
                                tooltip.innerHTML = `<strong style="color:#00ff9d; display:block; margin-bottom:4px;">${data.title}</strong>${data.desc}`;
                                tooltip.style.left = (e.clientX + 15) + 'px';
                                tooltip.style.top = (e.clientY + 15) + 'px';
                                tooltip.style.display = 'block';
                            });
                            node.addEventListener('mousemove', (e) => {
                                // e.clientX is relative to iframe window
                                tooltip.style.left = (e.clientX + 15) + 'px';
                                tooltip.style.top = (e.clientY + 15) + 'px';
                            });
                            node.addEventListener('mouseleave', () => {
                                tooltip.style.display = 'none';
                            });
                        }
                    });

                    window.zoomInstance = svgPanZoom(svg, {
                        zoomEnabled: true,
                        controlIconsEnabled: true,
                        fit: true,
                        center: true,
                        minZoom: 0.1,
                        maxZoom: 10
                    });
                }
            }, 100);
        });
    </script>
</body>

</html>