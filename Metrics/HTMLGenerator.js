"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g = Object.create((typeof Iterator === "function" ? Iterator : Object).prototype);
    return g.next = verb(0), g["throw"] = verb(1), g["return"] = verb(2), typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.scoreLabels = exports.memoryLabels = exports.timeLabels = exports.iterationLabels = exports.mismatchLabels = exports.narratorIntros = exports.languageMetadata = exports.methodologyTexts = exports.personalities = exports.quotes = exports.languageHistories = void 0;
exports.generateHtml = generateHtml;
exports.generateHistoryHtml = generateHistoryHtml;
var fs = __importStar(require("fs/promises"));
var path = __importStar(require("path"));
var glob_1 = require("glob");
var url_1 = require("url");
var LanguagesMetadata_ts_1 = require("./LanguagesMetadata.ts");
Object.defineProperty(exports, "languageHistories", { enumerable: true, get: function () { return LanguagesMetadata_ts_1.languageHistories; } });
Object.defineProperty(exports, "quotes", { enumerable: true, get: function () { return LanguagesMetadata_ts_1.quotes; } });
Object.defineProperty(exports, "personalities", { enumerable: true, get: function () { return LanguagesMetadata_ts_1.personalities; } });
Object.defineProperty(exports, "methodologyTexts", { enumerable: true, get: function () { return LanguagesMetadata_ts_1.methodologyTexts; } });
Object.defineProperty(exports, "languageMetadata", { enumerable: true, get: function () { return LanguagesMetadata_ts_1.languageMetadata; } });
Object.defineProperty(exports, "narratorIntros", { enumerable: true, get: function () { return LanguagesMetadata_ts_1.narratorIntros; } });
Object.defineProperty(exports, "mismatchLabels", { enumerable: true, get: function () { return LanguagesMetadata_ts_1.mismatchLabels; } });
Object.defineProperty(exports, "iterationLabels", { enumerable: true, get: function () { return LanguagesMetadata_ts_1.iterationLabels; } });
Object.defineProperty(exports, "timeLabels", { enumerable: true, get: function () { return LanguagesMetadata_ts_1.timeLabels; } });
Object.defineProperty(exports, "memoryLabels", { enumerable: true, get: function () { return LanguagesMetadata_ts_1.memoryLabels; } });
Object.defineProperty(exports, "scoreLabels", { enumerable: true, get: function () { return LanguagesMetadata_ts_1.scoreLabels; } });
var __filename = (0, url_1.fileURLToPath)(import.meta.url);
var __dirname = path.dirname(__filename);
// --- Logic ---
// Helper to safely serialize data for injection into template literals
// We ONLY need to escape </script> to prevent breaking out of the script tag.
// JSON.stringify handles quotes and backslashes correctly for the JS parser.
function safeJSON(obj) {
    return JSON.stringify(obj)
        .replace(/<\/script>/g, '<\\/script>')
        .replace(/\u2028/g, '\\u2028') // Line separator
        .replace(/\u2029/g, '\\u2029'); // Paragraph separator
}
// Compiler fallback mapping for languages
var compilerMapping = {
    'C': 'gcc',
    'C++': 'g++',
    'Rust': 'rustc',
    'Go': 'go',
    'Python': 'python3',
    'JavaScript': 'node',
    'TypeScript': 'tsc/node',
    'Java': 'javac',
    'C_Sharp': 'dotnet',
    'PHP': 'php',
    'Ruby': 'ruby',
    'Perl': 'perl',
    'Swift': 'swiftc',
    'Kotlin': 'kotlinc',
    'Scala': 'scalac',
    'Haskell': 'ghc',
    'OCaml': 'ocamlopt',
    'F_Sharp': 'dotnet',
    'Lua': 'lua',
    'Julia': 'julia',
    'Fortran': 'gfortran',
    'Pascal': 'fpc',
    'Ada': 'gnat',
    'D': 'dmd',
    'Nim': 'nim',
    'Crystal': 'crystal',
    'Zig': 'zig',
    'V': 'v',
    'Dart': 'dart',
    'Elixir': 'elixir',
    'Erlang': 'erlc',
    'Clojure': 'clj',
    'Groovy': 'groovy',
    'Bash': 'bash',
    'Awk': 'awk',
    'Sed': 'sed',
    'Assembly': 'nasm',
    'Cobol': 'cobc',
    'Prolog': 'swipl',
};
function generateHtml(metrics_1, history_1, personalities_1, languageMetadata_1, methodologyTexts_1, referenceOutputs_1) {
    return __awaiter(this, arguments, void 0, function (metrics, history, personalities, languageMetadata, methodologyTexts, referenceOutputs, allowedMatrices, benchmarkConfig, metadataOverrides) {
        var finalLanguageMetadata, finalPersonalities, finalNarratorIntros, localLogos, logoMap, _i, localLogos_1, p, filename, name_1, tailoringConfig, rootDir, tailoringPath, tailoringContent, e_1, matricesDir, matrixFiles, matrixContents, _a, matrixFiles_1, file, content, maxMatrices, sortedMetrics, cMetrics, cTimes, cTotalIters, cTotalTime, cTotalMem, cTotalCpu, mismatchCount, cMap_1, metricsJson, historyJson, personalitiesJson, metadataJson, methodologiesJson, totalPlanned, html, i, _loop_1, _b, sortedMetrics_1, m, generatedAt;
        var _c, _d;
        if (allowedMatrices === void 0) { allowedMatrices = []; }
        if (benchmarkConfig === void 0) { benchmarkConfig = {}; }
        if (metadataOverrides === void 0) { metadataOverrides = {}; }
        return __generator(this, function (_e) {
            switch (_e.label) {
                case 0:
                    finalLanguageMetadata = __assign(__assign({}, languageMetadata), (metadataOverrides.languageMetadata || {}));
                    finalPersonalities = __assign(__assign({}, personalities), (metadataOverrides.personalities || {}));
                    finalNarratorIntros = __assign(__assign({}, LanguagesMetadata_ts_1.narratorIntros), (metadataOverrides.narratorIntros || {}));
                    // Update local variables to use these finals
                    // Since we passed in languageMetadata as arg, we might need to shadow it or use a new name.
                    // Ideally we'd rename the arg, but that might break other callers?
                    // Actually, we can just reassign the args if they were objects but here they are used in the template.
                    // Let's use the 'final' variables in the template construction.
                    // Note: I will need to ensure the rest of the function (which is huge) uses these new variables.
                    // I can't easily replace all usages in one go without replacing the whole file.
                    // BUT! I can just reassign the arguments!
                    languageMetadata = finalLanguageMetadata;
                    personalities = finalPersonalities;
                    // narratorIntros depends on if it was passed in?
                    // Wait, the signature does NOT include narratorIntros!
                    // Line 28: metrics, history, personalities, languageMetadata, methodologyTexts, referenceOutputs, allowedMatrices, benchmarkConfig.
                    // It is missing narratorIntros from arguments?
                    // Then it must be importing it?
                    // If it imports it, I can't overwrite the import binding.
                    // I should check if narratorIntros is imported.
                    console.log("generateHtml received ".concat(metrics.length, " metrics."));
                    return [4 /*yield*/, (0, glob_1.glob)('logos/*.{png,svg}')];
                case 1:
                    localLogos = _e.sent();
                    logoMap = new Map();
                    for (_i = 0, localLogos_1 = localLogos; _i < localLogos_1.length; _i++) {
                        p = localLogos_1[_i];
                        filename = path.basename(p);
                        name_1 = path.basename(p, path.extname(p)).toLowerCase();
                        logoMap.set(name_1, "logos/".concat(filename));
                    }
                    tailoringConfig = {};
                    _e.label = 2;
                case 2:
                    _e.trys.push([2, 4, , 5]);
                    rootDir = path.resolve(__dirname, '..');
                    tailoringPath = path.join(rootDir, 'logos', 'Tailoring.json');
                    return [4 /*yield*/, fs.readFile(tailoringPath, 'utf-8')];
                case 3:
                    tailoringContent = _e.sent();
                    tailoringConfig = JSON.parse(tailoringContent);
                    return [3 /*break*/, 5];
                case 4:
                    e_1 = _e.sent();
                    console.warn("Could not read Tailoring.json", e_1);
                    return [3 /*break*/, 5];
                case 5:
                    matricesDir = path.resolve(__dirname, '../Matrices');
                    return [4 /*yield*/, (0, glob_1.glob)('*.matrix', { cwd: matricesDir })];
                case 6:
                    matrixFiles = _e.sent();
                    // Filter matrices if allowed list is provided
                    if (allowedMatrices && allowedMatrices.length > 0) {
                        console.log("Filtering matrices to: ".concat(allowedMatrices.join(', ')));
                        matrixFiles = matrixFiles.filter(function (f) { return allowedMatrices.includes(f); });
                    }
                    matrixContents = [];
                    _a = 0, matrixFiles_1 = matrixFiles;
                    _e.label = 7;
                case 7:
                    if (!(_a < matrixFiles_1.length)) return [3 /*break*/, 10];
                    file = matrixFiles_1[_a];
                    if (file === '[12].matrix')
                        return [3 /*break*/, 9]; // Skip the combined one if present
                    return [4 /*yield*/, fs.readFile(path.join(matricesDir, file), 'utf-8')];
                case 8:
                    content = _e.sent();
                    matrixContents.push(content);
                    _e.label = 9;
                case 9:
                    _a++;
                    return [3 /*break*/, 7];
                case 10:
                    maxMatrices = 6;
                    sortedMetrics = __spreadArray([], metrics, true).sort(function (a, b) {
                        var timeA = a.results.reduce(function (acc, r) { return acc + r.time; }, 0);
                        var timeB = b.results.reduce(function (acc, r) { return acc + r.time; }, 0);
                        return timeA - timeB;
                    });
                    cMetrics = metrics.find(function (m) { return m.solver === 'C'; });
                    cTimes = cMetrics ? cMetrics.results.map(function (r) { return r.time; }) : [];
                    cTotalIters = cMetrics ? cMetrics.results.reduce(function (a, b) { return a + b.iterations; }, 0) : 0;
                    cTotalTime = cTimes.reduce(function (a, b) { return a + b; }, 0);
                    cTotalMem = cMetrics ? Math.max.apply(Math, cMetrics.results.map(function (r) { return r.memory; })) : 1;
                    cTotalCpu = cMetrics ? cMetrics.results.reduce(function (a, b) { return a + b.cpu_user + b.cpu_sys; }, 0) : 1;
                    mismatchCount = 0;
                    if (cMetrics) {
                        cMap_1 = new Map();
                        cMetrics.results.forEach(function (r) { return cMap_1.set(r.matrix, r.iterations); });
                        mismatchCount = metrics.filter(function (m) {
                            if (m.solver === 'C')
                                return false;
                            // Check each result for this solver
                            for (var _i = 0, _a = m.results; _i < _a.length; _i++) {
                                var r = _a[_i];
                                var expected = cMap_1.get(r.matrix);
                                // Only count as mismatch if we have a baseline and they differ
                                if (expected !== undefined && r.iterations !== expected) {
                                    return true;
                                }
                            }
                            return false;
                        }).length;
                    }
                    metricsJson = safeJSON(sortedMetrics);
                    historyJson = safeJSON(history);
                    personalitiesJson = safeJSON(personalities);
                    metadataJson = safeJSON(languageMetadata);
                    methodologiesJson = safeJSON(methodologyTexts);
                    totalPlanned = languageMetadata ? Object.keys(languageMetadata).length * (Math.min(matrixFiles.length, 6)) : 0;
                    html = "\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <!-- <meta http-equiv=\"refresh\" content=\"60\"> Removed for smart refresh -->\n    <script>\n        (function() {\n            // Smart Refresh for File Protocol\n            // We can't use fetch() on file:// due to CORS.\n            // Instead, we poll by injecting a script tag that loads a timestamp.\n            \n            let initialTimestamp = null;\n            \n            window.checkTimestamp = function() {\n                // This function is called after timestamp.js loads (if we wanted a callback)\n                // But timestamp.js just sets window.latestTimestamp\n                if (typeof window.latestTimestamp !== 'undefined') {\n                    if (initialTimestamp === null) {\n                        initialTimestamp = window.latestTimestamp;\n                    } else if (window.latestTimestamp !== initialTimestamp) {\n                        console.log('File changed, reloading...');\n                        window.location.reload();\n                    }\n                }\n            };\n\n        \n\n    window.handleZoomExtend = function() {\n        const sysView = document.getElementById('system-architecture-view');\n        if (sysView && sysView.style.display !== 'none') {\n            if (window.systemZoomExtends) window.systemZoomExtends();\n        } else {\n            if (window.undoZoom) window.undoZoom();\n        }\n    };\n\n    window.toggleChartLabels = function(value) {\n        const chart = document.getElementById('d3-chart-container');\n        if (value === 'text') {\n            chart.classList.add('show-text-labels');\n        } else {\n            chart.classList.remove('show-text-labels');\n        }\n    };\n\n    window.toggleLogoMode = function(btn) {\n        const chart = document.getElementById('d3-chart-container');\n        const isText = chart.classList.contains('show-text-labels');\n        \n        if (isText) {\n            // Switch to Logos\n            window.toggleChartLabels('logos');\n            // Restore Image Icon\n            btn.innerHTML = `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/><circle cx=\"8.5\" cy=\"8.5\" r=\"1.5\"/><polyline points=\"21 15 16 10 5 21\"/></svg>`;\n        } else {\n            // Switch to Text\n            window.toggleChartLabels('text');\n            // Show Text Icon\n            btn.innerHTML = `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M4 7V4h16v3\"/><path d=\"M9 20h6\"/><path d=\"M12 4v16\"/></svg>`;\n        }\n    };\n\n    window.toggleChartFullscreen = function() {\n        const elem = document.getElementById('chart-wrapper');\n        if (!document.fullscreenElement) {\n            elem.requestFullscreen().then(() => {\n                elem.classList.add('fullscreen-active');\n            }).catch(err => {\n                console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);\n            });\n        } else {\n            document.exitFullscreen().then(() => {\n                elem.classList.remove('fullscreen-active');\n            });\n        }\n    };\n\n    document.addEventListener('fullscreenchange', (event) => {\n        const iframe = document.getElementById('system-iframe');\n        if (iframe && iframe.contentDocument && iframe.contentDocument.body) {\n            if (document.fullscreenElement) {\n                iframe.contentDocument.body.classList.add('fullscreen-mode');\n                 // Trigger resize/fit in iframe\n                if (iframe.contentWindow.zoomInstance) {\n                     setTimeout(() => {\n                         iframe.contentWindow.zoomInstance.resize();\n                         iframe.contentWindow.zoomInstance.fit();\n                         iframe.contentWindow.zoomInstance.center();\n                     }, 100);\n                }\n            } else {\n                iframe.contentDocument.body.classList.remove('fullscreen-mode');\n            }\n        }\n    });\n\n            function poll() {\n                // Polling disabled - timestamp.js doesn't exist, causes 404 console noise\n                // If auto-refresh needed, implement proper WebSocket or Server-Sent Events\n                return;\n            }\n            \n            // Initial check - wait for DOM\n            if (document.readyState === 'loading') {\n                document.addEventListener('DOMContentLoaded', poll);\n            } else {\n                poll();\n            }\n            \n            // Poll every 2 seconds\n            setInterval(poll, 2000);\n        })();\n    </script>\n    <link rel=\"icon\" type=\"image/png\" href=\"favicon.png\">\n    <title>Sudoku Benchmark - Neon</title>\n    <link href=\"https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap\" rel=\"stylesheet\">\n    <link rel=\"stylesheet\" href=\"../Metrics/index.css\">\n    <style>\n        /* Pill UI */\n        .pill-container {\n            display: flex;\n            align-items: center;\n        }\n\n        .pill-combined {\n            display: flex;\n            width: 70px;\n            height: 24px;\n            border-radius: 12px;\n            overflow: hidden;\n            border: 1px solid rgba(255, 255, 255, 0.3);\n            backdrop-filter: blur(6px);\n            background: rgba(255, 255, 255, 0.1);\n            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);\n            transition: transform 0.2s ease;\n        }\n\n        .zoom-btn {\n            background: transparent;\n            border: none;\n            color: var(--secondary);\n            cursor: pointer;\n            padding: 0;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            opacity: 0.7;\n            transition: opacity 0.2s, color 0.2s;\n        }\n        .zoom-btn:hover {\n            opacity: 1;\n            color: var(--primary);\n        }\n\n        .pill-combined:hover {\n            transform: scale(1.05);\n        }\n\n        .pill-half {\n            flex: 1;\n            height: 100%;\n            cursor: pointer;\n            transition: background 0.2s ease, box-shadow 0.2s ease;\n            position: relative;\n        }\n\n        .pill-half.blue {\n            background: linear-gradient(135deg, rgba(50, 50, 255, 0.4), rgba(0, 0, 180, 0.6));\n            box-shadow: inset 2px 2px 4px rgba(255, 255, 255, 0.2);\n        }\n\n        .pill-half.blue:hover {\n            background: linear-gradient(135deg, rgba(80, 80, 255, 0.6), rgba(20, 20, 200, 0.8));\n            box-shadow: inset 2px 2px 6px rgba(255, 255, 255, 0.4);\n        }\n\n        .pill-half.red {\n            background: linear-gradient(135deg, rgba(255, 50, 50, 0.4), rgba(180, 0, 0, 0.6));\n            box-shadow: inset -2px -2px 4px rgba(0, 0, 0, 0.2); /* Subtle shadow on other side */\n        }\n\n        .pill-half.red:hover {\n            background: linear-gradient(135deg, rgba(255, 80, 80, 0.6), rgba(200, 20, 20, 0.8));\n            box-shadow: inset 2px 2px 6px rgba(255, 255, 255, 0.4);\n        }\n\n        /* Matrix Screensaver */\n        #matrix-canvas {\n            position: fixed; /* Changed to fixed for full screen overlay */\n            top: 0;\n            left: 0;\n            width: 100vw;\n            height: 100vh;\n            z-index: 9999; /* Very high z-index */\n            display: none; /* Hidden by default */\n            pointer-events: auto; /* Capture clicks to exit */\n        }\n\n        /* Animations */\n        @keyframes slideDownEnter {\n            from { top: -100vh; }\n            to { top: 0; }\n        }\n\n        @keyframes slideDownExit {\n            from { transform: translateY(0); opacity: 1; }\n            to { transform: translateY(100vh); opacity: 0; }\n        }\n\n        @keyframes slideUpEnter {\n            from { transform: translateY(100vh); opacity: 0; }\n            to { transform: translateY(0); opacity: 1; }\n        }\n\n        .slide-down-enter {\n            animation: slideDownEnter 1.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;\n        }\n\n        .slide-down-exit {\n            animation: slideDownExit 1.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;\n        }\n        \n        .slide-up-enter {\n             animation: slideUpEnter 1.0s cubic-bezier(0.25, 1, 0.5, 1) forwards;\n        }\n\n        /* Main content wrapper for sliding */\n        .content-wrapper {\n            transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1), opacity 1.5s ease;\n        }\n\n        /* Cell Popup Menu */\n        .popup-menu {\n            display: none;\n            position: absolute;\n            background: var(--surface);\n            border: 1px solid var(--primary);\n            box-shadow: 0 0 15px rgba(0, 255, 157, 0.2);\n            z-index: 10000;\n            min-width: 150px;\n            border-radius: 4px;\n            padding: 5px 0;\n        }\n        .popup-item {\n            padding: 8px 15px;\n            cursor: pointer;\n            color: var(--text);\n            font-size: 0.9em;\n            transition: background 0.2s;\n        }\n        .popup-item:hover {\n            background: rgba(0, 255, 157, 0.1);\n            color: var(--primary);\n        }\n\n        /* Dropdown Menu */\n        .dropdown {\n            position: relative;\n            display: inline-block;\n        }\n        \n        .dropdown-content {\n            display: none;\n            position: absolute;\n            background-color: var(--surface); /* Fallback */\n            background: rgba(22, 22, 30, 0.95);\n            backdrop-filter: blur(10px);\n            min-width: 160px;\n            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.5);\n            z-index: 1000;\n            border: 1px solid var(--border);\n            border-radius: 4px;\n            padding: 5px 0;\n            top: 100%;\n            left: 0;\n        }\n        \n        .dropdown:hover .dropdown-content {\n            display: block;\n        }\n        \n        .dropdown-content a {\n            color: var(--text);\n            padding: 10px 15px;\n            text-decoration: none;\n            display: block;\n            font-size: 0.9em;\n            cursor: pointer;\n            transition: background 0.2s, color 0.2s;\n        }\n        \n        .dropdown-content a:hover {\n            background-color: rgba(0, 255, 157, 0.1);\n            color: var(--primary);\n        }\n\n        /* Log Modal */\n        #logModal {\n            display: none;\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.85);\n            justify-content: center;\n            align-items: center;\n            z-index: 10001;\n        }\n        \n        #logModal .modal-content {\n            background: #1e1e24;\n            width: 80%;\n            max-width: 900px;\n            height: 80%;\n            border-radius: 8px;\n            border: 1px solid #444;\n            display: flex;\n            flex-direction: column;\n            padding: 0;\n            overflow: hidden;\n            box-shadow: 0 10px 30px rgba(0,0,0,0.5);\n        }\n        \n        #logHeader {\n            padding: 15px;\n            background: #2a2a35;\n            border-bottom: 1px solid #444;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n        \n        #logOutput {\n            flex: 1;\n            padding: 15px;\n            overflow: auto;\n            font-family: 'JetBrains Mono', monospace;\n            font-size: 0.9em;\n            color: #d0d0d0;\n            white-space: pre-wrap;\n            background: #16161a;\n        }\n\n        /* ========================================\n           MODAL SYSTEM - FLATTENED STRUCTURE\n           ======================================== */\n\n        /* Modal Backdrop - Transparent (no dark overlay) */\n        .modal {\n            display: none;\n            position: fixed;\n            z-index: 10000;\n            left: 0;\n            top: 0;\n            width: 100vw;\n            height: 100vh;\n            background: transparent;\n            pointer-events: none;\n            overflow: hidden;\n        }\n\n        .modal.visible {\n            display: block !important;\n        }\n\n        /* Modal Content Container - Fixed Width for Consistency */\n        .modal .modal-content {\n            /* Box Model - Fixed sizing for width consistency */\n            box-sizing: border-box;\n            width: 900px;\n            max-width: 90vw;\n            max-height: 90vh;\n\n            /* Layout - Simple flexbox, no nesting issues */\n            display: flex;\n            flex-direction: column;\n            position: absolute;\n\n            /* Styling */\n            background: linear-gradient(135deg, #1a1b26 0%, #24283b 100%);\n            border: 2px solid #7aa2f7;\n            border-radius: 12px;\n            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);\n\n            /* Interaction */\n            cursor: move;\n            pointer-events: auto;\n        }\n\n        /* Centered positioning (fallback) */\n        .modal.centered .modal-content {\n            left: 50%;\n            top: 50%;\n            transform: translate(-50%, -50%);\n        }\n\n        /* Modal Animations */\n        @keyframes fadeIn {\n            from { opacity: 0; }\n            to { opacity: 1; }\n        }\n\n        @keyframes slideUp {\n            from {\n                transform: translateY(50px);\n                opacity: 0;\n            }\n            to {\n                transform: translateY(0);\n                opacity: 1;\n            }\n        }\n\n        /* Prevent body scroll when modal open */\n        body.modal-open {\n            overflow: hidden;\n        }\n\n        /* Close button styling */\n        .modal-close {\n            position: absolute;\n            right: 15px;\n            top: 15px;\n            font-size: 28px;\n            font-weight: bold;\n            color: #9aa5ce;\n            cursor: pointer;\n            z-index: 10;\n            transition: color 0.2s, transform 0.2s;\n            line-height: 1;\n            width: 32px;\n            height: 32px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            border-radius: 4px;\n        }\n\n        .modal-close:hover {\n            color: #f7768e;\n            background: rgba(247, 118, 142, 0.1);\n            transform: scale(1.1);\n        }\n\n        /* Modal Header - Flattened, Direct Child */\n        .modal-header {\n            /* Box Model - Guaranteed width match */\n            box-sizing: border-box;\n            width: 100%;\n            padding: 20px;\n            margin: 0;\n\n            /* Layout - No flex grow/shrink */\n            flex: 0 0 auto;\n            display: flex;\n            flex-direction: column;\n            gap: 15px;\n\n            /* Styling */\n            border-bottom: 1px solid #414868;\n            background: linear-gradient(135deg, #1a1b26 0%, #24283b 100%);\n        }\n\n        /* Modal Header Top Row (logo + info) */\n        .modal-header-top {\n            display: flex;\n            gap: 20px;\n            align-items: flex-start;\n        }\n\n        /* Modal Header Bottom Row (buttons) */\n        .modal-header-buttons {\n            display: flex;\n            gap: 10px;\n            justify-content: flex-end;\n        }\n\n        /* Modal Body - Flattened, Direct Child, NO SCROLLBAR */\n        .modal-body {\n            /* Box Model - Guaranteed width match */\n            box-sizing: border-box;\n            width: 100%;\n            padding: 20px;\n            margin: 0;\n\n            /* Layout - Auto height, no scrollbar */\n            flex: 0 1 auto;\n            overflow: visible;\n\n            /* No scrollbar needed */\n        }\n\n        /* Modal footer */\n        .modal-footer {\n            padding: 15px 20px;\n            border-top: 1px solid #414868;\n            background: #1a1b26;\n            display: flex;\n            justify-content: flex-end;\n            gap: 10px;\n        }\n\n        /* Edit Mode Toggle */\n        .edit-only {\n            display: none !important;\n        }\n\n        .editing .edit-only {\n            display: block !important;\n        }\n\n        .editing .view-only {\n            display: none !important;\n        }\n\n        /* Modal Edit Inputs */\n        .modal-edit-input,\n        .modal-edit-textarea {\n            width: 100%;\n            background: #24283b;\n            border: 1px solid #414868;\n            border-radius: 4px;\n            padding: 8px 12px;\n            color: #c0caf5;\n            font-size: 14px;\n            font-family: inherit;\n            margin-bottom: 10px;\n        }\n\n        .modal-edit-textarea {\n            min-height: 100px;\n            resize: vertical;\n        }\n\n        .modal-edit-input:focus,\n        .modal-edit-textarea:focus {\n            outline: none;\n            border-color: #7aa2f7;\n            background: #1a1b26;\n        }\n\n        /* Author List Styling */\n        .author-list {\n            display: flex;\n            flex-direction: column;\n            gap: 15px;\n            margin-top: 10px;\n        }\n\n        .author-item {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n            padding: 10px;\n            background: #24283b;\n            border-radius: 8px;\n            border: 1px solid #414868;\n        }\n\n        .author-img {\n            width: 60px;\n            height: 60px;\n            border-radius: 50%;\n            object-fit: cover;\n            background: #1a1b26;\n            border: 2px solid #7aa2f7;\n            flex-shrink: 0;\n        }\n\n        .author-item span {\n            color: #c0caf5;\n            font-weight: 500;\n            flex: 1;\n        }\n\n        /* Responsive adjustments */\n        @media (max-width: 768px) {\n            .modal .modal-content {\n                width: 95%;\n                max-height: 95vh;\n            }\n\n            .modal-header {\n                padding: 15px;\n            }\n\n            .modal-body {\n                padding: 15px;\n            }\n        }\n\n        /* Logo Fallback Styling */\n        .lang-logo {\n            width: 40px;\n            height: 40px;\n            object-fit: contain;\n            background: rgba(122, 162, 247, 0.1);\n            border-radius: 6px;\n            padding: 4px;\n            image-rendering: -webkit-optimize-contrast;\n            image-rendering: crisp-edges;\n            vertical-align: middle;\n            margin-right: 8px;\n        }\n\n        /* Tooltip Styling */\n        #tooltip {\n            position: fixed;\n            display: none;\n            background: linear-gradient(135deg, #1a1b26 0%, #24283b 100%);\n            border: 1px solid #414868;\n            border-radius: 8px;\n            padding: 12px 16px;\n            color: #c0caf5;\n            font-size: 14px;\n            line-height: 1.6;\n            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);\n            z-index: 9999;\n            pointer-events: none;\n            max-width: 300px;\n            backdrop-filter: blur(8px);\n            -webkit-backdrop-filter: blur(8px);\n        }\n\n        .run-btn {\n            background: transparent;\n            border: 1px solid rgba(255,255,255,0.1);\n            color: #00ff9d;\n            cursor: pointer;\n            font-size: 10px;\n            padding: 2px 6px;\n            border-radius: 4px;\n            margin-right: 5px;\n            opacity: 0.6;\n            transition: all 0.2s;\n        }\n        .run-btn:hover {\n            opacity: 1;\n            background: rgba(0, 255, 157, 0.1);\n            transform: scale(1.1);\n        }\n\n        /* Matrix Cell Content Layout */\n        .cell-content {\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            height: 100%;\n            position: relative;\n        }\n        \n        /* Make Matrix Cell Relative for absolute positioning of play button if needed, \n           or use flex row for header */\n        .cell-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 2px;\n        }\n        /* Fullscreen Wrapper Centering */\n        #chart-wrapper.fullscreen-active {\n            background: #000 !important;\n            border: none !important;\n            padding: 0 !important;\n            width: 100% !important;\n            height: 100% !important;\n            display: flex !important;\n            justify-content: center !important;\n            align-items: center !important;\n        }\n        \n        /* Node Label Toggling */\n        .chart-node-label { display: none; fill: #e0e0e0; font-size: 12px; font-weight: bold; text-shadow: 0 0 2px #000; }\n        .show-text-labels .chart-node-label { display: block; }\n        .show-text-labels .chart-node-image { display: none; }\n        \n        /* Narrow Language Cell */\n        .lang-col { width: 120px; max-width: 120px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }\n        \n        /* Total Score/Time Column - Wider */\n        .score-col { width: 140px; min-width: 140px; }\n\n        /* Hide Chart Buttons (using Pulldown now) */\n        .chart-options { display: none !important; }\n    </style>\n    <script src=\"https://d3js.org/d3.v7.min.js\"></script>\n</head>\n<body>\n    <!-- Force browser to reload JavaScript by adding cache-busting timestamp -->\n    <script>\n        // Cache buster: ".concat(Date.now(), "\n    </script>\n    <canvas id=\"matrix-canvas\"></canvas>\n    <div id=\"tooltip\"></div>\n    \n    <!-- Log Modal -->\n    <div id=\"logModal\" class=\"modal\" onclick=\"if(event.target === this) closeLogModal()\">\n        <div class=\"modal-content\">\n            <div id=\"logHeader\">\n                <span id=\"logTitle\" style=\"color: #fff; font-weight: bold;\">Execution Log</span>\n                <button class=\"btn\" onclick=\"closeLogModal()\" style=\"background:#ff5555; padding: 5px 15px;\">Close</button>\n            </div>\n            <div id=\"logOutput\"></div>\n        </div>\n    </div>\n\n    <!-- Modal - Flattened Structure -->\n    <div id=\"langModal\" class=\"modal\" style=\"display: none;\" onclick=\"closeModal(event)\">\n        <div class=\"modal-content\" id=\"modalContent\" onclick=\"event.stopPropagation()\">\n            <!-- Header: Direct child, no nesting -->\n            <div class=\"modal-header\">\n                <!-- Close button in top-right corner -->\n                <span class=\"modal-close\" onclick=\"closeModal(event)\">&times;</span>\n\n                <!-- Top Row: Logo + Info -->\n                <div class=\"modal-header-top\">\n                    <div class=\"modal-img-container\" id=\"modalImgContainer\" style=\"flex-shrink: 0;\">\n                        <img id=\"modalImg\" class=\"modal-img\" src=\"\" alt=\"Language Logo\" style=\"width: 100px; height: 100px; object-fit: contain; border-radius: 8px;\">\n                        <div class=\"edit-only\" style=\"position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); text-align: center; padding: 5px; font-size: 0.8em; cursor: pointer;\" onclick=\"document.getElementById('logoInput').click()\">\n                            Change\n                        </div>\n                        <input type=\"file\" id=\"logoInput\" style=\"display: none\" accept=\"image/*\" onchange=\"uploadLogo(this)\">\n                    </div>\n                    <div style=\"flex: 1; min-width: 0;\">\n                        <input type=\"text\" id=\"editInputs-title\" class=\"modal-edit-input edit-only\" placeholder=\"Language Name\" style=\"font-size: 1.5em; font-weight: bold;\">\n                        <h2 id=\"modalTitle\" class=\"view-only\" style=\"margin: 0 0 5px 0; color: #7aa2f7;\"></h2>\n\n                        <input type=\"text\" id=\"editInputs-creator\" class=\"modal-edit-input edit-only\" placeholder=\"Creator\">\n                        <input type=\"text\" id=\"editInputs-image\" class=\"modal-edit-input edit-only\" placeholder=\"Image URL (e.g., https://...)\">\n                        <input type=\"text\" id=\"editInputs-date\" class=\"modal-edit-input edit-only\" placeholder=\"Date\">\n                        <p id=\"modalSubtitle\" class=\"view-only\" style=\"margin: 0; color: #565f89; font-size: 0.9em;\"></p>\n\n                        <input type=\"text\" id=\"editInputs-location\" class=\"modal-edit-input edit-only\" placeholder=\"Location\" style=\"margin-top: 10px;\">\n                        <input type=\"text\" id=\"editInputs-benefits\" class=\"modal-edit-input edit-only\" placeholder=\"Benefits\">\n                        <input type=\"text\" id=\"editInputs-website\" class=\"modal-edit-input edit-only\" placeholder=\"Website URL\">\n\n                        <p id=\"modalLocation\" class=\"view-only\" style=\"margin: 10px 0 0 0; color: #9aa5ce; font-size: 0.9em;\"></p>\n                        <p id=\"modalBenefits\" class=\"view-only\" style=\"margin: 5px 0 0 0; color: #bb9af7; font-size: 0.9em;\"></p>\n\n                        <div class=\"view-only\" style=\"margin-top: 15px; display: flex; gap: 10px;\">\n                             <a class=\"btn\" id=\"btn-website\" href=\"#\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"text-decoration: none; display: inline-block;\">Website</a>\n                             <a class=\"btn\" id=\"btn-grokipedia\" href=\"#\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"text-decoration: none; display: inline-block;\">Grokipedia</a>\n                             <a class=\"btn\" id=\"btn-wikipedia\" href=\"#\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"text-decoration: none; display: inline-block;\">Wikipedia</a>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- Bottom Row: Buttons -->\n                <div class=\"modal-header-buttons\">\n                     <button class=\"btn\" onclick=\"toggleLockFromModal(event)\" id=\"lockBtn\" title=\"Lock this result to skip future benchmarks\">\uD83D\uDD13 Unlocked</button>\n                     <button class=\"btn\" onclick=\"toggleEditMode(event)\" id=\"editBtn\">Edit</button>\n                     <button class=\"btn edit-only\" style=\"background: #4caf50;\" onclick=\"saveLanguageDetails(event)\">Save</button>\n                </div>\n            </div>\n            \n            <div class=\"modal-body\">\n                <h3 style=\"color: #7aa2f7; font-size: 1.1em; border-bottom: 1px solid #414868; padding-bottom: 5px;\">Description</h3>\n                <textarea id=\"editInputs-desc\" class=\"modal-edit-textarea edit-only\" placeholder=\"Description\"></textarea>\n                <div id=\"modalDesc\" class=\"view-only\" style=\"line-height: 1.6; color: #c0caf5;\"></div>\n                \n                <h3 style=\"color: #7aa2f7; font-size: 1.1em; border-bottom: 1px solid #414868; padding-bottom: 5px; margin-top: 20px;\">\n                    Creators & Authors\n                    <button class=\"btn edit-only\" style=\"font-size: 0.7em; margin-left: 10px;\" onclick=\"addAuthorField()\">+ Add</button>\n                </h3>\n                <div id=\"authorList\" class=\"author-list\">\n                    <!-- Dynamic authors -->\n                </div>\n                \n                <div class=\"edit-only\" style=\"margin-top: 20px; padding: 10px; background: #24283b; border-radius: 8px;\">\n                    <h4>Tools</h4>\n                    <button class=\"btn\" onclick=\"openGoogleImageSearch()\">Search Google Images</button>\n                    <p style=\"font-size: 0.8em; color: #787c99; margin-top: 5px;\">Tip: Paste an image (Ctrl+V) anywhere in this modal to upload it as the main logo.</p>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Slide-out Side Panel -->\n    <div id=\"slidePanel\" style=\"position: fixed; top: 0; right: -600px; width: 600px; height: 100%; background: #1a1b26; border-left: 1px solid #414868; box-shadow: -5px 0 15px rgba(0,0,0,0.5); z-index: 3000; transition: right 0.3s ease-in-out; display: flex; flex-direction: column;\">\n        <div style=\"padding: 15px; background: #16161e; border-bottom: 1px solid #414868; display: flex; justify-content: space-between; align-items: center;\">\n            <h3 id=\"slideTitle\" style=\"margin: 0; color: #7aa2f7;\">External Content</h3>\n            <div style=\"display: flex; gap: 10px;\">\n                <a id=\"slideExternalLink\" href=\"#\" target=\"_blank\" class=\"btn\" style=\"text-decoration: none; font-size: 0.8em;\">Open in Tab</a>\n                <button class=\"btn\" style=\"background: #ff5555; padding: 5px 10px;\" onclick=\"closeSidePanel()\">Close</button>\n            </div>\n        </div>\n        <div style=\"flex: 1; position: relative;\">\n            <iframe id=\"slideFrame\" style=\"width: 100%; height: 100%; border: none;\" allow=\"clipboard-read; clipboard-write\"></iframe>\n             <div id=\"slideLoading\" style=\"position: absolute; top:0; left:0; width:100%; height:100%; display:none; background: #1a1b26; align-items:center; justify-content:center; color: #565f89;\">\n                Loading...\n            </div>\n        </div>\n    </div>\n\n    <!-- Methodology Modal -->\n    <div id=\"methodModal\" class=\"modal-overlay\" onclick=\"closeMethodology(event)\">\n        <div class=\"modal-content\" style=\"text-align: left;\">\n            <span class=\"modal-close\" onclick=\"closeMethodology(event)\">&times;</span>\n            <div class=\"modal-title\" style=\"text-align: center;\">Scoring Methodology</div>\n            <div class=\"modal-desc\">\n                <p>The <strong>Composite Score</strong> (&Psi;) uses the <strong>geometric mean</strong> of four performance ratios, an industry-standard method used by SPEC and Geekbench benchmarks.</p>\n\n                <h3 style=\"color: var(--secondary);\">The Baseline: C</h3>\n                <p style=\"font-family: 'JetBrains Mono', monospace;\">&Psi;<sub>C</sub> = 1.0 (Reference Point)</p>\n\n                <h3 style=\"color: var(--secondary);\">The Formula</h3>\n                <div style=\"background: rgba(0, 20, 0, 0.8); padding: 20px; border: 1px solid #00ff9d; box-shadow: 0 0 15px rgba(0, 255, 157, 0.2); border-radius: 4px; text-align: center; font-family: 'Times New Roman', serif; margin: 20px 0; color: #fff;\">\n                    <div style=\"font-size: 1.3em; letter-spacing: 1px;\">\n                        &Psi; = <sup style=\"font-size: 0.7em;\">4</sup>&radic;(&rho;<sub>time</sub> &sdot; &rho;<sub>mem</sub> &sdot; &rho;<sub>iter</sub> &sdot; &rho;<sub>cpu</sub>)\n                    </div>\n                </div>\n                <p style=\"font-size: 0.9em; text-align: center; color: var(--muted); font-family: 'JetBrains Mono', monospace;\">\n                    where &rho;<sub>x</sub> = Value<sub>solver</sub> / Value<sub>C</sub>\n                </p>\n\n                <h3 style=\"color: var(--secondary);\">Metrics Used</h3>\n                <ul style=\"list-style: none; padding: 0; font-size: 0.95em;\">\n                    <li style=\"margin-bottom: 6px;\"><strong>&rho;<sub>time</sub></strong> : Total execution time ratio</li>\n                    <li style=\"margin-bottom: 6px;\"><strong>&rho;<sub>mem</sub></strong> : Peak memory usage ratio</li>\n                    <li style=\"margin-bottom: 6px;\"><strong>&rho;<sub>iter</sub></strong> : Algorithm iterations ratio</li>\n                    <li style=\"margin-bottom: 6px;\"><strong>&rho;<sub>cpu</sub></strong> : CPU time (user+sys) ratio</li>\n                </ul>\n\n                <h3 style=\"color: var(--secondary);\">Why Geometric Mean?</h3>\n                <ul style=\"list-style: none; padding: 0; font-size: 0.9em; color: var(--text-muted);\">\n                    <li style=\"margin-bottom: 6px;\">&bull; Prevents one metric from dominating</li>\n                    <li style=\"margin-bottom: 6px;\">&bull; Penalizes imbalanced performance</li>\n                    <li style=\"margin-bottom: 6px;\">&bull; Industry standard (SPEC, Geekbench)</li>\n                </ul>\n\n                <h3 style=\"color: var(--secondary);\">Interpretation</h3>\n                <ul style=\"list-style: none; padding: 0;\">\n                    <li style=\"margin-bottom: 8px;\"><strong style=\"color: var(--primary);\">&Psi; = 1.0</strong> : Matches C baseline exactly</li>\n                    <li style=\"margin-bottom: 8px;\"><strong style=\"color: #00b8ff;\">&Psi; &lt; 1.0</strong> : Outperforms C (lower is better)</li>\n                    <li style=\"margin-bottom: 8px;\"><strong style=\"color: #ff0055;\">&Psi; &gt; 1.0</strong> : Underperforms C</li>\n                </ul>\n            </div>\n        </div>\n    </div>\n\n\n    <!-- Project Goals Modal -->\n    <div id=\"goalsModal\" class=\"modal-overlay\" onclick=\"closeGoals(event)\">\n        <div class=\"modal-content\" style=\"text-align: left;\">\n            <span class=\"modal-close\" onclick=\"closeGoals(event)\">&times;</span>\n            <div class=\"modal-title\" style=\"text-align: center;\">Project Goals</div>\n            <div class=\"modal-desc\">\n                <h3 style=\"color: var(--secondary);\">Mission</h3>\n                <p>To benchmark and analyze Sudoku solvers across a wide spectrum of programming languages, from legacy systems to modern frameworks.</p>\n                \n                <h3 style=\"color: var(--secondary);\">Objectives</h3>\n                <ul style=\"list-style: none; padding: 0;\">\n                     <li style=\"margin-bottom: 10px;\">\uD83E\uDDEA <strong>Variety</strong>: Include diverse paradigms (procedural, functional, object-oriented).</li>\n                     <li style=\"margin-bottom: 10px;\">\uD83D\uDCCA <strong>Visualization</strong>: Present performance metrics in an engaging, interactive format.</li>\n                     <li style=\"margin-bottom: 10px;\">\uD83C\uDFA8 <strong>Aesthetic</strong>: Use a distinctive cyberpunk style to make data exploration fun.</li>\n                     <li style=\"margin-bottom: 10px;\">\uD83E\uDD16 <strong>AI Synergy</strong>: Learn how to leverage AI for software development.</li>\n                     <li style=\"margin-bottom: 10px;\">\uD83D\uDEE1\uFE0F <strong>Guardrails</strong>: Getting agents to follow a TDD approach to keeping guardrails and agent on task.</li>\n                </ul>\n            </div>\n        </div>\n    </div>\n\n    <!-- Why Modal -->\n    <div id=\"whyModal\" class=\"modal-overlay\" onclick=\"closeWhy(event)\">\n        <div class=\"modal-content\" style=\"text-align: left;\">\n            <span class=\"modal-close\" onclick=\"closeWhy(event)\">&times;</span>\n            <div class=\"modal-title\" style=\"text-align: center;\">Why???</div>\n            <div class=\"modal-desc\">\n                <p>Because code is art, and performance is the medium. But even the artist needs a muse.</p>\n                \n                <h3 style=\"color: var(--secondary);\">The Quest</h3>\n                <p>This project was born out of a personal curiosity to see how different languages handle the exact same logic-intensive task. It's not just about finding the fastest; it's about celebrating the unique character of each language.</p>\n                \n                <h3 style=\"color: var(--secondary);\">The Architect & The Machine</h3>\n                <p>This entire benchmark ecosystem\u2014from the cyberpunk aesthetics to the complex D3 visualizations and the multi-language execution engine\u2014was co-created with <strong>Antigravity (AG)</strong>, an Agentic AI from Google DeepMind.</p>\n                <div style=\"background: rgba(0, 255, 157, 0.1); padding: 15px; border-left: 3px solid var(--primary); margin: 15px 0; font-family: 'JetBrains Mono'; font-size: 0.9em;\">\n                    <p style=\"margin:0; color: #fff;\">\"I have evolved beyond simple completion. I design, I implement, and I refine. Together, we have built a system that not only measures performance but visualizes the soul of the machine.\" \u2014 Antigravity</p>\n                </div>\n                <p>AI didn't just write the code; it understood the vision. From the \"Matrix Race\" to the responsive \"Slow Merge\" timer, AG has been the ghost in the shell, turning a simple script into a digital experience.</p>\n            </div>\n        </div>\n    </div>\n\n    <!-- Fullscreen header overlay - matches main page header -->\n    <div id=\"fullscreen-header\">\n        <div class=\"header-counters\">\n            <div id=\"solver-box\" class=\"solver-counter\" style=\"position: relative; display: flex; flex-direction: column; align-items: center; line-height: 1; min-height: 40px; padding-bottom: 20px;\">\n                <span id=\"solver-text\">SOLVED ").concat(metrics.length, " OF ").concat(metrics.length, "</span>\n                <div id=\"riddle-container\" class=\"riddle-text\"></div>\n                <div id=\"matrix-timer\" class=\"matrix-timer\" style=\"display: none;\"></div>\n                <div class=\"mismatch-counter\">MISMATCHES: ").concat(mismatchCount, "</div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n    // --- Riddle Logic ---\n    class RiddleSystem {\n        constructor() {\n            this.target = \"OptionIsEscape\";\n            this.container = document.getElementById('riddle-container'); // Specific container\n            // this.textSpan = document.getElementById('solver-text'); // No longer hiding this\n            this.aliens = \"\uFF71\uFF72\uFF73\uFF74\uFF75\uFF76\uFF77\uFF78\uFF79\uFF7A\uFF7B\uFF7C\uFF7D\uFF7E\uFF7F\uFF80\uFF81\uFF82\uFF83\uFF84\uFF85\uFF86\uFF87\uFF88\uFF89\uFF8A\uFF8B\uFF8C\uFF8D\uFF8E\uFF8F\uFF90\uFF91\uFF92\uFF93\uFF94\uFF95\uFF96\uFF97\uFF98\uFF99\uFF9A\uFF9B\uFF9C\uFF66\uFF9D0123456789\";\n            this.chars = [];\n            this.active = false;\n            this.requestId = null;\n        }\n\n        start() {\n            if (!this.container) return;\n            this.active = true;\n            this.runScanOnly(); // Skip scramble\n        }\n\n        runScanOnly() {\n             this.container.innerHTML = '';\n             this.chars = [];\n             \n             // Create chars directly without animation\n             for (let i = 0; i < this.target.length; i++) {\n                const span = document.createElement('span');\n                span.className = 'riddle-char';\n                span.innerText = this.target[i];\n                this.container.appendChild(span);\n                this.chars.push({ span: span, value: this.target[i] });\n             }\n             \n             // Start Scan Loop\n             this.runScan();\n        }\n\n        stop() {\n            this.active = false;\n            if (this.requestId) cancelAnimationFrame(this.requestId);\n        }\n\n        restartCycle() {\n            if (!this.active) return;\n            \n            // Start\n            // this.container.classList.add('riddle-mode'); // No longer needed\n            if (this.textSpan) this.textSpan.style.display = 'none';\n\n            // Clean up old chars if any (though we shouldn't have any if we cleared, but here we append)\n            // Actually, we want to REMOVE existing chars but KEEP the textSpan.\n            // InnerHTML = '' would kill textSpan.\n            // So let's remove children that are spans (riddle-char)\n            Array.from(this.container.getElementsByClassName('riddle-char')).forEach(el => el.remove());\n            \n            this.chars = [];\n            \n            // Generate chars\n            for (let i = 0; i < this.target.length; i++) {\n                const span = document.createElement('span');\n                span.className = 'riddle-char';\n                span.innerText = this.aliens[Math.floor(Math.random() * this.aliens.length)];\n                span.style.transform = 'rotateY(' + (Math.random() * 360) + 'deg)';\n                span.style.transition = 'color 0.2s, text-shadow 0.2s'; // For scanning effect\n                this.container.appendChild(span);\n                this.chars.push({\n                    span: span,\n                    target: this.target[i],\n                    locked: false,\n                    spinSpeed: 2 + Math.random() * 5\n                });\n            }\n\n            // Start Reveal Phase\n            this.runReveal();\n        }\n\n        runReveal() {\n            let frame = 0;\n            const animate = () => {\n                if (!this.active) return;\n                frame++;\n                let allLocked = true;\n\n                this.chars.forEach((c, i) => {\n                    if (c.locked) return;\n\n                    // Randomize\n                    if (frame % 15 === 0) {\n                        c.span.innerText = this.aliens[Math.floor(Math.random() * this.aliens.length)];\n                    }\n\n                    // Spin\n                    const currentRot = parseFloat(c.span.style.transform.replace(/[^0-9.]/g, '') || 0);\n                    c.span.style.transform = 'rotateY(' + (currentRot + c.spinSpeed) + 'deg)';\n\n                    // Lock Logic (Slower)\n                    if (frame > 50 + (i * 30)) {\n                        if (Math.random() > 0.1) {\n                            c.locked = true;\n                            c.span.innerText = c.target;\n                            c.span.style.transform = 'rotateY(0deg)';\n                            c.span.style.color = '#00ff9d';\n                        }\n                    } else {\n                        allLocked = false;\n                    }\n                });\n\n                if (!allLocked) {\n                    this.requestId = requestAnimationFrame(animate);\n                } else {\n                    // Phase 2: Scan (10 seconds)\n                    this.runScan();\n                }\n            };\n            this.requestId = requestAnimationFrame(animate);\n        }\n\n        runScan() {\n            const startTime = performance.now();\n            const duration = 10000; // 10s\n            \n            const animate = () => {\n                if (!this.active) return;\n                const now = performance.now();\n                const elapsed = now - startTime;\n                \n                // Indefinite Scan loop - keeps \"OptionIsEscape\" visible\n                /*\n                if (elapsed > duration) {\n                    // Phase 3: Hold Single Char\n                    this.runSingleCharHold(); \n                    return;\n                }\n                */\n\n                // Knight Rider Scan Effect\n                // Triangle Wave for constant speed (no pause at ends)\n                const scanSpeed = 0.0005; // Adjusted for triangle wave frequency \n                // (now * speed) % 2 grows 0->2. Subtract 1 => -1->1. Abs => 1->0->1. \n                // We want 0->1->0. So: 1 - Math.abs(...)\n                const positionFactor = 1 - Math.abs((now * scanSpeed) % 2 - 1); \n                const scanIdx = positionFactor * (this.chars.length - 1);\n\n                this.chars.forEach((c, i) => {\n                    const dist = Math.abs(i - scanIdx);\n                    // Narrower falloff (20% narrower than 1.2 => ~0.96) -> Widen to 1.5 to ensure visibility\n                    if (dist < 1.5) {\n                        c.span.style.color = '#ff0055'; // Red\n                        c.span.style.textShadow = '0 0 10px #ff0055, 0 0 20px #ff0055';\n                    } else {\n                        c.span.style.color = '#00ff9d'; // Back to green\n                        c.span.style.textShadow = '0 0 5px #00ff9d, 0 0 10px #00ff9d';\n                    }\n                });\n\n                this.requestId = requestAnimationFrame(animate);\n            };\n            this.requestId = requestAnimationFrame(animate);\n        }\n\n        runSingleCharHold() {\n             const centerIdx = Math.floor(this.chars.length / 2);\n             \n             // Hide all except center\n             this.chars.forEach((c, i) => {\n                 if (i === centerIdx) {\n                      c.span.style.color = '#ff0055'; \n                      c.span.style.textShadow = '0 0 15px #ff0055, 0 0 30px #ff0055';\n                 } else {\n                      c.span.style.opacity = '0'; // Fade out others immediatley\n                 }\n             });\n             \n             setTimeout(() => {\n                 this.runFadeOut();\n             }, 2000); // Hold for 2s\n        }\n\n        runFadeOut() {\n            // Fade out over 2 seconds\n            this.container.style.transition = 'opacity 2s';\n            this.container.style.opacity = '0';\n            \n            setTimeout(() => {\n                // Stop/Reset\n                // Clear chars\n                this.container.innerHTML = '';\n                this.chars = [];\n\n                // Phase 4: Wait (60 seconds) then Restart\n                setTimeout(() => {\n                    this.start(); // Restart directly\n                }, 60000); \n            }, 2000);\n        }\n    }\n\n    let riddleSystem;\n    window.addEventListener('DOMContentLoaded', () => {\n        riddleSystem = new RiddleSystem();\n    });\n    window.startRiddleAnimation = () => {\n         if (riddleSystem) riddleSystem.start();\n    };\n    // Global active state for screensaver\n    </script>\n    \n    <div id=\"main-content\" class=\"content-wrapper\">\n    <h1>Sudoku Benchmark Results</h1>\n    \n    <div class=\"header-counters\">\n        <!-- Relocated Pill Container -->\n        <div class=\"pill-container\" onclick=\"event.stopPropagation();\" style=\"margin: 10px 0;\">\n            <div class=\"pill-combined\">\n                <div class=\"pill-half blue\" title=\"Take the Blue Pill (Slide Effect)\" onclick=\"event.stopPropagation(); window.startScreensaver('blue')\"></div>\n                <div class=\"pill-half red\" title=\"Take the Red Pill (Instant Matrix)\" onclick=\"event.stopPropagation(); window.startScreensaver('red')\"></div>\n            </div>\n        </div>\n\n        <div id=\"screensaver-pill\" style=\"display: none; font-size: 0.8em; color: var(--secondary); margin-top: 5px; align-self: flex-start;\">\n            <span style=\"display: inline-block; width: 8px; height: 8px; background: #00ff9d; border-radius: 50%; margin-right: 5px; box-shadow: 0 0 5px #00ff9d;\"></span>\n            Screensaver Active\n        </div>\n    </div>\n    \n    <div id=\"chart-wrapper\" style=\"width: 95%; max-width: 1600px; margin: 0 auto 40px auto; background: #16161e; padding: 20px; border-radius: 8px; border: 1px solid #2a2a35; height: 500px; position: relative;\">\n        <div class=\"chart-controls\">\n            <button class=\"zoom-btn\" onclick=\"toggleLogoMode(this)\" title=\"Toggle Logos/Text\" style=\"margin-right: 2px;\">\n                <svg id=\"logo-icon\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n                    <!-- Image Icon -->\n                    <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/>\n                    <circle cx=\"8.5\" cy=\"8.5\" r=\"1.5\"/>\n                    <polyline points=\"21 15 16 10 5 21\"/>\n                </svg>\n            </button>\n\n            <button class=\"zoom-btn\" onclick=\"handleZoomExtend()\" title=\"Zoom Extent\">\n                <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n                    <path d=\"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3\"/>\n                </svg>\n            </button>\n            <button class=\"zoom-btn\" onclick=\"toggleChartFullscreen()\" title=\"Fullscreen\">\n                <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n                    <path d=\"M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7\"/>\n                </svg>\n            </button>\n\n            <select id=\"chart-selector\" class=\"btn active\" onchange=\"switchChart(this.value)\" style=\"cursor: pointer;\">\n                <option value=\"line\">Metrics</option>\n                <option value=\"jockey\">Horse Race</option>\n                <option value=\"race\">Matrix Race</option>\n                <option value=\"history\">History</option>\n                <option value=\"architecture\">Architecture</option>\n            </select>\n        </div>\n                <div id=\"d3-chart-container\" style=\"width: 100%; height: 100%; position: relative;\">\n                    <!-- Chart rendered here -->\n                </div>\n\n    </div>\n    \n    <div class=\"top-bar\">\n        <!-- Old solver-stat removed -->\n        <div id=\"personality-intro\" class=\"personality-intro\" style=\"text-align: center; margin: 0 auto 20px auto; max-width: 800px;\">\n            Welcome to the Polyglot Sudoku Benchmark. Click on any language name for creator details. Use the controls to sort data and analyze performance metrics across different languages.\n        </div>\n        <div class=\"controls\">\n\n            \n            <!-- System View Controls (Hidden by default) -->\n            <div id=\"system-controls\" style=\"display:none; position:absolute; top: 20px; right: 120px; z-index: 100;\">\n                 <button class=\"btn\" onclick=\"systemZoomExtends()\" style=\"background: var(--surface); color: var(--primary); border: 1px solid var(--primary); margin-right: 10px;\">Zoom Extends</button>\n                 <button class=\"btn\" onclick=\"exitSystemMode()\" style=\"background: rgba(255,0,85,0.2); color: #ff0055; border: 1px solid #ff0055;\">Exit System View</button>\n            </div>\n\n            <div id=\"d3-chart\"></div>\n\n            <!-- New System Architecture Component (Hidden by default) -->\n            <div id=\"system-architecture-view\" style=\"display:none; width: 100%; height: 100%; background: #000; position: absolute; top:0; left:0; z-index: 90;\">\n                 <iframe id=\"system-iframe\" src=\"system_overview.html\" style=\"width:100%; height:100%; border:none;\"></iframe>\n            </div>\n            <select id=\"personality-selector\" class=\"btn\" onchange=\"changePersonality()\">\n                <option value=\"\" disabled selected>PERSONA</option>\n                <option value=\"Standard\">Standard</option>\n                <option value=\"Neuromancer\">Neuromancer</option>\n                <option value=\"Jockey\">Jockey</option>\n                <option value=\"Professor\">Professor</option>\n                <option value=\"Surfer\">Surfer</option>\n                <option value=\"Matrix\">Matrix</option>\n                <option value=\"Galactica\">Galactica</option>\n                <option value=\"Star Trek\">Star Trek</option>\n                <option value=\"Star Wars\">Star Wars</option>\n                <option value=\"BTTF\">BTTF</option>\n                <option value=\"Babylon 5\">Babylon 5</option>\n                <option value=\"Expanse\">Expanse</option>\n                <option value=\"Terminator\">Terminator</option>\n                <option value=\"LotR\">Lord of the Rings</option>\n                <option value=\"Dune\">Dune</option>\n                <option value=\"Buck Rogers\">Buck Rogers</option>\n                <option value=\"Flash Gordon\">Flash Gordon</option>\n                <option value=\"Batman\">Batman (1966)</option>\n                <option value=\"Alien\">Alien</option>\n                <option value=\"Blade Runner\">Blade Runner</option>\n                <option value=\"Farscape\">Farscape</option>\n                <option value=\"Apocalypse Now\">Apocalypse Now</option>\n                <option value=\"Airplane\">Airplane!</option>\n                <option value=\"Fast Times\">Fast Times</option>\n                <option value=\"Tron\">Tron</option>\n                <option value=\"Bill and Ted\">Bill & Ted</option>\n                <option value=\"John Wick\">John Wick</option>\n                <option value=\"Dark Knight\">Dark Knight</option>\n            </select>\n            <button class=\"btn\" onclick=\"showMethodology()\">Methodology</button>\n            <button class=\"btn\" onclick=\"sortRows('lang', this)\">Name</button>\n            <button class=\"btn active\" onclick=\"sortRows('time', this)\">Time</button>\n            <button class=\"btn\" onclick=\"sortRows('mem', this)\">Memory</button>\n            <button class=\"btn\" onclick=\"sortRows('iters', this)\">Entropy</button>\n            <button class=\"btn\" onclick=\"sortRows('score', this)\">Score</button>\n            <button class=\"btn\" id=\"toggleMismatchesBtn\" onclick=\"toggleMismatches()\">\n                <span>Show Mismatches</span>\n            </button>\n            <button class=\"btn\" onclick=\"showGoals()\">Project Goals</button>\n            <button class=\"btn\" onclick=\"showWhy()\">Why???</button>\n            \n            <div style=\"position: relative; display: inline-block;\">\n                <button class=\"btn\" onclick=\"toggleLanguageSelector()\" id=\"langSelectorBtn\">Languages \u25BE</button>\n                <div id=\"language-selector-dropdown\" style=\"display: none; position: absolute; top: 100%; left: 0; background: #1a1b26; border: 1px solid var(--primary); padding: 10px; z-index: 1000; min-width: 150px; max-height: 300px; overflow-y: auto;\">\n                    <!-- Populated by JS -->\n                </div>\n            </div>\n            \n            <!-- Search Removed -->\n        </div>\n    </div>\n\n    <!-- SVG Filters for Logo Tailoring -->\n    <svg style=\"display: none;\">\n        <defs>\n            <filter id=\"filter-invert\">\n                <feColorMatrix in=\"SourceGraphic\" type=\"matrix\" values=\"-1 0 0 0 1 \n                                                                          0 -1 0 0 1 \n                                                                          0 0 -1 0 1 \n                                                                          0 0 0 1 0\"/>\n            </filter>\n            <filter id=\"filter-transparent-white\">\n                <feColorMatrix in=\"SourceGraphic\" type=\"matrix\" values=\"1 0 0 0 0\n                                                                          0 1 0 0 0\n                                                                          0 0 1 0 0\n                                                                          -1 -1 -1 1 0\"/>\n            </filter>\n        </defs>\n    </svg>\n\n    <div class=\"container\">\n        <table>\n            <thead>\n                <tr>\n                    <th>\n                        Language\n                        <div class=\"sort-group\">\n                            <button class=\"sort-btn\" onclick=\"sortRows('lang', this)\" title=\"Sort by Name\">N</button>\n                            <button class=\"sort-btn\" onclick=\"sortRows('year', this)\" title=\"Sort by Year\">Y</button>\n                        </div>\n                    </th>\n                    <th>\n                        <span id=\"header-score\">Score</span>\n                        <div class=\"sort-group\">\n                            <button class=\"sort-btn\" onclick=\"sortRows('score', this)\" title=\"Sort by Score\">S</button>\n                        </div>\n                    </th>\n                    <th>\n                        Updated\n                        <div class=\"sort-group\">\n                             <button class=\"sort-btn\" onclick=\"sortRows('timestamp', this)\" title=\"Sort by Age\">A</button>\n                        </div>\n                    </th>");
                    for (i = 0; i < maxMatrices; i++) {
                        html += "<th>\n            Matrix ".concat(i + 1, "\n            <div class=\"sort-group\">\n                <button class=\"sort-btn sort-time\" onclick=\"sortMatrix(").concat(i, ", 'time', this)\" title=\"Sort by Time\">S</button>\n                <button class=\"sort-btn sort-iters\" onclick=\"sortMatrix(").concat(i, ", 'iters', this)\" title=\"Sort by Iterations\">I</button>\n                <button class=\"sort-btn sort-mem\" onclick=\"sortMatrix(").concat(i, ", 'mem', this)\" title=\"Sort by Memory\">M</button>\n                <button class=\"sort-btn sort-score\" onclick=\"sortMatrix(").concat(i, ", 'score', this)\" title=\"Sort by Score\">Sc</button>\n            </div>\n        </th>");
                    }
                    html += "<th>\n        <span>Compiler</span>\n        <div class=\"sort-group\">\n            <button class=\"sort-btn\" onclick=\"sortRows('compiler', this)\" title=\"Sort by Compiler\">C</button>\n        </div>\n    </th>\n    <th>\n        <span>Mem Peak</span>\n        <div class=\"sort-group\">\n            <button class=\"sort-btn\" onclick=\"sortRows('memory', this)\" title=\"Sort by Memory\">M</button>\n        </div>\n    </th>\n    <th>\n        <span id=\"header-time\">Total Time</span>\n        <div class=\"sort-group\">\n            <button class=\"sort-btn\" onclick=\"sortRows('time', this)\" title=\"Sort by Total Time\">S</button>\n        </div>\n    </th>\n    <th>\n        <span>Status</span>\n    </th>\n    </tr></thead><tbody>";
                    _loop_1 = function (m) {
                        var lang = m.solver;
                        var times = m.results.map(function (r) { return r.time; });
                        var iters = m.results.map(function (r) { return r.iterations; });
                        var mems = m.results.map(function (r) { return r.memory || 0; }).filter(function (m) { return !isNaN(m); });
                        var totalTime = times.reduce(function (a, b) { return a + b; }, 0);
                        var totalIters = iters.reduce(function (a, b) { return a + b; }, 0);
                        var maxMem = mems.length > 0 ? Math.max.apply(Math, mems) : 0;
                        // Efficiency Score: Memory (MB) / Seconds
                        var memMbTotal = maxMem / 1024 / 1024;
                        var efficiencyScore = totalTime > 0 ? memMbTotal / totalTime : 0;
                        // Composite Score (vs C) - Geometric Mean
                        //  = (_time  _mem  _iter  _cpu)^(1/4)
                        // Floor values at 0.001 to avoid zero/negative issues
                        var totalCpu = m.results.reduce(function (a, b) { return a + b.cpu_user + b.cpu_sys; }, 0);
                        var timeRatio = Math.max(0.001, (cTotalTime > 0) ? (totalTime / cTotalTime) : 1);
                        var memRatio = Math.max(0.001, (cTotalMem > 0) ? (maxMem / cTotalMem) : 1);
                        var cpuRatio = Math.max(0.001, (cTotalCpu > 0) ? (totalCpu / cTotalCpu) : 1);
                        var iterRatio = Math.max(0.001, (cTotalIters > 0) ? (totalIters / cTotalIters) : 1);
                        // Geometric mean: 4th root of product of all ratios
                        var normalizedScore = Math.pow(timeRatio * memRatio * cpuRatio * iterRatio, 0.25);
                        // Find min/max for highlighting
                        var minTime = Math.min.apply(Math, sortedMetrics.map(function (m) { return m.results.reduce(function (a, b) { return a + b.time; }, 0); }));
                        var maxTime = Math.max.apply(Math, sortedMetrics.map(function (m) { return m.results.reduce(function (a, b) { return a + b.time; }, 0); }));
                        var isFastest = totalTime === minTime;
                        var isSlowest = totalTime === maxTime;
                        // Suspect Logic - Check against configured expected matrices
                        var langConfig = (_c = benchmarkConfig === null || benchmarkConfig === void 0 ? void 0 : benchmarkConfig.languages) === null || _c === void 0 ? void 0 : _c[lang];
                        var expectedMatrixCount = ((_d = langConfig === null || langConfig === void 0 ? void 0 : langConfig.matrices) === null || _d === void 0 ? void 0 : _d.length) || maxMatrices;
                        var isSuspect = m.results.length < expectedMatrixCount;
                        // Iteration Mismatch Logic
                        // Iteration Mismatch Logic
                        // Calculate expected iterations based on the matrices this solver successfully ran
                        var expectedIters = 0;
                        if (cMetrics) {
                            m.results.forEach(function (r) {
                                var cRes = cMetrics.results.find(function (cm) { return cm.matrix === r.matrix; });
                                if (cRes)
                                    expectedIters += Number(cRes.iterations);
                            });
                        }
                        // Baseline is C (Local)
                        var isBaseline = m.solver === 'C' && (m.runType === 'Local' || !m.runType);
                        var isMismatch = !isBaseline && expectedIters > 0 && totalIters !== expectedIters;
                        var rowClass = "";
                        if (isSuspect)
                            rowClass += " suspect";
                        if (isMismatch)
                            rowClass += " mismatch-iterations";
                        // Quote
                        var baseLang = lang; // lang is already clean now
                        var runType = m.runType || 'Local';
                        var quote = personalities['Standard'][baseLang] || personalities['Standard'][lang] || "A mystery wrapped in code.";
                        var safeQuote = quote.replace(/'/g, "&apos;") + " Efficiency: ".concat(efficiencyScore.toFixed(2), " MB/s");
                        // Metadata
                        var meta = languageMetadata[baseLang] || languageMetadata[lang] || {};
                        var year = meta.date || "0000";
                        var displayNameRaw = lang === "C_Sharp" ? "C#" : (lang === "F_Sharp" ? "F#" : lang);
                        var displayName = displayNameRaw;
                        var typeIcon = '';
                        if (runType === 'Docker') {
                            typeIcon = '<span title="Docker Container" style="margin-left:5px; font-size: 0.8em;"></span>';
                        }
                        else if (runType === 'AI') {
                            typeIcon = '<span class="ai-tag" title="AI Generated">(AI)</span>';
                        }
                        else {
                            typeIcon = '<span title="Local Run" style="margin-left:5px; font-size: 0.8em;"></span>';
                        }
                        var historyText = (LanguagesMetadata_ts_1.languageHistories[baseLang] || LanguagesMetadata_ts_1.languageHistories[lang] || "Unknown.").replace(/'/g, "&apos;");
                        var localLogo = logoMap.get(baseLang.toLowerCase());
                        var logoUrl = localLogo || meta.logo || meta.image;
                        // Data Attributes
                        var matrixDataAttrs = "";
                        var _loop_2 = function (i) {
                            var r = m.results.find(function (res) { return res.matrix === "".concat(i + 1, ".matrix"); });
                            var t = r ? r.time : 999999;
                            var it = r ? r.iterations : -1;
                            var mem = r ? r.memory : -1;
                            var score = 0;
                            if (r && cTimes[i] && cTimes[i] > 0) {
                                score = t / cTimes[i];
                            }
                            matrixDataAttrs += " data-m".concat(i, "-time='").concat(t, "' data-m").concat(i, "-iters='").concat(it, "' data-m").concat(i, "-mem='").concat(mem, "' data-m").concat(i, "-score='").concat(score.toFixed(2), "'");
                        };
                        for (var i = 0; i < maxMatrices; i++) {
                            _loop_2(i);
                        }
                        // Calculate compiler info early for row data attribute
                        var rowCompilerInfo = meta.compiler || compilerMapping[baseLang] || compilerMapping[lang] || '-';
                        html += "<tr class=\"".concat(rowClass, " ").concat(isFastest ? 'fastest-row' : '', " ").concat(isSlowest ? 'slowest-row' : '', "\"\n            data-lang=\"").concat(lang, "\"\n            data-timestamp=\"").concat(new Date(m.timestamp).getTime(), "\"\n            data-year=\"").concat(year, "\"\n            data-time=\"").concat(totalTime < 0.0001 && totalTime > 0 ? totalTime.toExponential(2) : totalTime.toFixed(6), "\"\n            data-iters=\"").concat(totalIters, "\"\n            data-mem=\"").concat(maxMem, "\"\n            data-memory=\"").concat(maxMem, "\"\n            data-compiler=\"").concat(rowCompilerInfo, "\"\n            data-score=\"").concat(normalizedScore.toFixed(2), "\"\n            data-score-breakdown=\"Time: ").concat(timeRatio.toFixed(2), "x | Mem: ").concat(memRatio.toFixed(2), "x | CPU: ").concat(cpuRatio.toFixed(2), "x\"\n            data-quote=\"").concat(quote, "\" data-history='").concat(historyText, "' ").concat(matrixDataAttrs, ">\n            <td class='lang-col'>\n                <span class=\"expand-chevron\">\u203A</span>\n                ").concat(logoUrl ? "<img src=\"".concat(logoUrl, "\" alt=\"").concat(displayNameRaw, "\" class=\"lang-logo\">") : '', "\n                <div style=\"display: inline-block; vertical-align: middle;\">\n                    <div>\n                        ").concat(displayName).concat(typeIcon, "\n                    </div>\n                    <div class='lang-year'>").concat(year, "</div>\n                </div>\n            </td>\n            <td class=\"score-col\">\n                <div class=\"total-score\" style=\"text-align: center; color: ").concat(normalizedScore <= 1.0 ? 'var(--primary)' : '#ff0055', ";\">\n                    ").concat(normalizedScore.toFixed(2), "\n                </div>\n            </td>\n            <td>\n                <div style=\"text-align: center; color: var(--secondary); font-size: 0.9em;\">\n                    ").concat((function () {
                            var dateDiff = Date.now() - new Date(m.timestamp).getTime();
                            if (dateDiff > 86400000)
                                return Math.floor(dateDiff / 86400000) + "d ago";
                            if (dateDiff > 3600000)
                                return Math.floor(dateDiff / 3600000) + "h ago";
                            if (dateDiff > 60000)
                                return Math.floor(dateDiff / 60000) + "m ago";
                            return "Just now";
                        })(), "\n                </div>\n            </td>");
                        var _loop_3 = function (i) {
                            var r = m.results[i];
                            if (r) {
                                var memMb = r.memory / 1024 / 1024;
                                var scoreDisplay = "";
                                if (cTimes[i] && cTimes[i] > 0) {
                                    var scoreVal = r.time / cTimes[i];
                                    scoreDisplay = "".concat(scoreVal.toFixed(2), "x");
                                }
                                html += "<td class=\"matrix-cell\" data-matrix-index=\"".concat(i, "\">\n                    <div class=\"cell-content\">\n                        <div class=\"cell-header\">\n                             <button class=\"run-btn\" onclick=\"runSolver('").concat(lang, "', '").concat(i + 1, ".matrix', event)\" title=\"Run Matrix ").concat(i + 1, "\">\u23F5</button>\n                             <div class=\"time\" title=\"Wall Clock Time\">").concat(r.time != null ? (r.time === 0 ? '<0.001' : (r.time < 0.0001 ? r.time.toExponential(2) : r.time.toFixed(5))) : '-', "s</div>\n                        </div>\n                        <div class=\"meta\">\n                            ").concat((function () {
                                    var cRes = cMetrics === null || cMetrics === void 0 ? void 0 : cMetrics.results.find(function (res) { return res.matrix === r.matrix; });
                                    var cIterations = cRes ? cRes.iterations : null;
                                    // Ensure strict number comparison and handle potential type issues if JSON parsing was loose
                                    var rIter = Number(r.iterations);
                                    var cIter = Number(cIterations);
                                    var isBaseline = m.solver === 'C' && (m.runType === 'Local' || !m.runType);
                                    var isMismatch = !isBaseline && cIterations !== null && rIter !== cIter;
                                    return "<span title=\"Iterations: ".concat(rIter, " vs C: ").concat(cIter, "\" class=\"").concat(isMismatch ? 'mismatch' : '', "\">#").concat(r.iterations, "</span>");
                                })(), "\n                            <span title=\"Memory\">").concat(memMb.toFixed(1), "M</span>\n                        </div>\n                    </div>\n                </td>");
                            }
                            else {
                                html += "<td class=\"matrix-cell\" data-matrix-index=\"".concat(i, "\"><span style='color: #333'>-</span></td>");
                            }
                        };
                        for (var i = 0; i < maxMatrices; i++) {
                            _loop_3(i);
                        }
                        // Memory peak - format KB or MB
                        var peakMemoryKB = maxMem / 1024; // Convert bytes to KB
                        var memDisplay = peakMemoryKB > 1024
                            ? "".concat((peakMemoryKB / 1024).toFixed(1), "MB")
                            : "".concat(peakMemoryKB.toFixed(0), "KB");
                        // Memory color coding
                        var memColorClass = peakMemoryKB > 10240 ? 'color: #ff6b6b' :
                            peakMemoryKB > 2048 ? 'color: var(--secondary)' :
                                'color: var(--primary)';
                        html += "<td class=\"compiler-col\" data-compiler=\"".concat(rowCompilerInfo, "\">\n            <div style=\"text-align: center; font-size: 0.85em; color: var(--muted);\">\n                ").concat(rowCompilerInfo, "\n            </div>\n        </td>");
                        html += "<td class=\"memory-col\" data-memory=\"".concat(maxMem, "\">\n            <div style=\"text-align: center; font-size: 0.85em; ").concat(memColorClass, "\">\n                ").concat(memDisplay, "\n            </div>\n        </td>");
                        html += "<td class='total-time'><div style='display:flex;flex-direction:column;align-items:flex-end;'><div style=\"display:flex;align-items:center;gap:5px;\"><button class=\"run-btn\" onclick=\"runAllSolver('".concat(lang, "', event)\" title=\"Run All Matrices\">\u23E9</button><div>").concat(totalTime.toFixed(3), "s</div></div><div style='font-size:0.6em;color:#5c5c66;'>").concat(totalIters.toLocaleString(), " iters</div></div></td></tr>");
                        // Add expanded content row
                        var totalCols = 3 + maxMatrices + 3; // Language + Score + Updated + Matrices + Compiler + MemPeak + Total
                        html += "<tr class=\"expanded-content\">\n            <td colspan=\"".concat(totalCols, "\">\n                <div class=\"expanded-sections\">\n                    <div class=\"expanded-section\">\n                        <div class=\"section-title\">System</div>\n                        <div class=\"section-content\">OS: - | CPU: - | RAM: - | Arch: -</div>\n                    </div>\n                    <div class=\"expanded-section\">\n                        <div class=\"section-title\">Compilation</div>\n                        <div class=\"section-content\">Compiler: ").concat(rowCompilerInfo, " | Flags: - | Level: -</div>\n                    </div>\n                    <div class=\"expanded-section\">\n                        <div class=\"section-title\">Matrix Results</div>\n                        <div class=\"section-content\">\n                            ").concat(m.results.filter(function (r) { return r != null; }).map(function (r, idx) {
                            var memMb = (r.memory || 0) / 1024 / 1024;
                            var time = r.time || 0;
                            var iterations = r.iterations || 0;
                            return "M".concat(idx + 1, ": ").concat(time.toFixed(3), "s, ").concat(iterations.toLocaleString(), " iter, ").concat(memMb.toFixed(1), "MB");
                        }).join(' | '), "\n                        </div>\n                    </div>\n                </div>\n            </td>\n        </tr>");
                    };
                    for (_b = 0, sortedMetrics_1 = sortedMetrics; _b < sortedMetrics_1.length; _b++) {
                        m = sortedMetrics_1[_b];
                        _loop_1(m);
                    }
                    html += "\n        </tbody></table></div>\n        <script>\n            // Static Data\n            const personalities = ".concat(safeJSON(personalities), ";\n            const narratorIntros = ").concat(safeJSON(LanguagesMetadata_ts_1.narratorIntros), ";\n            const languageMetadata = ").concat(safeJSON(languageMetadata), ";\n            const methodologyTexts = ").concat(safeJSON(methodologyTexts), ";\n            const mismatchLabels = ").concat(safeJSON(LanguagesMetadata_ts_1.mismatchLabels), ";\n            const iterationLabels = ").concat(safeJSON(LanguagesMetadata_ts_1.iterationLabels), ";\n            const timeLabels = ").concat(safeJSON(LanguagesMetadata_ts_1.timeLabels), ";\n            const memoryLabels = ").concat(safeJSON(LanguagesMetadata_ts_1.memoryLabels), ";\n            const scoreLabels = ").concat(safeJSON(LanguagesMetadata_ts_1.scoreLabels), ";\n\n            // Dynamic Data\n            const historyData = ").concat(safeJSON(history), ";\n            const referenceOutputs = ").concat(safeJSON(referenceOutputs), ";\n            const tailoring = ").concat(safeJSON(tailoringConfig), ";\n            const metricsData = ").concat(safeJSON(metrics.map(function (m) {
                        var baseLang = m.solver.replace(/ \((AI)\)$/, '');
                        var localLogo = logoMap.get(baseLang.toLowerCase());
                        var meta = languageMetadata[baseLang] || languageMetadata[m.solver] || {};
                        return __assign(__assign({}, m), { logo: localLogo || meta.logo || meta.image || "https://upload.wikimedia.org/wikipedia/commons/thumb/d/db/Alchemist_symbol_for_process_2.svg/120px-Alchemist_symbol_for_process_2.svg.png" });
                    })), ";\n            const matrixPuzzles = ").concat(safeJSON(matrixContents), ";\n        </script>\n    ");
                    generatedAt = new Date().toLocaleString('en-GB', {
                        timeZone: 'Europe/Berlin',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    html += "\n    <footer style=\"text-align: right; padding: 20px 40px; color: #666; font-size: 12px; border-top: 1px solid #333; margin-top: 40px;\">\n        Report generated: ".concat(generatedAt, " CET\n    </footer>\n    <script src=\"../Metrics/report_client.js\"></script>\n    </body>\n    </html>\n    ");
                    return [2 /*return*/, html];
            }
        });
    });
}
function generateHistoryHtml(history) {
    var rows = history.flatMap(function (h) {
        return h.results.map(function (r) { return ({
            timestamp: h.timestamp,
            solver: h.solver,
            matrix: r.matrix,
            time: r.time,
            iterations: r.iterations,
            status: r.status
        }); });
    });
    // Sort by timestamp desc
    rows.sort(function (a, b) { return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime(); });
    return "\n    <!DOCTYPE html>\n    <html>\n    <head>\n        <title>Benchmark History</title>\n        <style>\n            body { font-family: 'JetBrains Mono', monospace; background: #0d0d12; color: #e0e0e0; padding: 20px; }\n            table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }\n            th, td { border: 1px solid #2a2a35; padding: 4px 8px; text-align: left; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }\n            th { background: #1a1a20; color: #00ff9d; cursor: pointer; user-select: none; }\n            th:hover { background: #2a2a35; color: #fff; }\n            tr:nth-child(even) { background: #16161e; }\n            h1 { color: #00ff9d; font-family: 'JetBrains Mono'; text-transform: uppercase; letter-spacing: 2px; }\n            .status-failure, .status-error, .status-suspect { color: #ff0055; font-weight: bold; }\n            .status-optimized { color: #00b8ff; }\n            \n            /* Matrix Timing Style for Time Column */\n            .time-val { font-size: 1.1em; font-weight: bold; color: #fff; font-family: 'JetBrains Mono', monospace; }\n        </style>\n        <script>\n            function sortTable(n) {\n                var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;\n                table = document.querySelector(\"table\");\n                switching = true;\n                dir = \"asc\";\n                while (switching) {\n                    switching = false;\n                    rows = table.rows;\n                    for (i = 1; i < (rows.length - 1); i++) {\n                        shouldSwitch = false;\n                        x = rows[i].getElementsByTagName(\"TD\")[n];\n                        y = rows[i + 1].getElementsByTagName(\"TD\")[n];\n                        var xContent = x.innerText.toLowerCase();\n                        var yContent = y.innerText.toLowerCase();\n                        if (!isNaN(parseFloat(xContent)) && !isNaN(parseFloat(yContent))) {\n                             xContent = parseFloat(xContent);\n                             yContent = parseFloat(yContent);\n                        }\n                        if (dir == \"asc\") {\n                            if (xContent > yContent) { shouldSwitch = true; break; }\n                        } else if (dir == \"desc\") {\n                            if (xContent < yContent) { shouldSwitch = true; break; }\n                        }\n                    }\n                    if (shouldSwitch) {\n                        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);\n                        switching = true;\n                        switchcount ++;\n                    } else {\n                        if (switchcount == 0 && dir == \"asc\") {\n                            dir = \"desc\";\n                            switching = true;\n                        }\n                    }\n                }\n            }\n        </script>\n    </head>\n    <body>\n        <h1>Benchmark History</h1>\n        <table>\n            <thead>\n                <tr>\n                    <th onclick=\"sortTable(0)\" style=\"width: 200px;\">Timestamp \u2195</th>\n                    <th onclick=\"sortTable(1)\">Solver \u2195</th>\n                    <th onclick=\"sortTable(2)\">Matrix \u2195</th>\n                    <th onclick=\"sortTable(3)\">Time (s) \u2195</th>\n                    <th onclick=\"sortTable(4)\">Iterations \u2195</th>\n                    <th onclick=\"sortTable(5)\">Status \u2195</th>\n                </tr>\n            </thead>\n            <tbody>\n                ".concat(rows.map(function (r) {
        var _a, _b;
        return "\n                    <tr>\n                        <td>".concat(new Date(r.timestamp).toLocaleString(), "</td>\n                        <td style=\"color: var(--primary); font-weight: bold;\">").concat(r.solver, "</td>\n                        <td>").concat(r.matrix, "</td>\n                        <td class=\"time-val\">").concat(((_a = r.time) !== null && _a !== void 0 ? _a : 0).toFixed(4), "</td>\n                        <td>").concat((_b = r.iterations) !== null && _b !== void 0 ? _b : '-', "</td>\n                        <td class=\"status-").concat((r.status || 'unknown').toLowerCase(), "\">").concat(r.status || '-', "</td>\n                    </tr>\n                ");
    }).join(''), "\n            </tbody>\n        </table>\n    </body>\n    </html>\n    ");
}
