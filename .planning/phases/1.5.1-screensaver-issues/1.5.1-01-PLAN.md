---
phase: 1.5.1-screensaver-issues
plan: 01
type: execute
---

<objective>
Fix the screensaver bounce issue that occurs when auto-triggered by idle timeout.

Purpose: The screensaver causes chart and table to bounce up/down when auto-triggered (but not when manually triggered via pills). This degrades the user experience.

Output: Smooth screensaver transition for both auto-trigger and manual trigger scenarios.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Issue:**
When the screensaver auto-triggers after 5 minutes of idle time, it causes the chart and table to bounce. Manual pill clicks work smoothly. The code already has a comment acknowledging this: "User complained about bounce, likely due to scroll position restoration or layout shift."

**Root cause:**
1. `body.fullscreen-active` adds `overflow: hidden` which can cause scroll jump
2. Auto-trigger lacks the `event.stopPropagation()` context that manual clicks have
3. No scroll position management before/after screensaver activation
4. DOM manipulation (moving canvas to body) during transition causes reflow

**Relevant files:**
@Metrics/report_client.js (lines 2767-2945: startScreensaver/stopScreensaver functions)
@Metrics/index.css (line 22: body.fullscreen-active)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix screensaver bounce on auto-trigger</name>
  <files>Metrics/report_client.js</files>
  <action>
Modify the startScreensaver and stopScreensaver functions to properly manage scroll position and prevent bounce:

1. In startScreensaver(), BEFORE any DOM changes:
   - Save current scroll position: `const savedScrollX = window.scrollX; const savedScrollY = window.scrollY;`
   - Store in module-level variables for restoration later
   - Scroll to top: `window.scrollTo(0, 0)` BEFORE adding fullscreen-active class

2. In startScreensaver(), ensure proper order:
   - Save scroll position first
   - Scroll to (0,0)
   - Then add fullscreen-active class to body
   - Then move canvas to body
   - Then start animations

3. In stopScreensaver(), restore scroll position:
   - Remove fullscreen-active class
   - Exit browser fullscreen
   - Then restore saved scroll position: `window.scrollTo(savedScrollX, savedScrollY)`

4. Add module-level variables at the top of the IIFE (around line 2264):
   ```javascript
   let savedScrollX = 0;
   let savedScrollY = 0;
   ```

5. Consider using `scrollBehavior: 'instant'` to avoid any animated scroll that could cause visual issues.

WHY: The bounce happens because overflow:hidden is applied while the page has a scroll offset, causing the content to jump. By scrolling to top first, then applying the class, we prevent the jump.
  </action>
  <verify>
- Code review: startScreensaver saves scroll position and scrolls to (0,0) before fullscreen-active class
- Code review: stopScreensaver restores scroll position after cleanup
- No syntax errors: `node --check Metrics/report_client.js` (or inspect for obvious issues)
  </verify>
  <done>
- Scroll position saved before screensaver starts
- Page scrolled to top before fullscreen-active applied
- Scroll position restored after screensaver stops
- Code compiles without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed screensaver bounce by managing scroll position during transitions</what-built>
  <how-to-verify>
    1. Start the server: `docker-compose up -d` or access the running instance
    2. Open the benchmark report in browser at localhost:9001
    3. Scroll down the page so the table is partially visible
    4. Wait 5+ minutes for auto-trigger OR temporarily reduce idle timeout for testing

    **Quick test method (recommended):**
    - Open browser console
    - Scroll to middle of page
    - Run: `window.startScreensaver('red')`
    - Verify: No bounce/jump when screensaver starts
    - Press Alt to exit
    - Verify: Page returns to previous scroll position smoothly

    5. Test manual pill click (blue and red) - should still work smoothly
    6. Confirm no bounce or jarring movement in any scenario
  </how-to-verify>
  <resume-signal>Type "approved" if screensaver transitions are smooth, or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Screensaver auto-trigger does not cause bounce
- [ ] Manual pill clicks still work smoothly
- [ ] Scroll position is restored after exiting screensaver
- [ ] No JavaScript errors in console
- [ ] Both red pill (fullscreen) and blue pill (chart) modes work
</verification>

<success_criteria>
- Auto-triggered screensaver transitions smoothly without bounce
- Manual pill triggers continue to work smoothly
- Scroll position preserved and restored correctly
- No regression in existing screensaver functionality
</success_criteria>

<output>
After completion, create `.planning/phases/1.5.1-screensaver-issues/1.5.1-01-SUMMARY.md`
</output>
