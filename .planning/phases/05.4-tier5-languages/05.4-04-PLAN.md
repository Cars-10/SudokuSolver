---
phase: 05.4-tier5-languages
plan: 04
type: execute
---

<objective>
Implement Icon and Fennel Sudoku solvers with exact algorithm match and C reference output format.

Purpose: Add goal-directed (Icon) and Lua Lisp (Fennel) languages to the Tier 5 benchmark suite
Output: Working Icon and Fennel solvers passing all 5 matrix validations with exact iteration counts
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Reference implementation:**
@Languages/C/Sudoku.c

**Reference iteration counts:**
- Matrix 1: 656
- Matrix 2: 439,269
- Matrix 3: 98,847
- Matrix 4: 9,085
- Matrix 5: 445,778

**Language notes:**

**Icon:**
- Goal-directed evaluation with generators
- Unique evaluation model (success/failure)
- Available via apt: `apt install icont iconx icon-ipl`
- Run with: `icon Sudoku.icn` or `icont -o sudoku Sudoku.icn && ./sudoku`
- Official: https://www2.cs.arizona.edu/icon/

**Fennel:**
- Lisp that compiles to Lua
- Clean macro system, embeddable
- Available via apt: `apt install fennel` (requires Lua)
- Run with: `fennel Sudoku.fnl` or compile then run Lua
- Official: https://fennel-lang.org/

**Critical algorithm requirement:**
```c
for (int val = 1; val <= 9; val++) {
    count++;  // COUNT BEFORE validity check
    if (isValid(row, col, val)) { ... }
}
```

**Output format must match C exactly:**
```
../Matrices/1.matrix
0 0 0 0 0 0 6 0 0
...
Puzzle:
4 8 9 ...
Solved in Iterations=656
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Icon toolchain to Dockerfile</name>
  <files>server/Dockerfile</files>
  <action>
    1. Add Icon language section (apt package):
       ```dockerfile
       # ----------------------------------------------------------------------------
       # 55. Icon
       # ----------------------------------------------------------------------------
       RUN apt-get update && apt-get install -y \
           icont \
           iconx \
           icon-ipl \
           && rm -rf /var/lib/apt/lists/*
       # icon -version (or icont -version)
       ```

    2. Rebuild Docker image:
       ```bash
       docker-compose down
       docker-compose build --no-cache app
       docker-compose up -d
       ```

    3. Verify Icon is installed:
       ```bash
       docker exec sudokusolver-app-1 bash -c 'echo "procedure main(); write(\"Icon works\"); end" > /tmp/test.icn && icont -o /tmp/test /tmp/test.icn && /tmp/test'
       ```
  </action>
  <verify>
    docker exec sudokusolver-app-1 icont -version || docker exec sudokusolver-app-1 which icont
  </verify>
  <done>Icon toolchain available in Docker container</done>
</task>

<task type="auto">
  <name>Task 2: Implement Icon solver</name>
  <files>Languages/Icon/Sudoku.icn, Languages/Icon/runMe.sh, Languages/Icon/README.md</files>
  <action>
    1. Create Languages/Icon directory if not exists

    2. Create Sudoku.icn following C algorithm exactly:
       - Icon uses goal-directed evaluation
       - IMPORTANT: Avoid using Icon's generator model for the loop - use explicit iteration
       - Key syntax patterns:
       ```icon
       global puzzle, count

       procedure main(args)
           filename := args[1]
           puzzle := list(9)
           every i := 1 to 9 do puzzle[i] := list(9, 0)
           count := 0

           # Read file and populate puzzle
           read_file(filename)

           # Print input
           print_puzzle()

           # Solve
           solve()

           # Print solution
           write("\nPuzzle:")
           print_puzzle()
           write("Solved in Iterations=", count)
       end

       procedure is_valid(row, col, val)
           # Check row
           every i := 1 to 9 do
               if puzzle[row][i] = val then fail
           # Check column
           every i := 1 to 9 do
               if puzzle[i][col] = val then fail
           # Check 3x3 box
           box_row := ((row - 1) / 3) * 3 + 1
           box_col := ((col - 1) / 3) * 3 + 1
           every i := 0 to 2 do
               every j := 0 to 2 do
                   if puzzle[box_row + i][box_col + j] = val then fail
           return  # Success
       end

       procedure solve()
           # Find empty cell (row-major)
           every row := 1 to 9 do {
               every col := 1 to 9 do {
                   if puzzle[row][col] = 0 then {
                       every val := 1 to 9 do {
                           count +:= 1  # COUNT BEFORE is_valid
                           if is_valid(row, col, val) then {
                               puzzle[row][col] := val
                               if solve() then return
                               puzzle[row][col] := 0
                           }
                       }
                       fail  # Backtrack
                   }
               }
           }
           return  # Solved (no empty cells)
       end
       ```

    3. Handle file reading and output format matching C

    4. Create runMe.sh:
       ```bash
       #!/bin/bash
       LANGUAGE="Icon"
       source ../common.sh
       # Compile first, then run
       icont -o sudoku Sudoku.icn 2>/dev/null
       run_benchmark "./sudoku"
       ```

    5. Create README.md
  </action>
  <verify>
    docker exec sudokusolver-app-1 bash -c "cd /app/Languages/Icon && icont -o sudoku Sudoku.icn && ./sudoku /app/Matrices/1.matrix" | grep "Iterations=656"
  </verify>
  <done>Icon solver matches C reference for Matrix 1 (656 iterations)</done>
</task>

<task type="auto">
  <name>Task 3: Add Fennel toolchain and implement solver</name>
  <files>server/Dockerfile, Languages/Fennel/Sudoku.fnl, Languages/Fennel/runMe.sh, Languages/Fennel/README.md</files>
  <action>
    1. Add Fennel to Dockerfile (requires Lua):
       ```dockerfile
       # ----------------------------------------------------------------------------
       # 56. Fennel (requires Lua - already have lua5.4)
       # ----------------------------------------------------------------------------
       RUN apt-get update && apt-get install -y \
           fennel \
           && rm -rf /var/lib/apt/lists/*
       # fennel --version
       ```

       Note: If fennel package not available, install via:
       ```dockerfile
       RUN curl -L https://fennel-lang.org/downloads/fennel-1.4.2 \
           -o /usr/local/bin/fennel \
           && chmod +x /usr/local/bin/fennel
       ```

    2. Rebuild Docker image

    3. Create Languages/Fennel directory

    4. Create Sudoku.fnl following C algorithm:
       - Fennel is a Lisp that compiles to Lua
       - Uses Lua tables for arrays (1-indexed)
       - Key syntax patterns:
       ```fennel
       (var puzzle {})
       (var count 0)

       (fn is-valid [row col val]
         ;; Check row
         (var valid true)
         (for [i 1 9]
           (when (= (. (. puzzle row) i) val)
             (set valid false)))
         (when valid
           ;; Check column
           (for [i 1 9]
             (when (= (. (. puzzle i) col) val)
               (set valid false))))
         (when valid
           ;; Check 3x3 box
           (local box-row (+ (* (// (- row 1) 3) 3) 1))
           (local box-col (+ (* (// (- col 1) 3) 3) 1))
           (for [i 0 2]
             (for [j 0 2]
               (when (= (. (. puzzle (+ box-row i)) (+ box-col j)) val)
                 (set valid false)))))
         valid)

       (fn solve []
         ;; Find empty cell (row-major)
         (var result true)
         (var found-empty false)
         (for [row 1 9 &until found-empty]
           (for [col 1 9 &until found-empty]
             (when (= (. (. puzzle row) col) 0)
               (set found-empty true)
               (set result false)
               (for [val 1 9 &until result]
                 (set count (+ count 1))  ;; COUNT BEFORE is-valid
                 (when (is-valid row col val)
                   (tset (. puzzle row) col val)
                   (when (solve)
                     (set result true))
                   (when (not result)
                     (tset (. puzzle row) col 0)))))))
         (if found-empty result true))

       ;; Main
       (local filename (. arg 1))
       ;; Read file, solve, print output...
       ```

    5. Create runMe.sh:
       ```bash
       #!/bin/bash
       LANGUAGE="Fennel"
       source ../common.sh
       run_benchmark "fennel Sudoku.fnl"
       ```

    6. Create README.md
  </action>
  <verify>
    docker exec sudokusolver-app-1 bash -c "cd /app/Languages/Fennel && fennel Sudoku.fnl /app/Matrices/1.matrix" | grep "Iterations=656"
  </verify>
  <done>Fennel solver matches C reference for Matrix 1 (656 iterations)</done>
</task>

<task type="auto">
  <name>Task 4: Validate both languages and complete Phase 5.4</name>
  <files>Languages/Icon/metrics.json, Languages/Fennel/metrics.json, .planning/STATE.md</files>
  <action>
    1. Run full validation for Icon:
       ```bash
       cd Languages/Icon && chmod +x runMe.sh
       for m in 1 2 3 4 5; do
           ./runMe.sh /app/Matrices/$m.matrix
       done
       ```

    2. Run full validation for Fennel:
       ```bash
       cd Languages/Fennel && chmod +x runMe.sh
       for m in 1 2 3 4 5; do
           ./runMe.sh /app/Matrices/$m.matrix
       done
       ```

    3. Verify all iteration counts match:
       - Matrix 1: 656
       - Matrix 2: 439,269
       - Matrix 3: 98,847
       - Matrix 4: 9,085
       - Matrix 5: 445,778

    4. If any mismatch, debug and fix

    5. Regenerate benchmark report:
       ```bash
       cd server && npx tsx generate_report_only.ts
       ```

    6. Update STATE.md:
       - Add Tier 5 languages table
       - Update total language count
       - Mark Phase 5.4 as complete

    7. Update both README.md files with validation results

    8. Final verification - count all validated languages:
       ```bash
       ls Languages/*/metrics.json | wc -l
       ```
  </action>
  <verify>
    docker exec sudokusolver-app-1 bash -c "cat /app/Languages/Icon/metrics.json /app/Languages/Fennel/metrics.json 2>/dev/null" | grep -o '"iterations": [0-9]*' | head -10
  </verify>
  <done>Both Icon and Fennel validated on all 5 matrices - Phase 5.4 complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Docker image rebuilt with Icon and Fennel
- [ ] Icon solver: goal-directed evaluation with correct iteration counting
- [ ] Fennel solver: Lisp macros with Lua backend, correct counting
- [ ] Both match all 5 iteration counts (656, 439269, 98847, 9085, 445778)
- [ ] Both runMe.sh scripts follow common.sh pattern
- [ ] Both README.md files document validation status
- [ ] Benchmark report regenerated with new languages
- [ ] STATE.md updated with Tier 5 completion status
</verification>

<success_criteria>
- Icon and Fennel fully validated on all 5 matrices
- Both use established common.sh benchmark pattern
- Documentation complete for both languages
- Phase 5.4 complete with 55 languages total (or fewer if some deferred)
- STATE.md reflects final Tier 5 status
</success_criteria>

<output>
After completion, create `.planning/phases/05.4-tier5-languages/05.4-04-SUMMARY.md`
</output>
