---
phase: 21-performance-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [Metrics/report_client.js]
autonomous: true
---

<objective>
Debug and optimize Matrix Rain screensaver performance to eliminate intermittent blur/slowness.

Purpose: Improve user experience by ensuring smooth animation at 60fps without visual degradation
Output: Optimized Matrix Rain with consistent performance across all browsers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-language-metadata-and-display-fixes/19-02-SUMMARY.md
@.planning/phases/20-algorithm-aware-ui-components/20-02-SUMMARY.md
@Metrics/report_client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Profile Matrix Rain performance and identify bottlenecks</name>
  <files>Metrics/report_client.js</files>
  <action>
    Analyze the Matrix Rain draw() function (lines 3948-4200) to identify performance bottlenecks:
    1. Measure impact of shadow blur operations (ctx.shadowBlur is used extensively for glow effects)
    2. Check canvas clearing strategy (rgba(0,0,0,0.03) with fillRect for trail effect)
    3. Profile puzzle overlay rendering (lines 4047-4200) with font rendering and glow
    4. Identify if the frame skip logic (frame % 2 !== 0) is sufficient

    Common canvas performance issues to check:
    - Excessive shadowBlur recalculations (should batch or minimize)
    - Font changes within draw loop (ctx.font assignments should be minimized)
    - Large fillRect operations with alpha (can be expensive)

    Add performance.now() markers around expensive operations to identify slowest sections.
  </action>
  <verify>Console logs show timing measurements for each section of draw loop</verify>
  <done>Specific bottleneck sections identified with timing data</done>
</task>

<task type="auto">
  <name>Task 2: Optimize identified performance bottlenecks</name>
  <files>Metrics/report_client.js</files>
  <action>
    Based on profiling results, apply optimizations:

    Likely optimizations:
    1. **Reduce shadow blur operations**: Only apply shadow when necessary, reset once instead of multiple times
    2. **Batch font changes**: Set font once per character type instead of per character
    3. **Optimize canvas clearing**: Consider using clearRect with partial updates instead of full fillRect with alpha
    4. **Reduce puzzle overlay complexity**: Simplify glow effects or apply them more selectively
    5. **Add adaptive frame rate**: Skip more frames if performance drops (use performance.now() to detect)
    6. **Cache frequently used values**: Don't recalculate gridHeight, fontSize, etc. every frame

    Optimization strategy:
    - Minimize state changes (shadowBlur, font, fillStyle)
    - Group similar rendering operations
    - Use integer positions to avoid sub-pixel rendering
    - Consider requestIdleCallback for non-critical effects

    Do NOT change visual appearance - only optimize rendering performance while maintaining identical output.
  </action>
  <verify>
    1. Matrix Rain animation runs smoothly with no visible lag
    2. Performance profiling shows reduced time per frame
    3. All visual effects remain identical (glow, trails, puzzles, easter eggs)
  </verify>
  <done>
    - Frame time reduced to consistent 16-20ms (60fps target)
    - No visual regressions
    - Smooth performance on both fullscreen and chart modes
  </done>
</task>

<task type="auto">
  <name>Task 3: Test Matrix Rain performance across scenarios</name>
  <files>Metrics/report_client.js</files>
  <action>
    Manually test the optimized Matrix Rain in multiple scenarios:
    1. Fullscreen mode (Red Mode) - click "Screen Saver" button
    2. Chart integration mode (Blue Mode) - click chart fullscreen button
    3. Long-running test (let run for 5+ minutes to check for memory leaks or degradation)
    4. Mode switching - rapid switches between Red/Blue modes
    5. Browser resize during animation

    Use browser DevTools Performance tab to verify:
    - Consistent frame rate (close to 60fps)
    - No memory leaks (heap size should stabilize)
    - No layout thrashing (should be mostly paint/composite)

    Document any remaining issues or edge cases discovered.
  </action>
  <verify>
    Browser DevTools Performance tab shows:
    - Green line (fps) stays near 60fps
    - No red warnings in timeline
    - Memory usage stable over 5 minutes
  </verify>
  <done>
    Matrix Rain performs smoothly in all tested scenarios with no degradation over time
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Performance profiling identifies and documents bottlenecks
- [ ] Optimizations applied without changing visual appearance
- [ ] Matrix Rain runs at ~60fps consistently
- [ ] No memory leaks or performance degradation over time
- [ ] All modes (Red/Blue) work smoothly
</verification>

<success_criteria>

- Matrix Rain animation runs smoothly without blur or slowness
- Frame rate consistently near 60fps
- Visual effects unchanged (glow, trails, puzzles preserved)
- No performance degradation over extended periods
- Code changes documented with performance measurements
  </success_criteria>

<output>
After completion, create `.planning/phases/21-performance-and-polish/21-01-SUMMARY.md`
</output>
