---
phase: 05.3-tier4-languages
plan: 04
type: execute
---

<objective>
Implement Forth and Smalltalk Sudoku solvers with exact algorithm match and C reference output format.

Purpose: Add classic paradigm languages (stack-based Forth, OOP pioneer Smalltalk) to Tier 4 benchmark
Output: Working Forth and Smalltalk solvers passing all 5 matrix validations with exact iteration counts
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Reference implementation:**
@Languages/C/Sudoku.c

**Existing code directories:**
@Languages/Forth/
@Languages/Smalltalk/

**Reference iteration counts:**
- Matrix 1: 656
- Matrix 2: 439,269
- Matrix 3: 98,847
- Matrix 4: 9,085
- Matrix 5: 445,778

**Language notes:**
- Forth: Stack-based concatenative language from 1970. Uses postfix notation. Data stack + return stack.
- Smalltalk: Pure OOP from Xerox PARC (1972). Everything is an object, message-passing paradigm.
- These are historically significant languages with unique paradigms

**Critical algorithm requirement:**
```c
for (int val = 1; val <= 9; val++) {
    count++;  // COUNT BEFORE validity check
    if (isValid(row, col, val)) { ... }
}
```

**Paradigm challenges:**
- Forth: Must translate recursive backtracking to stack-based operations
- Smalltalk: Must use message-passing style while maintaining exact algorithm
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Forth and Smalltalk to Dockerfile</name>
  <files>server/Dockerfile</files>
  <action>
    1. Add GNU Forth section:
       ```dockerfile
       # ----------------------------------------------------------------------------
       # 40. GNU Forth
       # ----------------------------------------------------------------------------
       RUN apt-get update && apt-get install -y \
           gforth \
           && rm -rf /var/lib/apt/lists/*
       # gforth --version: 0.7.x
       ```

    2. Add GNU Smalltalk section:
       ```dockerfile
       # ----------------------------------------------------------------------------
       # 41. GNU Smalltalk
       # ----------------------------------------------------------------------------
       RUN apt-get update && apt-get install -y \
           gnu-smalltalk \
           && rm -rf /var/lib/apt/lists/*
       # gst --version: 3.2.x
       ```

    3. Rebuild Docker image:
       docker-compose build --no-cache app
  </action>
  <verify>
    docker exec sudokusolver-app-1 bash -c "gforth --version 2>&1 | head -1 && gst --version"
  </verify>
  <done>Forth and Smalltalk toolchains available in Docker</done>
</task>

<task type="auto">
  <name>Task 2: Implement Forth solver</name>
  <files>Languages/Forth/Sudoku.fs, Languages/Forth/runMe.sh, Languages/Forth/README.md</files>
  <action>
    1. Create Sudoku.fs using stack-based paradigm:
       ```forth
       \ Sudoku solver in Forth
       \ Uses standard ANS Forth with gforth extensions

       \ 9x9 puzzle array (81 cells)
       create puzzle 81 cells allot

       variable count
       0 count !

       \ Access puzzle[row][col] - 0-based indexing
       : puzzle@ ( row col -- val ) swap 9 * + cells puzzle + @ ;
       : puzzle! ( val row col -- ) swap 9 * + cells puzzle + ! ;

       \ Check if placing val at (row, col) is valid
       : is-valid ( row col val -- flag )
         >r 2dup  \ save val on return stack, keep row col
         \ Check row
         9 0 do
           over i puzzle@ r@ = if 2drop r> drop false exit then
         loop
         \ Check column
         9 0 do
           dup i rot puzzle@ r@ = if 2drop r> drop false exit then
           rot
         loop
         \ Check 3x3 box
         over 3 / 3 * >r  \ box_row
         dup 3 / 3 * >r   \ box_col
         3 0 do
           3 0 do
             r@ i + r> r@ j + r> puzzle@ r@ = if
               r> r> 2drop 2drop r> drop false exit
             then
             r> r>
           loop
         loop
         r> r> 2drop 2drop r> drop true
       ;

       \ Recursive solve
       : solve ( -- flag )
         \ Find first empty cell
         9 0 do
           9 0 do
             j i puzzle@ 0= if
               \ Try values 1-9
               10 1 do
                 1 count +!  \ COUNT BEFORE validity check
                 j i k is-valid if
                   k j i puzzle!
                   recurse if true unloop unloop exit then
                   0 j i puzzle!
                 then
               loop
               false unloop unloop exit
             then
           loop
         loop
         true  \ Solved - no empty cells
       ;

       \ Main program - read file and solve
       ```

    2. Handle file I/O in Forth (may need gforth extensions)

    3. Output format matching C exactly

    4. Create runMe.sh:
       ```bash
       #!/bin/bash
       LANGUAGE="Forth"
       source ../common.sh
       run_benchmark "gforth Sudoku.fs -e"
       ```

    5. Create README.md documenting stack-based implementation
  </action>
  <verify>
    docker exec sudokusolver-app-1 bash -c "cd /app/Languages/Forth && gforth Sudoku.fs /app/Matrices/1.matrix -e bye" | grep "Iterations=656"
  </verify>
  <done>Forth solver matches C reference for Matrix 1</done>
</task>

<task type="auto">
  <name>Task 3: Implement Smalltalk solver</name>
  <files>Languages/Smalltalk/Sudoku.st, Languages/Smalltalk/runMe.sh, Languages/Smalltalk/README.md</files>
  <action>
    1. Create Sudoku.st using message-passing paradigm:
       ```smalltalk
       "Sudoku solver in GNU Smalltalk"

       Object subclass: Sudoku [
           | puzzle count |

           Sudoku class >> new [
               ^super new init
           ]

           init [
               puzzle := Array new: 9.
               1 to: 9 do: [:i | puzzle at: i put: (Array new: 9 withAll: 0)].
               count := 0.
           ]

           puzzleAt: row at: col [
               ^(puzzle at: row + 1) at: col + 1
           ]

           puzzleAt: row at: col put: val [
               (puzzle at: row + 1) at: col + 1 put: val
           ]

           isValidAt: row at: col with: val [
               "Check row"
               0 to: 8 do: [:i |
                   (self puzzleAt: row at: i) = val ifTrue: [^false]
               ].
               "Check column"
               0 to: 8 do: [:i |
                   (self puzzleAt: i at: col) = val ifTrue: [^false]
               ].
               "Check 3x3 box"
               | br bc |
               br := (row // 3) * 3.
               bc := (col // 3) * 3.
               0 to: 2 do: [:i |
                   0 to: 2 do: [:j |
                       (self puzzleAt: br + i at: bc + j) = val ifTrue: [^false]
                   ]
               ].
               ^true
           ]

           solve [
               0 to: 8 do: [:row |
                   0 to: 8 do: [:col |
                       (self puzzleAt: row at: col) = 0 ifTrue: [
                           1 to: 9 do: [:val |
                               count := count + 1.  "COUNT BEFORE validity check"
                               (self isValidAt: row at: col with: val) ifTrue: [
                                   self puzzleAt: row at: col put: val.
                                   self solve ifTrue: [^true].
                                   self puzzleAt: row at: col put: 0.
                               ]
                           ].
                           ^false
                       ]
                   ]
               ].
               ^true  "Solved"
           ]

           iterations [
               ^count
           ]
       ]

       "Main execution"
       | solver |
       solver := Sudoku new.
       "Read matrix file, solve, print output"
       ```

    2. Handle file I/O in GNU Smalltalk

    3. Output format matching C exactly

    4. Create runMe.sh:
       ```bash
       #!/bin/bash
       LANGUAGE="Smalltalk"
       source ../common.sh
       run_benchmark "gst Sudoku.st"
       ```

    5. Create README.md documenting message-passing style
  </action>
  <verify>
    docker exec sudokusolver-app-1 bash -c "cd /app/Languages/Smalltalk && gst Sudoku.st /app/Matrices/1.matrix" | grep "Iterations=656"
  </verify>
  <done>Smalltalk solver matches C reference for Matrix 1</done>
</task>

<task type="auto">
  <name>Task 4: Validate both languages on all matrices</name>
  <files>Languages/Forth/metrics.json, Languages/Smalltalk/metrics.json</files>
  <action>
    1. Run full validation for Forth:
       cd Languages/Forth && ./runMe.sh /app/Matrices/{1,2,3,4,5}.matrix

    2. Run full validation for Smalltalk:
       cd Languages/Smalltalk && ./runMe.sh /app/Matrices/{1,2,3,4,5}.matrix

    3. Verify all iteration counts match exactly

    4. Regenerate benchmark report

    5. Update README.md files with validation results and paradigm notes
  </action>
  <verify>
    docker exec sudokusolver-app-1 bash -c "cat /app/Languages/Forth/metrics.json /app/Languages/Smalltalk/metrics.json" | grep -o '"iterations": [0-9]*' | head -10
  </verify>
  <done>Both Forth and Smalltalk validated on all 5 matrices</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Docker image rebuilt with GNU Forth and GNU Smalltalk
- [ ] Forth solver uses stack-based operations correctly
- [ ] Smalltalk solver uses message-passing paradigm
- [ ] Both match all 5 iteration counts exactly
- [ ] Both runMe.sh scripts follow common.sh pattern
- [ ] README.md files explain paradigm translations
</verification>

<success_criteria>
- Forth and Smalltalk fully validated on all 5 matrices
- Stack-based and message-passing paradigms demonstrated
- 47 languages total passing validation
</success_criteria>

<output>
After completion, create `.planning/phases/05.3-tier4-languages/05.3-04-SUMMARY.md`
</output>
