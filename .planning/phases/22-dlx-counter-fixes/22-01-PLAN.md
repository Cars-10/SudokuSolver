---
phase: 22-dlx-counter-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [Algorithms/DLX/Clojure/dlx.clj, Algorithms/DLX/Elixir/dlx.exs, Algorithms/DLX/PowerShell/dlx.ps1]
autonomous: true
---

<objective>
Fix DLX implementations with counter/algorithm issues and verify already-fixed implementations.

Purpose: Achieve correct iteration counts (43 for Matrix 1) matching the C reference implementation for all five languages.
Output: All five DLX implementations producing correct iteration counts and solutions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference implementation:
@Algorithms/DLX/C/dlx_core.c
@Algorithms/DLX/C/dlx_sudoku.c

Implementations to fix:
@Algorithms/DLX/Clojure/dlx.clj
@Algorithms/DLX/Elixir/dlx.exs
@Algorithms/DLX/PowerShell/dlx.ps1

Implementations to verify (already working):
@Algorithms/DLX/Haskell/dlx.hs
@Algorithms/DLX/R/dlx.R

Reference iteration counts (from C reference):
- DLX Matrix 1: 43 iterations
- DLX Matrix 2: 111 iterations
- DLX Matrix 3: 131 iterations
- DLX Matrix 4: 70 iterations
- DLX Matrix 5: 1472 iterations
</context>

<current_state>
Based on metrics analysis:

**Already Fixed (verify only):**

1. **Haskell DLX**: ✅ WORKING
   - Latest metrics (2026-01-15) show iterations=43 for Matrix 1
   - Produces correct solutions

2. **R DLX**: ✅ WORKING
   - Latest metrics (2026-01-14) show iterations=43 for Matrix 1
   - All matrices match C reference counts exactly

**Need Fixes:**

3. **Clojure DLX**: ❌ Algorithm doesn't complete
   - Status: "error", iterations=0
   - Output shows puzzle read but no "Solved" message
   - Counter increment exists at line 242

4. **Elixir DLX**: ❌ "No solution found"
   - Status: "success" but says "No solution found", iterations=0
   - DLX matrix structure issue, not counter issue

5. **PowerShell DLX**: ❌ Matrix corruption
   - Debug shows "Chose column C218 with size -1"
   - Column sizes go negative during cover operations
   - Root cause: Cover-Clues covers columns multiple times or incorrectly
</current_state>

<tasks>

<task type="auto">
  <name>Task 1: Verify Haskell and R DLX Working</name>
  <files>Algorithms/DLX/Haskell/metrics.json, Algorithms/DLX/R/metrics.json</files>
  <action>
  Quick verification that both implementations work:

  1. Haskell: Check metrics.json shows iterations=43 for Matrix 1
  2. R: Check metrics.json shows iterations=43 for Matrix 1

  If metrics already confirm, no action needed. Both were fixed after the v1.3 validation report.
  </action>
  <verify>Both metrics.json files show iterations=43 for Matrix 1</verify>
  <done>Haskell and R DLX confirmed working with correct iteration counts</done>
</task>

<task type="auto">
  <name>Task 2: Debug and Fix Clojure DLX</name>
  <files>Algorithms/DLX/Clojure/dlx.clj</files>
  <action>
  The Clojure implementation reads the puzzle but never prints "Solved". Debug:

  1. Check if solve-sudoku! is being called (line 379-392)
  2. Check if dlx-search! returns true (line 239-293)
  3. Look for issues in cover-clues! (line 351-373) - may be covering incorrectly
  4. Verify circular list linking in build-dlx-row! (line 131-154)

  Known issues to check:
  - cover-clues! inner loop may not find matching rows
  - Row ID assignment during matrix building
  - Node linking during horizontal row construction

  Debug approach:
  - Add println statements to trace execution
  - Check if dlx-search! ever returns true
  - Verify cover-clues! covers the correct columns

  Fix the identified issue.
  </action>
  <verify>cd Algorithms/DLX/Clojure && ./runMe.sh ../../Matrices/1.matrix shows "Solved in Iterations=43"</verify>
  <done>Clojure DLX produces correct solution and iteration count</done>
</task>

<task type="auto">
  <name>Task 3: Debug and Fix Elixir DLX</name>
  <files>Algorithms/DLX/Elixir/dlx.exs</files>
  <action>
  The Elixir implementation returns "No solution found" with 0 iterations. Debug:

  1. Check if dlx_search is being called and Agent counter increments
  2. Verify cover_clue_rows is correctly covering clue columns (lines 326-340)
  3. Check column header linking in build_dlx_matrix (lines 363-382)
  4. Verify node insertion into columns in insert_into_column (lines 462-480)

  Known issues to check:
  - ETS node storage may have incorrect indexing
  - Column header circular list may be broken
  - Cover operations may be destroying the matrix incorrectly

  The "No solution found" indicates choose_column finds an empty column early,
  meaning the matrix structure is corrupted or clue covering removes too much.

  Debug approach:
  - Add IO.inspect to trace cover_column operations
  - Verify column sizes after cover_clue_rows
  - Check if root.right == root after covering clues (shouldn't be)

  Fix the identified issue.
  </action>
  <verify>cd Algorithms/DLX/Elixir && ./runMe.sh ../../Matrices/1.matrix shows "Solved in Iterations=43"</verify>
  <done>Elixir DLX produces correct solution and iteration count</done>
</task>

<task type="auto">
  <name>Task 4: Debug and Fix PowerShell DLX</name>
  <files>Algorithms/DLX/PowerShell/dlx.ps1</files>
  <action>
  PowerShell DLX shows "column with size -1" - sizes go negative during cover. Debug:

  Current debug output shows:
  - "DEBUG: Covered 39 clues" - seems high, verify clue count
  - "DEBUG: Chose column C218 with size -1" - negative size = corruption
  - Matrix 1 has ~39 given cells, but each clue covers 4 columns

  Root cause analysis:
  1. Cover-Clues function (line 283-318) loops to find each clue row
  2. Each clue row has 4 nodes, covering 4 columns
  3. Problem: Same columns may be covered multiple times if clue rows share constraints

  Issue location: Cover-Clues calls Cover-Column for all 4 nodes in a clue row,
  but if two clues share a column (e.g., same row constraint), that column gets
  covered twice, causing size to go negative on uncover.

  FIX APPROACH:
  The C reference covers clue rows BEFORE search, and the columns stay covered.
  PowerShell should NOT uncover them. Check if Cover-Column is being called
  correctly - it should remove columns from header list so they're not chosen.

  Debug steps:
  1. Add debug to show which columns are being covered by each clue
  2. Check if any column is covered more than once
  3. Verify column linking after Build-DLXMatrix

  Alternative: The issue may be in Build-DLXMatrix - check if constraint indices
  are calculated correctly (lines 239-242).
  </action>
  <verify>cd Algorithms/DLX/PowerShell && pwsh dlx.ps1 ../../Matrices/1.matrix shows "Solved in Iterations=43"</verify>
  <done>PowerShell DLX produces correct solution and iteration count</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Haskell DLX: metrics.json shows iterations=43 for Matrix 1
- [ ] R DLX: metrics.json shows iterations=43 for Matrix 1
- [ ] Clojure DLX: `./runMe.sh ../../Matrices/1.matrix` shows Iterations=43
- [ ] Elixir DLX: `./runMe.sh ../../Matrices/1.matrix` shows Iterations=43
- [ ] PowerShell DLX: `pwsh dlx.ps1 ../../Matrices/1.matrix` shows Iterations=43
- [ ] All five produce correct solved puzzles (not just iteration count)
</verification>

<success_criteria>
- All five DLX implementations (Haskell, R, Clojure, Elixir, PowerShell) produce correct solutions
- All five show 43 iterations for Matrix 1
- Fixes committed with descriptive messages
- Metrics files updated (via running benchmarks)
</success_criteria>

<output>
After completion, create `.planning/phases/22-dlx-counter-fixes/22-01-SUMMARY.md`
</output>
