---
phase: 1.5.4-ui-button-handling-language-filtering
plan: 02
type: execute
---

<objective>
Add bulk action controls and visual polish for the lock system.

Purpose: Enable efficient batch operations (run all unlocked, lock validated languages) and provide clear visual feedback.
Output: Bulk action buttons, consistent visual indicators, polished lock UX.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/1.5.4-ui-button-handling-language-filtering/1.5.4-01-SUMMARY.md

**Relevant source files:**
@Metrics/report_client.js
@Metrics/HTMLGenerator.ts

**Prior plan completed:**
- Lock state unified (single toggleLock function)
- Benchmark runner respects locked status
- Session state persistence working

**Current UI locations:**
- Control bar area with existing buttons (Hide Mismatches, etc.)
- Language selector dropdown with lock icons per language
- Modal with lock button
- Table rows with run buttons

**Bulk action needs:**
1. "Run All Unlocked" - run benchmarks for all selected, unlocked languages
2. "Lock All Validated" - quickly lock languages that have passing benchmarks
3. Clear count display: "X locked / Y total"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bulk action controls</name>
  <files>Metrics/HTMLGenerator.ts, Metrics/report_client.js</files>
  <action>
**In HTMLGenerator.ts:**
1. Add bulk action buttons to control bar area (near existing Hide Mismatches button):
   ```html
   <button class="btn" onclick="runAllUnlocked()" title="Run benchmarks for all selected, unlocked languages">
     ‚è© Run Unlocked
   </button>
   <button class="btn" onclick="lockAllValidated()" title="Lock all languages with valid benchmark results">
     üîí Lock Validated
   </button>
   ```

2. Add lock status counter display:
   ```html
   <span id="lock-counter" style="margin-left: 10px; color: #888; font-size: 0.8em;">
     0 locked
   </span>
   ```

**In report_client.js:**
1. Implement window.runAllUnlocked:
   ```javascript
   window.runAllUnlocked = async function() {
       const selected = Array.from(window.selectedLanguages);
       const toRun = selected.filter(lang => !window.lockedLanguages.has(lang));

       if (toRun.length === 0) {
           alert('No unlocked languages selected to run');
           return;
       }

       // Show confirmation with count
       if (!confirm(`Run benchmarks for ${toRun.length} unlocked languages?\n\n${toRun.join(', ')}`)) {
           return;
       }

       // Run sequentially (or could batch)
       for (const lang of toRun) {
           await window.runSolver(lang, '', null); // Run all matrices
       }
   };
   ```

2. Implement window.lockAllValidated:
   ```javascript
   window.lockAllValidated = function() {
       // Find languages with valid results (not mismatch, has iterations)
       const rows = document.querySelectorAll('tbody tr[data-lang]');
       let lockedCount = 0;

       rows.forEach(row => {
           const lang = row.getAttribute('data-lang');
           const isMismatch = row.classList.contains('mismatch-iterations');
           const iters = parseInt(row.getAttribute('data-iters') || '0');

           // Lock if: has iterations, not a mismatch, not already locked
           if (iters > 0 && !isMismatch && !window.lockedLanguages.has(lang)) {
               window.lockedLanguages.set(lang, Date.now());
               lockedCount++;
           }
       });

       if (lockedCount > 0) {
           window.populateLanguageSelector();
           window.updateLockCounter();
           window.saveSessionState();
           alert(`Locked ${lockedCount} validated languages`);
       } else {
           alert('No new languages to lock (all validated languages already locked)');
       }
   };
   ```

3. Implement window.updateLockCounter:
   ```javascript
   window.updateLockCounter = function() {
       const counter = document.getElementById('lock-counter');
       if (counter) {
           const count = window.lockedLanguages.size;
           counter.textContent = count === 1 ? '1 locked' : `${count} locked`;
       }
   };
   ```

4. Call updateLockCounter() in:
   - toggleLock() after state change
   - loadSessionState() after restoring state
   - lockAllValidated() after batch lock
  </action>
  <verify>
1. Click "Run Unlocked" - shows confirmation with list of languages to run
2. Click "Lock Validated" - locks all languages with valid benchmarks
3. Lock counter updates after each operation
4. Bulk run skips locked languages correctly
  </verify>
  <done>Bulk action buttons functional. Lock counter displays current locked count. runAllUnlocked skips locked languages.</done>
</task>

<task type="auto">
  <name>Task 2: Visual polish for lock indicators</name>
  <files>Metrics/HTMLGenerator.ts, Metrics/report_client.js, Metrics/index.css</files>
  <action>
**In HTMLGenerator.ts (CSS section):**
1. Add lock indicator styles for table rows:
   ```css
   /* Locked row indicator */
   tr.locked-row {
       opacity: 0.7;
   }
   tr.locked-row td:first-child::before {
       content: 'üîí ';
       font-size: 0.8em;
   }
   tr.locked-row .run-btn {
       opacity: 0.3;
       pointer-events: none;
       cursor: not-allowed;
   }
   ```

2. Style the lock counter:
   ```css
   #lock-counter {
       display: inline-flex;
       align-items: center;
       gap: 4px;
       padding: 4px 8px;
       background: rgba(255, 215, 0, 0.1);
       border-radius: 4px;
       font-size: 0.75em;
   }
   #lock-counter::before {
       content: 'üîí';
   }
   ```

**In report_client.js:**
1. Add function to update row lock styling:
   ```javascript
   window.updateRowLockStyling = function() {
       const rows = document.querySelectorAll('tbody tr[data-lang]');
       rows.forEach(row => {
           const lang = row.getAttribute('data-lang');
           if (window.lockedLanguages.has(lang)) {
               row.classList.add('locked-row');
           } else {
               row.classList.remove('locked-row');
           }
       });
   };
   ```

2. Call updateRowLockStyling() in:
   - toggleLock() after state change
   - loadSessionState() after restoring state
   - lockAllValidated() after batch lock

3. Update dropdown lock icons with better styling:
   - Locked: Gold color (#ffd700), filled lock icon
   - Unlocked: Gray color (#666), outline lock icon
   - Add hover effect on lock button in dropdown

4. Add toast notification for lock actions (instead of alerts for single lock):
   ```javascript
   window.showToast = function(message, duration = 2000) {
       let toast = document.getElementById('toast-notification');
       if (!toast) {
           toast = document.createElement('div');
           toast.id = 'toast-notification';
           toast.style.cssText = `
               position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
               background: #333; color: #fff; padding: 12px 24px;
               border-radius: 8px; z-index: 10000; opacity: 0;
               transition: opacity 0.3s ease;
           `;
           document.body.appendChild(toast);
       }
       toast.textContent = message;
       toast.style.opacity = '1';
       setTimeout(() => { toast.style.opacity = '0'; }, duration);
   };
   ```

5. Use toast for lock/unlock feedback:
   ```javascript
   // In toggleLock:
   window.showToast(window.lockedLanguages.has(lang) ? `üîí ${lang} locked` : `üîì ${lang} unlocked`);
   ```
  </action>
  <verify>
1. Locked rows show visual distinction (opacity, lock icon prefix)
2. Run buttons on locked rows appear disabled
3. Lock counter styled with background highlight
4. Toast notifications appear for lock/unlock actions
5. Dropdown lock icons clearly distinguish locked vs unlocked
  </verify>
  <done>Locked rows visually distinct. Run buttons disabled on locked rows. Toast notifications for lock actions. Consistent styling throughout.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete lock system with bulk actions and visual polish</what-built>
  <how-to-verify>
    1. Run: Ensure Docker container is running on localhost:9001
    2. Open: http://localhost:9001 (hard refresh Ctrl+Shift+R)
    3. Test lock from dropdown:
       - Open language selector dropdown
       - Click lock icon next to any language
       - Verify toast notification appears
       - Verify lock counter updates
    4. Test lock from modal:
       - Click on a language row to open modal
       - Click lock button in modal
       - Verify button text changes
       - Close modal, check dropdown shows same lock state
    5. Test bulk actions:
       - Click "Lock Validated" button
       - Verify validated languages get locked
       - Verify lock counter shows correct count
    6. Test run protection:
       - Try to click run button on a locked language row
       - Should be disabled/show skip message
       - Click "Run Unlocked" - should only run unlocked languages
    7. Test persistence:
       - Refresh page
       - Verify locked languages remain locked
       - Verify visual indicators persist
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] "Run Unlocked" button runs only unlocked, selected languages
- [ ] "Lock Validated" button locks all languages with valid results
- [ ] Lock counter shows accurate count
- [ ] Locked rows visually distinct with disabled run buttons
- [ ] Toast notifications for lock/unlock actions
- [ ] State persists across page refresh
- [ ] No console errors
</verification>

<success_criteria>
- Bulk actions fully functional
- Visual indicators consistent across all UI locations
- Lock state clearly communicated to user
- Phase 1.5.4 complete - ready for Phase 2
</success_criteria>

<output>
After completion, create `.planning/phases/1.5.4-ui-button-handling-language-filtering/1.5.4-02-SUMMARY.md`
</output>
