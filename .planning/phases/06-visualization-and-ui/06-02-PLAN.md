---
phase: 06-visualization-and-ui
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - Metrics/HTMLGenerator.ts
  - Metrics/SharedStyles.ts
autonomous: true

must_haves:
  truths:
    - "User can view scatter plot showing Time vs Memory for all languages"
    - "Scatter plot uses logarithmic scales by default (toggleable to linear)"
    - "Clicking a point on scatter plot highlights corresponding table row"
    - "User can view heatmap showing Language x Matrix performance"
    - "Clicking a heatmap cell shows detail modal with full metrics"
    - "User can view histogram showing score distribution with percentile markers"
  artifacts:
    - path: "Metrics/HTMLGenerator.ts"
      provides: "Three new chart drawing functions"
      contains: "drawScatterPlot"
    - path: "Metrics/HTMLGenerator.ts"
      provides: "Heatmap drawing function"
      contains: "drawHeatmap"
    - path: "Metrics/HTMLGenerator.ts"
      provides: "Histogram drawing function"
      contains: "drawHistogram"
    - path: "Metrics/SharedStyles.ts"
      provides: "CSS for new chart types"
      contains: "scatter-tooltip"
  key_links:
    - from: "chart-selector"
      to: "new chart functions"
      via: "switchChart()"
      pattern: "type === 'scatter'"
    - from: "scatter point click"
      to: "table row highlight"
      via: "data-lang attribute"
      pattern: "data-lang"
    - from: "heatmap cell click"
      to: "detail modal"
      via: "showDetailModal"
      pattern: "showDetailModal\\("
---

<objective>
Add three advanced D3.js visualizations: Time vs Memory scatter plot, Language x Matrix heatmap, and Score distribution histogram.

Purpose: Reveal performance patterns through complementary chart types (VIZ-01, VIZ-02, VIZ-03)
Output: Three new interactive charts accessible via dropdown, integrated with existing UI
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-visualization-and-ui/06-CONTEXT.md
@.planning/phases/06-visualization-and-ui/06-RESEARCH.md

# Key source files
@Metrics/HTMLGenerator.ts (existing chart functions like drawLineChart, drawMatrixRace)
@Metrics/SharedStyles.ts (CSS styles)
@Metrics/scoring-analysis.ts (identifyOutliers function to mark outlier points)

# Prior plan dependency (dropdown sorting fixed in 06-01)
@.planning/phases/06-visualization-and-ui/06-01-SUMMARY.md

# Pattern reference
@.planning/phases/05-scoring-analysis/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS styles for new chart types</name>
  <files>Metrics/SharedStyles.ts</files>
  <action>
Add CSS for scatter plot, heatmap, and histogram visualizations:

1. **Scatter plot styles:**
   - `.scatter-point` - Circle styling with neon glow
   - `.scatter-point.outlier` - Different color (#ff4444) and shape (square marker via CSS clip-path or larger radius)
   - `.scatter-point.highlighted` - Bright glow effect when clicked
   - `.scatter-tooltip` - Tooltip box with dark background, neon border
   - `.log-scale-toggle` - Button styling for log/linear toggle

2. **Heatmap styles:**
   - `.heatmap-cell` - Base cell styling with border
   - `.heatmap-cell:hover` - Highlight border color (#00ff9d)
   - `.heatmap-axis-label` - Labels for languages and matrices
   - `.heatmap-legend` - Color scale legend positioning

3. **Histogram styles:**
   - `.histogram-bar` - Bar fill with gradient
   - `.percentile-line` - Vertical line styling for Q1, median, Q3
   - `.percentile-label` - Text labels for percentile markers

4. **Shared styles:**
   - `.chart-controls` - Container for log/linear toggle and filter controls
   - `.language-filter` - Search input styling for filtering charts

Follow existing neon theme: primary #00ff9d, secondary #00b8ff, error #ff4444
  </action>
  <verify>
Run `npx ts-node Metrics/generate_report_only.ts` - should complete without TypeScript errors
Inspect SharedStyles.ts for new class definitions
  </verify>
  <done>CSS styles added for scatter-point, heatmap-cell, histogram-bar, chart-controls classes</done>
</task>

<task type="auto">
  <name>Task 2: Add scatter plot chart (Time vs Memory)</name>
  <files>Metrics/HTMLGenerator.ts</files>
  <action>
Add drawScatterPlot() function following existing chart patterns (see drawLineChart, drawMatrixRace).

**Data preparation:**
- Use metricsData already available in window.metricsData
- One point per language showing Matrix 1 results (simplest puzzle, most comparable)
- Identify outliers using Phase 5's identifyOutliers() function

**Chart implementation:**
```javascript
function drawScatterPlot() {
    const container = document.getElementById('d3-chart-container');
    const width = container.clientWidth;
    const height = container.clientHeight;
    const margin = { top: 50, right: 80, bottom: 60, left: 80 };

    // Get Matrix 1 data for each language
    const scatterData = window.metricsData
        .filter(m => m.matrix === '1' && m.time > 0 && m.memory > 0)
        .map(m => ({
            solver: m.solver,
            time: m.time,
            memory: m.memory
        }));

    // Identify outliers
    const timeValues = scatterData.map(d => d.time);
    const outlierInfo = window.scoringAnalysisData?.outliers || [];
    const outlierNames = new Set(outlierInfo.map(o => o.solver));

    // Log scale by default (toggleable)
    let useLogScale = true;

    // Create scales
    const xScale = useLogScale
        ? d3.scaleLog().domain([d3.min(scatterData, d => d.time) * 0.5, d3.max(scatterData, d => d.time) * 2])
        : d3.scaleLinear().domain([0, d3.max(scatterData, d => d.time) * 1.1]);
    xScale.range([margin.left, width - margin.right]);

    const yScale = useLogScale
        ? d3.scaleLog().domain([d3.min(scatterData, d => d.memory) * 0.5, d3.max(scatterData, d => d.memory) * 2])
        : d3.scaleLinear().domain([0, d3.max(scatterData, d => d.memory) * 1.1]);
    yScale.range([height - margin.bottom, margin.top]);

    // Draw SVG, axes, gridlines
    // Draw circles with outlier styling
    // Add tooltips with edge detection
    // Add click handler to highlight table row
    // Add log/linear toggle button
}
```

**Key interactions:**
1. **Tooltips:** Show language name, time, memory on hover (use edge detection pattern from RESEARCH.md)
2. **Click-to-highlight:** Clicking a point highlights the corresponding table row and scrolls to it
3. **Outlier styling:** Use different color (#ff4444) for outlier points
4. **Log/linear toggle:** Button to switch between logarithmic and linear scales

**Add to switchChart():**
```javascript
} else if (type === 'scatter') {
    drawScatterPlot();
}
```

**Add dropdown option:**
Add `<option value="scatter">Time vs Memory</option>` to chart-selector in alphabetical position.
Note: 06-01 has already fixed dropdown sorting. Insert this option in the correct alphabetical position among the existing options.
  </action>
  <verify>
1. `npx ts-node Metrics/generate_report_only.ts`
2. Open index.html, select "Time vs Memory" from dropdown
3. Scatter plot appears with points for each language
4. Hover shows tooltip with language/time/memory
5. Click a point - corresponding table row highlights and scrolls into view
6. Outliers appear in red/different style
7. Toggle button switches between log and linear scales
  </verify>
  <done>Scatter plot showing Time vs Memory with log scale, tooltips, click-to-highlight, outlier styling</done>
</task>

<task type="auto">
  <name>Task 3: Add heatmap chart (Language x Matrix)</name>
  <files>Metrics/HTMLGenerator.ts</files>
  <action>
Add drawHeatmap() function showing performance across all language-matrix combinations.

**Data preparation:**
- Use all metricsData entries (not just Matrix 1)
- Create grid: X-axis = matrices (1-6), Y-axis = languages (alphabetically sorted)
- Color by normalized time (faster = greener, slower = redder)

**Chart implementation:**
```javascript
function drawHeatmap() {
    const container = document.getElementById('d3-chart-container');
    const width = container.clientWidth;
    const height = container.clientHeight;
    const margin = { top: 30, right: 100, bottom: 50, left: 120 };

    // Build matrix of language x matrix
    const matrices = ['1', '2', '3', '4', '5'];
    const languages = [...new Set(window.metricsData.map(d => d.solver))].sort();

    // Create band scales
    const xScale = d3.scaleBand()
        .domain(matrices)
        .range([margin.left, width - margin.right])
        .padding(0.05);

    const yScale = d3.scaleBand()
        .domain(languages)
        .range([margin.top, height - margin.bottom])
        .padding(0.05);

    // Color scale: log scale for time, viridis palette (reversed: faster = brighter)
    const times = window.metricsData.map(d => d.time).filter(t => t > 0);
    const colorScale = d3.scaleSequentialLog(d3.interpolateViridis)
        .domain([d3.max(times), d3.min(times)]); // Reversed for "faster = brighter"

    // Draw cells
    // Add hover effect (highlight border)
    // Add click handler to show detail modal
    // Draw axes and legend
}
```

**Detail modal on click:**
Create showHeatmapDetail(solver, matrix, data) function that shows a modal with:
- Language name, matrix number
- Time, memory, iterations
- Score (if available)
- Close button

**Add to switchChart():**
```javascript
} else if (type === 'heatmap') {
    drawHeatmap();
}
```

**Add dropdown option:**
Add `<option value="heatmap">Heatmap</option>` to chart-selector in alphabetical position.

**Handle many languages:**
If >50 languages, add vertical scroll or filter input to narrow down visible languages.
  </action>
  <verify>
1. `npx ts-node Metrics/generate_report_only.ts`
2. Open index.html, select "Heatmap" from dropdown
3. Grid appears with languages on Y-axis, matrices (1-5) on X-axis
4. Cells colored by performance (faster = brighter/greener)
5. Hover highlights cell border
6. Click shows detail modal with language metrics
7. Color legend visible
  </verify>
  <done>Heatmap showing Language x Matrix performance with color scale, hover effects, click-to-detail modal</done>
</task>

<task type="auto">
  <name>Task 4: Add histogram chart (Score Distribution)</name>
  <files>Metrics/HTMLGenerator.ts</files>
  <action>
Add drawHistogram() function showing distribution of composite scores with statistical markers.

**Data preparation:**
- Extract composite scores from window.metricsData or window.scoringAnalysisData
- Calculate percentiles using D3 (Q1, median, Q3, mean)

**Chart implementation:**
```javascript
function drawHistogram() {
    const container = document.getElementById('d3-chart-container');
    const width = container.clientWidth;
    const height = container.clientHeight;
    const margin = { top: 40, right: 40, bottom: 60, left: 60 };

    // Get scores
    const scores = window.metricsData
        .filter(m => m.matrix === '1' && m.score && m.score > 0)
        .map(m => m.score);

    // X scale for score range
    const xScale = d3.scaleLinear()
        .domain([0, d3.max(scores) * 1.1])
        .range([margin.left, width - margin.right]);

    // Create histogram bins
    const histogram = d3.histogram()
        .domain(xScale.domain())
        .thresholds(20);

    const bins = histogram(scores);

    // Y scale for frequency
    const yScale = d3.scaleLinear()
        .domain([0, d3.max(bins, d => d.length)])
        .range([height - margin.bottom, margin.top]);

    // Calculate statistics
    const sortedScores = scores.slice().sort((a, b) => a - b);
    const q1 = d3.quantile(sortedScores, 0.25);
    const median = d3.quantile(sortedScores, 0.5);
    const q3 = d3.quantile(sortedScores, 0.75);
    const mean = d3.mean(scores);

    // Draw bars
    // Draw percentile lines (Q1, median, Q3 in blue, mean in orange dashed)
    // Draw axes
    // Add labels for percentile markers
}
```

**Percentile markers:**
- Q1 (25%): blue solid line with label
- Median (50%): green solid line with label
- Q3 (75%): blue solid line with label
- Mean: orange dashed line with label

**Add to switchChart():**
```javascript
} else if (type === 'histogram') {
    drawHistogram();
}
```

**Add dropdown option:**
Add `<option value="histogram">Score Distribution</option>` to chart-selector in alphabetical position.
  </action>
  <verify>
1. `npx ts-node Metrics/generate_report_only.ts`
2. Open index.html, select "Score Distribution" from dropdown
3. Histogram bars show score frequency
4. Vertical lines mark Q1, median, Q3, mean with labels
5. Axes labeled clearly (Score, Frequency)
  </verify>
  <done>Histogram showing score distribution with percentile markers (Q1, median, Q3, mean)</done>
</task>

</tasks>

<verification>
Overall verification:
1. Generate fresh report: `npx ts-node Metrics/generate_report_only.ts`
2. Open index.html in browser
3. Verify dropdown now includes: Algorithm Comparison, Heatmap, Horse Race, Iteration Counts, Language, Line (Metrics), Matrix Race, Score Distribution, Time vs Memory (alphabetical)
4. Test each new chart:
   - Time vs Memory: scatter with log scale, tooltips, click-highlight
   - Heatmap: color grid, hover, click-to-modal
   - Score Distribution: histogram bars, percentile lines
5. No console errors during chart switching
</verification>

<success_criteria>
- Three new charts accessible via dropdown: Time vs Memory, Heatmap, Score Distribution
- Scatter plot uses log scale by default with toggle to linear
- Clicking scatter point highlights corresponding table row
- Heatmap cells show color gradient based on performance
- Clicking heatmap cell shows detail modal
- Histogram shows score distribution with Q1/median/Q3/mean markers
- All charts follow neon/matrix theme
- No JavaScript console errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-visualization-and-ui/06-02-SUMMARY.md`
</output>
