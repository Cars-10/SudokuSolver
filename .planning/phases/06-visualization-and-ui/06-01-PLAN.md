---
phase: 06-visualization-and-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Metrics/HTMLGenerator.ts
  - index.html
autonomous: true

must_haves:
  truths:
    - "Algorithm dropdown options appear in alphabetical order (Algorithm Comparison, Horse Race, Iteration Counts, Language, Line, Matrix Race)"
    - "Algorithm dropdown selection syncs correctly when switchChart() is called programmatically"
    - "Matrix Race fullscreen exit via ESC key or button works without exit/re-enter loop"
    - "Exiting Matrix Race fullscreen returns to normal chart view cleanly"
  artifacts:
    - path: "Metrics/HTMLGenerator.ts"
      provides: "Alphabetically sorted chart-selector options"
      contains: "option value=\"algorithm\""
    - path: "index.html"
      provides: "Fixed fullscreen event handler without re-entry loop"
      contains: "fullscreenchange"
  key_links:
    - from: "chart-selector onchange"
      to: "switchChart()"
      via: "event handler"
      pattern: "switchChart\\(this\\.value\\)"
    - from: "fullscreenchange event"
      to: "chart redraw"
      via: "conditional check"
      pattern: "!document\\.fullscreenElement"
---

<objective>
Fix UI bugs in algorithm dropdown and Matrix Race fullscreen handling.

Purpose: Resolve usability issues before adding new visualizations (clean foundation for Phase 6 charts)
Output: Working dropdown sorting + reliable fullscreen exit behavior
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-visualization-and-ui/06-CONTEXT.md
@.planning/phases/06-visualization-and-ui/06-RESEARCH.md

# Key source files
@Metrics/HTMLGenerator.ts (chart-selector generation)
@index.html (fullscreen handlers around lines 60-90, 36568-36577)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sort algorithm dropdown options alphabetically</name>
  <files>Metrics/HTMLGenerator.ts</files>
  <action>
Find the chart-selector dropdown generation in HTMLGenerator.ts (around where the options are written). The current order is:
- line, jockey, race, algorithm, language, iterations

Sort options alphabetically by display text:
- Algorithm Comparison, Horse Race, Iteration Counts, Language, Line (Metrics), Matrix Race

Also ensure switchChart() syncs the dropdown value when called programmatically (check line ~34871 in generated output - selector.value = type).

Update the template string that generates the select options to be in alphabetical order.
  </action>
  <verify>
Run `npx ts-node Metrics/generate_report_only.ts` and inspect generated index.html:
- `grep -A10 'id="chart-selector"' index.html` should show options in alphabetical order
  </verify>
  <done>Chart-selector options appear alphabetically: Algorithm Comparison, Horse Race, Iteration Counts, Language, Metrics, Matrix Race</done>
</task>

<task type="auto">
  <name>Task 2: Fix Matrix Race fullscreen exit/re-enter loop</name>
  <files>Metrics/HTMLGenerator.ts</files>
  <action>
The bug: When exiting fullscreen from Matrix Race, there's a temporary exit/re-enter loop. Research identified the cause as competing fullscreenchange handlers.

Current flow (problematic):
1. Line ~34895-34902: Matrix Race auto-enters fullscreen on selection
2. Line ~36569-36577: fullscreenchange handler calls switchChart() on exit
3. If current chart is 'race', switchChart('race') triggers auto-fullscreen again (loop)

Fix approach:
1. In the fullscreenchange handler (around line 36569), add a guard to skip redraw if exiting from Matrix Race:

```javascript
document.addEventListener('fullscreenchange', function () {
    if (!document.fullscreenElement && window.currentChart && typeof window.switchChart === 'function') {
        // Skip redraw for Matrix Race - it handles fullscreen specially
        if (window.currentChart === 'race') {
            console.log('Exited fullscreen from Matrix Race, skipping redraw');
            return;
        }
        console.log('Exited fullscreen, resizing chart:', window.currentChart);
        setTimeout(function () {
            window.switchChart(window.currentChart);
        }, 100);
    }
});
```

2. In the Matrix Race auto-fullscreen code (line ~34895-34902), add a flag to prevent re-entry:

```javascript
} else if (type === 'race') {
    // Only auto-enter fullscreen if not already exiting
    if (!document.fullscreenElement && !window.exitingMatrixRaceFullscreen && typeof window.toggleChartFullscreen === 'function') {
        window.toggleChartFullscreen();
        setTimeout(() => drawMatrixRace(), 300);
    } else {
        drawMatrixRace();
    }
}
```

3. Set window.exitingMatrixRaceFullscreen = true when exiting race fullscreen, false when entering.

Find these sections in HTMLGenerator.ts (in the script template strings) and apply the fix.
  </action>
  <verify>
1. `npx ts-node Metrics/generate_report_only.ts`
2. Open index.html in browser
3. Select "Matrix Race" - should enter fullscreen
4. Press ESC or click exit button - should exit cleanly without flicker/re-entry
5. Check console for "Exited fullscreen from Matrix Race, skipping redraw" message
  </verify>
  <done>Matrix Race fullscreen exit works cleanly without exit/re-enter loop on both ESC key and button click</done>
</task>

<task type="auto">
  <name>Task 3: Verify chart redraw on non-Race fullscreen exit</name>
  <files>Metrics/HTMLGenerator.ts</files>
  <action>
Ensure the fix from Task 2 doesn't break other charts' fullscreen exit behavior.

Test that when exiting fullscreen from non-Matrix-Race charts (line, jockey, algorithm, language, iterations), the chart still redraws correctly.

The guard `if (window.currentChart === 'race') return;` should only skip redraw for Matrix Race.

If any issues found, adjust the condition. Otherwise, no code changes needed - this is a verification task.
  </action>
  <verify>
1. Open index.html in browser
2. Select "Horse Race" chart
3. Click fullscreen button (or use other chart that supports fullscreen)
4. Exit fullscreen via ESC
5. Verify chart redraws at normal size (not stuck at fullscreen dimensions)
6. Repeat for "Algorithm Comparison" chart
  </verify>
  <done>Non-Matrix-Race charts correctly resize when exiting fullscreen</done>
</task>

</tasks>

<verification>
Overall verification:
1. Generate fresh report: `npx ts-node Metrics/generate_report_only.ts`
2. Open index.html in browser
3. Check dropdown order: Algorithm Comparison, Horse Race, Iteration Counts...
4. Test Matrix Race: select, auto-fullscreen, ESC exit = clean exit
5. Test other charts: fullscreen, ESC exit = proper resize
6. No console errors during any interaction
</verification>

<success_criteria>
- Algorithm dropdown shows options in alphabetical order
- Matrix Race enters fullscreen automatically on selection
- Exiting Matrix Race fullscreen (ESC or button) returns to normal view without loop
- Other charts still resize correctly when exiting fullscreen
- No JavaScript console errors during chart switching or fullscreen operations
</success_criteria>

<output>
After completion, create `.planning/phases/06-visualization-and-ui/06-01-SUMMARY.md`
</output>
