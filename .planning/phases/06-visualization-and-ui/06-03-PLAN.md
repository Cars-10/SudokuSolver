---
phase: 06-visualization-and-ui
plan: 03
type: execute
wave: 2
depends_on: [06-02]
files_modified:
  - Metrics/HTMLGenerator.ts
  - Metrics/SharedStyles.ts
autonomous: true

must_haves:
  truths:
    - "Languages with validation issues show visual warning badge in rankings table"
    - "User can click warning badge to see diagnostics modal with iteration mismatch details"
    - "Diagnostics modal shows expected vs actual iterations and severity level"
    - "Invalid implementations are visually distinguished in charts (scatter plot, heatmap)"
  artifacts:
    - path: "Metrics/HTMLGenerator.ts"
      provides: "Validation badge rendering in table rows"
      contains: "validation-badge"
    - path: "Metrics/HTMLGenerator.ts"
      provides: "Diagnostics modal function"
      contains: "showDiagnosticsModal"
    - path: "Metrics/SharedStyles.ts"
      provides: "CSS for validation badges and diagnostics modal"
      contains: "validation-badge"
  key_links:
    - from: "benchmark_issues.json"
      to: "window.validationIssues"
      via: "data embedding"
      pattern: "window\\.validationIssues"
    - from: "validation-badge click"
      to: "diagnostics modal"
      via: "onclick handler"
      pattern: "showDiagnosticsModal\\("
    - from: "table row"
      to: "validation-badge"
      via: "conditional rendering"
      pattern: "hasValidationIssue"
---

<objective>
Add validation UI elements: warning badges for invalid implementations and diagnostics modal showing iteration mismatch details.

Purpose: Surface validation results from Phase 4 (VAL-04, VAL-05) to users in the HTML report
Output: Visual badges on invalid implementations + clickable diagnostics modal with details
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-visualization-and-ui/06-CONTEXT.md
@.planning/phases/06-visualization-and-ui/06-RESEARCH.md
@.planning/phases/04-validation-infrastructure/04-01-SUMMARY.md

# Key source files
@benchmark_issues.json (validation failures logged by common.sh)
@Metrics/HTMLGenerator.ts (table generation)
@Metrics/SharedStyles.ts (CSS styles)

# Dependency
@.planning/phases/06-visualization-and-ui/06-02-PLAN.md (new charts need validation styling)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS styles for validation badges and diagnostics modal</name>
  <files>Metrics/SharedStyles.ts</files>
  <action>
Add CSS for validation warning UI:

1. **Validation badge styles:**
```css
.validation-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.validation-badge.critical {
    background: rgba(255, 68, 68, 0.2);
    border: 1px solid #ff4444;
    color: #ff4444;
}

.validation-badge.warning {
    background: rgba(255, 157, 0, 0.2);
    border: 1px solid #ff9d00;
    color: #ff9d00;
}

.validation-badge:hover {
    transform: scale(1.05);
    box-shadow: 0 0 10px currentColor;
}

.validation-badge svg {
    width: 12px;
    height: 12px;
}
```

2. **Diagnostics modal styles:**
```css
.diagnostics-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.diagnostics-modal-overlay.visible {
    opacity: 1;
    visibility: visible;
}

.diagnostics-modal {
    background: var(--bg-dark, #0d0d12);
    border: 1px solid var(--primary, #00ff9d);
    border-radius: 8px;
    padding: 24px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 0 30px rgba(0, 255, 157, 0.2);
}

.diagnostics-modal h3 {
    color: var(--primary, #00ff9d);
    margin: 0 0 16px 0;
    font-family: 'JetBrains Mono', monospace;
}

.diagnostics-modal .issue-item {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 12px;
}

.diagnostics-modal .issue-severity {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
}

.diagnostics-modal .issue-severity.critical {
    background: #ff4444;
    color: #000;
}

.diagnostics-modal .issue-severity.warning {
    background: #ff9d00;
    color: #000;
}

.diagnostics-modal .iteration-compare {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-top: 12px;
}

.diagnostics-modal .iteration-compare .expected,
.diagnostics-modal .iteration-compare .actual {
    text-align: center;
}

.diagnostics-modal .iteration-compare label {
    display: block;
    font-size: 0.8rem;
    color: #888;
    margin-bottom: 4px;
}

.diagnostics-modal .iteration-compare .value {
    font-size: 1.2rem;
    font-family: 'JetBrains Mono', monospace;
}

.diagnostics-modal .iteration-compare .expected .value {
    color: var(--primary, #00ff9d);
}

.diagnostics-modal .iteration-compare .actual .value {
    color: #ff4444;
}

.diagnostics-modal .close-btn {
    margin-top: 16px;
    width: 100%;
    padding: 10px;
    background: transparent;
    border: 1px solid var(--primary, #00ff9d);
    color: var(--primary, #00ff9d);
    border-radius: 4px;
    cursor: pointer;
    font-family: 'JetBrains Mono', monospace;
    transition: all 0.2s ease;
}

.diagnostics-modal .close-btn:hover {
    background: var(--primary, #00ff9d);
    color: #000;
}
```
  </action>
  <verify>
Run `npx ts-node Metrics/generate_report_only.ts` - should complete without TypeScript errors
Inspect SharedStyles.ts for validation-badge, diagnostics-modal classes
  </verify>
  <done>CSS styles added for validation-badge (critical, warning), diagnostics-modal, iteration-compare</done>
</task>

<task type="auto">
  <name>Task 2: Embed benchmark_issues.json data in HTML report</name>
  <files>Metrics/HTMLGenerator.ts</files>
  <action>
Read benchmark_issues.json at report generation time and embed it in the HTML as window.validationIssues.

1. **In generateHtml() function, near the top:**
```typescript
// Read validation issues
let validationIssues: any[] = [];
const issuesPath = path.join(__dirname, '..', 'benchmark_issues.json');
try {
    if (fsSync.existsSync(issuesPath)) {
        const issuesContent = await fs.readFile(issuesPath, 'utf-8');
        validationIssues = JSON.parse(issuesContent);
    }
} catch (e) {
    console.warn('Could not read benchmark_issues.json:', e);
}
```

2. **Embed in script section (near other window.* assignments like window.metricsData):**
```javascript
window.validationIssues = ${safeJSON(validationIssues)};
```

3. **Create lookup helper for quick access:**
```javascript
window.getValidationIssues = function(language) {
    return window.validationIssues.filter(i => i.language === language);
};
```
  </action>
  <verify>
1. `npx ts-node Metrics/generate_report_only.ts`
2. `grep 'window.validationIssues' index.html` - should find the embedded data
3. Open index.html in browser, check console: `window.validationIssues` returns array
  </verify>
  <done>benchmark_issues.json data embedded as window.validationIssues with getValidationIssues() helper</done>
</task>

<task type="auto">
  <name>Task 3: Add diagnostics modal HTML and JavaScript functions</name>
  <files>Metrics/HTMLGenerator.ts</files>
  <action>
Add the diagnostics modal overlay HTML and show/hide functions.

1. **Add modal HTML (near other modal HTML, after main content):**
```html
<div id="diagnostics-modal-overlay" class="diagnostics-modal-overlay" onclick="if(event.target === this) hideDiagnosticsModal()">
    <div class="diagnostics-modal">
        <h3 id="diagnostics-modal-title">Validation Issues</h3>
        <div id="diagnostics-modal-content"></div>
        <button class="close-btn" onclick="hideDiagnosticsModal()">Close</button>
    </div>
</div>
```

2. **Add JavaScript functions (in script section):**
```javascript
window.showDiagnosticsModal = function(language) {
    const issues = window.getValidationIssues(language);
    const modal = document.getElementById('diagnostics-modal-overlay');
    const title = document.getElementById('diagnostics-modal-title');
    const content = document.getElementById('diagnostics-modal-content');

    // Normalize language name for display
    const displayName = language.replace('_Sharp', '#').replace('_Plus', '++');
    title.textContent = displayName + ' - Validation Issues';

    if (issues.length === 0) {
        content.innerHTML = '<p style="color: var(--primary);">No validation issues found.</p>';
    } else {
        content.innerHTML = issues.map(issue => {
            const severityClass = issue.severity.toLowerCase();
            return `
                <div class="issue-item">
                    <span class="issue-severity ${severityClass}">${issue.severity}</span>
                    <span style="margin-left: 8px; color: #aaa;">Matrix ${issue.matrix}</span>
                    <p style="margin: 8px 0 0 0; color: var(--text);">${issue.message}</p>
                    ${issue.failure_type === 'iteration_mismatch' ? `
                        <div class="iteration-compare">
                            <div class="expected">
                                <label>Expected</label>
                                <div class="value">${issue.expected_iterations.toLocaleString()}</div>
                            </div>
                            <div class="actual">
                                <label>Actual</label>
                                <div class="value">${issue.actual_iterations.toLocaleString()}</div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    modal.classList.add('visible');
};

window.hideDiagnosticsModal = function() {
    document.getElementById('diagnostics-modal-overlay').classList.remove('visible');
};

// Close on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideDiagnosticsModal();
    }
});
```
  </action>
  <verify>
1. `npx ts-node Metrics/generate_report_only.ts`
2. Open index.html in browser
3. In console, run: `showDiagnosticsModal('TestLang')` - modal should appear with issue details
4. Click Close or press ESC - modal should close
5. Click outside modal - modal should close
  </verify>
  <done>Diagnostics modal HTML added with show/hide functions, ESC key handler, click-outside-to-close</done>
</task>

<task type="auto">
  <name>Task 4: Add validation badges to rankings table rows</name>
  <files>Metrics/HTMLGenerator.ts</files>
  <action>
Add validation warning badges to table rows for languages with issues.

1. **Create badge HTML generator helper:**
```javascript
function getValidationBadgeHtml(language) {
    const issues = window.validationIssues.filter(i => i.language === language);
    if (issues.length === 0) return '';

    // Determine highest severity
    const hasCritical = issues.some(i => i.severity === 'CRITICAL');
    const severityClass = hasCritical ? 'critical' : 'warning';
    const icon = hasCritical
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';

    return `<span class="validation-badge ${severityClass}" onclick="event.stopPropagation(); showDiagnosticsModal('${language}')" title="${issues.length} validation issue(s)">${icon}${issues.length}</span>`;
}
```

2. **In the table row generation (where language name cell is created):**

Find where the language name column is rendered in the sortedMetrics.forEach loop. Add the badge after the language name:

```javascript
// In the TD for language name, after the language display name:
const badgeHtml = getValidationBadgeHtml(solver);
// Insert badgeHtml after language name span
```

The exact location depends on current table structure - look for where `solver` or language name is rendered in the rankings table.

3. **Note:** The badge should be clickable and NOT trigger the row's click event (use event.stopPropagation()).
  </action>
  <verify>
1. `npx ts-node Metrics/generate_report_only.ts`
2. Open index.html in browser
3. Look for "TestLang" in the rankings table (if present in metrics) - should have warning badge
4. Click the badge - diagnostics modal opens
5. The row click (for expandable sensitivity data) should NOT trigger when clicking badge
  </verify>
  <done>Validation badges appear on table rows for languages with issues, clicking opens diagnostics modal</done>
</task>

<task type="auto">
  <name>Task 5: Add validation styling to new charts</name>
  <files>Metrics/HTMLGenerator.ts</files>
  <action>
Update the scatter plot and heatmap (from 06-02) to visually distinguish invalid implementations.

1. **In drawScatterPlot():**
Add check for validation issues when styling points:
```javascript
const hasIssues = (solver) => window.validationIssues.some(i => i.language === solver);

// When drawing circles, add class or style:
.attr('class', d => `scatter-point ${hasIssues(d.solver) ? 'invalid' : ''} ${outlierNames.has(d.solver) ? 'outlier' : ''}`)
```

2. **In drawHeatmap():**
Add visual indicator for cells with validation issues:
```javascript
// Add border or overlay for invalid cells
.style('stroke', d => hasIssues(d.solver) ? '#ff4444' : '#2a2a35')
.style('stroke-width', d => hasIssues(d.solver) ? '2' : '1')
```

3. **Add CSS for invalid chart points (in SharedStyles.ts if not already):**
```css
.scatter-point.invalid {
    stroke: #ff4444;
    stroke-width: 2;
    stroke-dasharray: 2,2;
}
```
  </action>
  <verify>
1. `npx ts-node Metrics/generate_report_only.ts`
2. Open index.html, view scatter plot
3. Points for languages with validation issues should have dashed red border
4. View heatmap - rows for invalid languages should have red border on cells
  </verify>
  <done>Invalid implementations visually distinguished in scatter plot and heatmap with red styling</done>
</task>

</tasks>

<verification>
Overall verification:
1. Generate fresh report: `npx ts-node Metrics/generate_report_only.ts`
2. Open index.html in browser
3. Find a language with validation issues (e.g., TestLang if present)
4. Verify badge appears next to language name in rankings table
5. Click badge - diagnostics modal opens with issue details
6. Modal shows expected vs actual iterations for iteration_mismatch issues
7. Press ESC or click Close - modal closes
8. View scatter plot - invalid languages have dashed red circle
9. View heatmap - invalid language rows have red cell borders
10. No console errors
</verification>

<success_criteria>
- Validation badges (warning/critical) appear on table rows for languages with issues
- Clicking badge opens diagnostics modal with issue details
- Modal shows severity, matrix, message, and iteration comparison for mismatches
- Modal closes via Close button, ESC key, or clicking outside
- Scatter plot points for invalid languages have distinct styling
- Heatmap cells for invalid languages have distinct styling
- All styling follows neon/matrix theme (red for errors: #ff4444)
- No JavaScript console errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-visualization-and-ui/06-03-SUMMARY.md`
</output>
