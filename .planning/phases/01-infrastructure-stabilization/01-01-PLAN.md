---
phase: 01-infrastructure-stabilization
plan: 01
type: execute
---

<objective>
Verify Docker build reproducibility and expand metrics capture for comprehensive benchmarking.

Purpose: Ensure the Docker infrastructure builds reliably and captures all available performance metrics for fair language comparison.
Output: Working Docker image with enhanced metrics capture in common.sh.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STACK.md
@.planning/codebase/ARCHITECTURE.md

**Relevant source files:**
@server/Dockerfile
@docker-compose.yml
@Languages/common.sh

**Prior context:**
- PROJECT.md notes: "Docker infrastructure needs rebuilding on the new server"
- Current Docker image exists (14.2GB, sudoku-benchmark:latest)
- common.sh currently captures: time, memory, cpu_user, cpu_sys, iterations, status
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify/Rebuild Docker Image</name>
  <files>server/Dockerfile, docker-compose.yml</files>
  <action>
    1. Run `docker build -t sudoku-benchmark:latest -f server/Dockerfile .` from project root
    2. Capture build output, noting any warnings or errors
    3. Verify key toolchains installed by running quick version checks:
       - `docker run --rm sudoku-benchmark:latest gcc --version`
       - `docker run --rm sudoku-benchmark:latest python3 --version`
       - `docker run --rm sudoku-benchmark:latest node --version`
       - `docker run --rm sudoku-benchmark:latest rustc --version`
    4. Document final image size with `docker images sudoku-benchmark:latest`
    5. If build fails, identify the failing layer and document the error

    **What to avoid:** Don't modify the Dockerfile unless build actually fails. We're verifying, not preemptively changing.
  </action>
  <verify>
    - `docker build` completes with exit code 0
    - `docker images sudoku-benchmark:latest` shows image exists
    - Version check commands return valid version strings
  </verify>
  <done>Docker image builds successfully, all major toolchains verified present</done>
</task>

<task type="auto">
  <name>Task 2: Audit & Expand Metrics Capture</name>
  <files>Languages/common.sh</files>
  <action>
    1. Review current GNU time format string in common.sh: `%e %M %U %S`
    2. Expand to capture additional valuable metrics:
       - `%F` - Major page faults (required disk I/O)
       - `%R` - Minor page faults (no disk I/O)
       - `%w` - Voluntary context switches
       - `%c` - Involuntary context switches
       - `%I` - File system inputs
       - `%O` - File system outputs
    3. Update the TIME_CMD format string to: `%e %M %U %S %F %R %w %c %I %O`
    4. Update the parsing in run_matrix() to extract all 10 fields
    5. Update the JSON output to include new fields:
       - `page_faults_major`, `page_faults_minor`
       - `context_switches_voluntary`, `context_switches_involuntary`
       - `io_inputs`, `io_outputs`
    6. Ensure macOS compatibility: Test that gtime supports these format specifiers (it should, as GNU time)
    7. Add fallback: If a metric returns empty/invalid, default to 0

    **What to avoid:**
    - Don't break existing metrics parsing - the 4 original fields must continue working
    - Don't change the metrics.json top-level structure - only add new fields to result objects
  </action>
  <verify>
    - `grep -E "%e %M %U %S %F %R" Languages/common.sh` shows expanded format
    - `grep "page_faults_major" Languages/common.sh` shows new field in JSON output
    - No syntax errors: `bash -n Languages/common.sh` returns 0
  </verify>
  <done>common.sh captures 10 metrics (time, memory, cpu_user, cpu_sys, page_faults_major, page_faults_minor, context_switches_voluntary, context_switches_involuntary, io_inputs, io_outputs)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Docker image builds without errors
- [ ] All major language toolchains present in image (gcc, python3, node, rustc, go, java)
- [ ] common.sh has expanded metrics format string
- [ ] common.sh JSON output includes all 10 metric fields
- [ ] `bash -n Languages/common.sh` passes (no syntax errors)
</verification>

<success_criteria>
- Docker image builds reproducibly
- Metrics capture expanded from 4 to 10 fields
- No regressions in existing functionality
- Ready for cross-platform testing in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-stabilization/01-01-SUMMARY.md`:

# Phase 1 Plan 01: Docker + Metrics Summary

**[One-liner: what shipped]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 01-02-PLAN.md (Shell Testing + Verification)
</output>
