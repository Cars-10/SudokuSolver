%!PS
% Sudoku Solver in PostScript

/puzzle 81 array def
/count 0 def

/print-puzzle {
    (Puzzle:) =
    0 1 8 {
        /r exch def
        0 1 8 {
            /c exch def
            puzzle r 9 mul c add get
            ( ) print
            10 string cvs print
        } for
        () =
    } for
} def

/read-matrix-file {
    /filename exch def
    filename =
    /f filename (r) file def
    /idx 0 def
    
    {
        f 100 string readline
        not { pop exit } if
        /line exch def
        
        line length 0 gt {
            line 0 1 getinterval (#) ne {
                line token {
                    {
                        puzzle idx 3 -1 roll put
                        /idx idx 1 add def
                        token not { exit } if
                    } loop
                } if
            } if
        } if
    } loop
    f closefile
} def

/is-possible {
    /val exch def
    /c exch def
    /r exch def
    
    true
    
    % Row
    0 1 8 {
        /i exch def
        puzzle r 9 mul i add get val eq { pop false exit } if
    } for
    
    % Col
    dup {
        0 1 8 {
            /i exch def
            puzzle i 9 mul c add get val eq { pop false exit } if
        } for
    } if
    
    % Box
    dup {
        /r0 r 3 idiv 3 mul def
        /c0 c 3 idiv 3 mul def
        0 1 2 {
            /i exch def
            0 1 2 {
                /j exch def
                puzzle r0 i add 9 mul c0 j add add get val eq { pop false exit } if
            } for
            not { exit } if
        } for
    } if
} def

/solve {
    /found false def
    /er -1 def
    /ec -1 def
    
    0 1 8 {
        /r exch def
        0 1 8 {
            /c exch def
            puzzle r 9 mul c add get 0 eq {
                /found true def
                /er r def
                /ec c def
                exit
            } if
        } for
        found { exit } if
    } for
    
    found not {
        print-puzzle
        (\nSolved in Iterations=) print count = (\n) print
        true
    } {
        false
        1 1 9 {
            /val exch def
            /count count 1 add def
            er ec val is-possible {
                puzzle er 9 mul ec add val put
                solve { pop true exit } if
                puzzle er 9 mul ec add 0 put
            } if
        } for
    } ifelse
} def

% Main
/args [ shellarguments { } if ] def

args {
    /arg exch def
    arg length 7 gt {
        arg arg length 7 sub 7 getinterval (.matrix) eq {
            arg read-matrix-file
            print-puzzle
            /count 0 def
            solve pop
        } if
    } if
} forall

quit
